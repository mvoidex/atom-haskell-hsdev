"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const Util = require("../util");
const hsdev_process_real_1 = require("./hsdev-process-real");
const hsdev_process_real_factory_1 = require("./hsdev-process-real-factory");
class HsDevProcess {
    constructor(upiPromise) {
        this.upiPromise = upiPromise;
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        this.bufferDirMap = new WeakMap();
        this.backend = this.startBackend();
    }
    async getRootDir(buffer) {
        let dir;
        dir = this.bufferDirMap.get(buffer);
        if (dir) {
            return dir;
        }
        dir = await Util.getRootDir(buffer);
        this.bufferDirMap.set(buffer, dir);
        return dir;
    }
    killProcess() {
        this.backend.killProcess();
    }
    destroy() {
        this.backend.destroy();
        this.emitter.emit('did-destroy');
        this.disposables.dispose();
    }
    onDidDestroy(callback) {
        return this.emitter.on('did-destroy', callback);
    }
    onWarning(callback) {
        return this.emitter.on('warning', callback);
    }
    onError(callback) {
        return this.emitter.on('error', callback);
    }
    onBackendActive(callback) {
        return this.emitter.on('backend-active', callback);
    }
    onBackendIdle(callback) {
        return this.emitter.on('backend-idle', callback);
    }
    onQueueIdle(callback) {
        return this.emitter.on('queue-idle', callback);
    }
    async whoat(buffer, crange) {
        const file = buffer.getUri();
        const line = crange.start.row + 1;
        const column = crange.start.column + 1;
        const symbols = await this.backend.whoat(file, line, column);
        if (symbols.length == 0) {
            Util.debug(`No info found for symbol at ${file} ${line} ${column}`);
            throw Error(`No info found for symbol at ${file} ${line} ${column}`);
        }
        else {
            const sym = symbols[0];
            const what = sym.info.what;
            const lines = [];
            switch (what) {
                case 'function':
                case 'method':
                case 'constructor':
                    lines.push(`${sym.id.name} :: ${sym.info.type ? sym.info.type : '?'}`);
                    break;
                case 'data':
                case 'type':
                case 'class':
                case 'newtype':
                    lines.push(`${what} ${sym.id.name}`);
                    break;
                default:
                    lines.push(`${sym.id.name}`);
            }
            if (sym.docs) {
                lines.push('', `{- ${sym.docs} -}`);
            }
            if (sym.id.module.location.file && sym.pos) {
                lines.push('', `-- Defined in ${sym.id.module.location.file}:${sym.pos.line}:${sym.pos.column}`);
            }
            return { range: crange, info: lines.join('\n') };
        }
    }
    async doPing() {
        this.backend.call('ping', undefined, {
            onResponse: (response) => {
                Util.debug(`response to ping: ${JSON.stringify(response)}`);
            }
        });
    }
    async getUPI() {
        return Promise.race([this.upiPromise, Promise.resolve(undefined)]);
    }
    startBackend() {
        const backend = new hsdev_process_real_1.HsDevProcessReal();
        backend.scanCabal({
            onNotify: async (_notification) => {
                const upi = await this.getUPI();
                if (upi) {
                    upi.setStatus({
                        status: 'progress',
                        detail: 'scanning global-db/user-db'
                    });
                }
            },
            onError: async (error, _details) => {
                const upi = await this.getUPI();
                if (upi) {
                    upi.setStatus({
                        status: 'error',
                        detail: `scanning global-db/user-db failed: ${error}`
                    });
                }
            },
            onResponse: async (_response) => {
                const upi = await this.getUPI();
                if (upi) {
                    upi.setStatus({
                        status: 'ready',
                        detail: 'scanned global-db/user-db'
                    });
                }
            }
        });
        return backend;
    }
    async initBackend() {
        if (!this.backend) {
            this.backend = await this.createBackend();
        }
        return this.backend;
    }
    async createBackend() {
        const backend = await hsdev_process_real_factory_1.createHsDevProcessReal();
        this.disposables.add(backend.onError((arg) => this.emitter.emit('error', arg)), backend.onWarning((arg) => this.emitter.emit('warning', arg)));
        return backend;
    }
}
exports.HsDevProcess = HsDevProcess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaHNkZXYvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFDK0M7QUFDL0MsZ0NBQStCO0FBTy9CLDZEQUFvRjtBQUNwRiw2RUFBcUU7QUFhckU7SUFjRSxZQUFvQixVQUFxQztRQUFyQyxlQUFVLEdBQVYsVUFBVSxDQUEyQjtRQUN2RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksY0FBTyxFQUFFLENBQUE7UUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2xDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUNqQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtJQUNwQyxDQUFDO0lBRU0sS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFrQjtRQUN4QyxJQUFJLEdBQUcsQ0FBQTtRQUNQLEdBQUcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNuQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ1IsTUFBTSxDQUFDLEdBQUcsQ0FBQTtRQUNaLENBQUM7UUFDRCxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ25DLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQTtRQUNsQyxNQUFNLENBQUMsR0FBRyxDQUFBO0lBQ1osQ0FBQztJQUVNLFdBQVc7UUFDaEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUM1QixDQUFDO0lBRU0sT0FBTztRQUNaLElBQUksQ0FB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QUFPO3dCQUNmLE1BQU0sRUFBRSwyQkFBMkI7cUJBQ3BDLENBQUMsQ0FBQTtnQkFDSixDQUFDO1lBQ0gsQ0FBQztTQUNGLENBQUMsQ0FBQTtRQUNGLE1BQU0sQ0FBQyxPQUFPLENBQUE7SUFDaEIsQ0FBQztJQUVPLEtBQUssQ0FBQyxXQUFXO1FBQ3ZCLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDbEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtRQUMzQyxDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUE7SUFDckIsQ0FBQztJQUVPLEtBQUssQ0FBQyxhQUFhO1FBQ3pCLE1BQU0sT0FBTyxHQUFHLE1BQU0sbURBQXNCLEVBQUUsQ0FBQTtRQUM5QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDbEIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQ3pELE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUM5RCxDQUFBO1FBQ0QsTUFBTSxDQUFDLE9BQU8sQ0FBQTtJQUNoQixDQUFDO0NBQ0Y7QUExS0Qsb0NBMEtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmFuZ2UsIFBvaW50LCBFbWl0dGVyLCBDb21wb3NpdGVEaXNwb3NhYmxlLFxyXG5UZXh0QnVmZmVyLCBEaXJlY3RvcnksIFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xyXG5pbXBvcnQgKiBhcyBVdGlsIGZyb20gJy4uL3V0aWwnXHJcbmltcG9ydCB7IGV4dG5hbWUgfSBmcm9tICdwYXRoJ1xyXG5pbXBvcnQgUXVldWUgPSByZXF1aXJlKCdwcm9taXNlLXF1ZXVlJylcclxuaW1wb3J0IHsgdW5saXQgfSBmcm9tICdhdG9tLWhhc2tlbGwtdXRpbHMnXHJcbmltcG9ydCAqIGFzIENvbXBsZXRpb25CYWNrZW5kIGZyb20gJ2F0b20taGFza2VsbC11cGkvY29tcGxldGlvbi1iYWNrZW5kJ1xyXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcclxuXHJcbmltcG9ydCB7IEhzRGV2UHJvY2Vzc1JlYWwsIFJ1bkFyZ3MsIElFcnJvckNhbGxiYWNrQXJncyB9IGZyb20gJy4vaHNkZXYtcHJvY2Vzcy1yZWFsJ1xyXG5pbXBvcnQgeyBjcmVhdGVIc0RldlByb2Nlc3NSZWFsIH0gZnJvbSAnLi9oc2Rldi1wcm9jZXNzLXJlYWwtZmFjdG9yeSdcclxuXHJcbmV4cG9ydCB7IElFcnJvckNhbGxiYWNrQXJncywgUnVuQXJncyB9XHJcblxyXG50eXBlIENvbW1hbmRzID0gJ2NoZWNrbGludCcgfCAnYnJvd3NlJyB8ICd0eXBlaW5mbycgfCAnZmluZCcgfCAnaW5pdCcgfCAnbGlzdCcgfCAnbG93bWVtJ1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTeW1ib2xEZXNjIHtcclxuICBuYW1lOiBzdHJpbmcsXHJcbiAgc3ltYm9sVHlwZTogQ29tcGxldGlvbkJhY2tlbmQuU3ltYm9sVHlwZSxcclxuICB0eXBlU2lnbmF0dXJlPzogc3RyaW5nLFxyXG4gIHBhcmVudD86IHN0cmluZ1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgSHNEZXZQcm9jZXNzIHtcclxuICBwdWJsaWMgYmFja2VuZDogSHNEZXZQcm9jZXNzUmVhbFxyXG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcclxuICBwcml2YXRlIGVtaXR0ZXI6IEVtaXR0ZXI8e1xyXG4gICAgJ2RpZC1kZXN0cm95JzogdW5kZWZpbmVkXHJcbiAgICAnYmFja2VuZC1hY3RpdmUnOiB1bmRlZmluZWRcclxuICAgICdiYWNrZW5kLWlkbGUnOiB1bmRlZmluZWRcclxuICB9LCB7XHJcbiAgICAnd2FybmluZyc6IHN0cmluZ1xyXG4gICAgJ2Vycm9yJzogSUVycm9yQ2FsbGJhY2tBcmdzXHJcbiAgICAncXVldWUtaWRsZSc6IHsgcXVldWU6IENvbW1hbmRzIH1cclxuICB9PlxyXG4gIHByaXZhdGUgYnVmZmVyRGlyTWFwOiBXZWFrTWFwPFRleHRCdWZmZXIsIERpcmVjdG9yeT5cclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSB1cGlQcm9taXNlOiBQcm9taXNlPFVQSS5JVVBJSW5zdGFuY2U+KSB7XHJcbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxyXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxyXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxyXG4gICAgdGhpcy5idWZmZXJEaXJNYXAgPSBuZXcgV2Vha01hcCgpXHJcbiAgICB0aGlzLmJhY2tlbmQgPSB0aGlzLnN0YXJ0QmFja2VuZCgpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZ2V0Um9vdERpcihidWZmZXI6IFRleHRCdWZmZXIpOiBQcm9taXNlPERpcmVjdG9yeT4ge1xyXG4gICAgbGV0IGRpclxyXG4gICAgZGlyID0gdGhpcy5idWZmZXJEaXJNYXAuZ2V0KGJ1ZmZlcilcclxuICAgIGlmIChkaXIpIHtcclxuICAgICAgcmV0dXJuIGRpclxyXG4gICAgfVxyXG4gICAgZGlyID0gYXdhaXQgVXRpbC5nZXRSb290RGlyKGJ1ZmZlcilcclxuICAgIHRoaXMuYnVmZmVyRGlyTWFwLnNldChidWZmZXIsIGRpcilcclxuICAgIHJldHVybiBkaXJcclxuICB9XHJcblxyXG4gIHB1YmxpYyBraWxsUHJvY2VzcygpIHtcclxuICAgIHRoaXMuYmFja2VuZC5raWxsUHJvY2VzcygpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZGVzdHJveSgpIHtcclxuICAgIHRoaXMuYmFja2VuZC5kZXN0cm95KClcclxuICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtZGVzdHJveScpXHJcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uRGlkRGVzdHJveShjYWxsYmFjazogKCkgPT4gdm9pZCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLWRlc3Ryb3knLCBjYWxsYmFjaylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvbldhcm5pbmcoY2FsbGJhY2s6ICh3YXJuaW5nOiBzdHJpbmcpID0+IHZvaWQpIHtcclxuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ3dhcm5pbmcnLCBjYWxsYmFjaylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvbkVycm9yKGNhbGxiYWNrOiAoZXJyb3I6IElFcnJvckNhbGxiYWNrQXJncykgPT4gdm9pZCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZXJyb3InLCBjYWxsYmFjaylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvbkJhY2tlbmRBY3RpdmUoY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcclxuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2JhY2tlbmQtYWN0aXZlJywgY2FsbGJhY2spXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25CYWNrZW5kSWRsZShjYWxsYmFjazogKCkgPT4gdm9pZCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignYmFja2VuZC1pZGxlJywgY2FsbGJhY2spXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25RdWV1ZUlkbGUoY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcclxuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ3F1ZXVlLWlkbGUnLCBjYWxsYmFjaylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyB3aG9hdChcclxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3JhbmdlOiBSYW5nZVxyXG4gICkge1xyXG4gICAgY29uc3QgZmlsZSA9IGJ1ZmZlci5nZXRVcmkoKVxyXG4gICAgY29uc3QgbGluZSA9IGNyYW5nZS5zdGFydC5yb3cgKyAxXHJcbiAgICBjb25zdCBjb2x1bW4gPSBjcmFuZ2Uuc3RhcnQuY29sdW1uICsgMVxyXG4gICAgY29uc3Qgc3ltYm9sczogYW55W10gPSBhd2FpdCB0aGlzLmJhY2tlbmQud2hvYXQoZmlsZSwgbGluZSwgY29sdW1uKVxyXG4gICAgaWYgKHN5bWJvbHMubGVuZ3RoID09IDApIHtcclxuICAgICAgVXRpbC5kZWJ1ZyhgTm8gaW5mbyBmb3VuZCBmb3Igc3ltYm9sIGF0ICR7ZmlsZX0gJHtsaW5lfSAke2NvbHVtbn1gKVxyXG4gICAgICB0aHJvdyBFcnJvcihgTm8gaW5mbyBmb3VuZCBmb3Igc3ltYm9sIGF0ICR7ZmlsZX0gJHtsaW5lfSAke2NvbHVtbn1gKVxyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGNvbnN0IHN5bSA9IHN5bWJvbHNbMF1cclxuICAgICAgY29uc3Qgd2hhdCA9IHN5bS5pbmZvLndoYXRcclxuICAgICAgY29uc3QgbGluZXMgPSBbXVxyXG4gICAgICBzd2l0Y2ggKHdoYXQpIHtcclxuICAgICAgICBjYXNlICdmdW5jdGlvbic6XHJcbiAgICAgICAgY2FzZSAnbWV0aG9kJzpcclxuICAgICAgICBjYXNlICdjb25zdHJ1Y3Rvcic6XHJcbiAgICAgICAgICBsaW5lcy5wdXNoKGAke3N5bS5pZC5uYW1lfSA6OiAke3N5bS5pbmZvLnR5cGUgPyBzeW0uaW5mby50eXBlIDogJz8nfWApXHJcbiAgICAgICAgICBicmVha1xyXG4gICAgICAgIGNhc2UgJ2RhdGEnOlxyXG4gICAgICAgIGNhc2UgJ3R5cGUnOlxyXG4gICAgICAgIGNhc2UgJ2NsYXNzJzpcclxuICAgICAgICBjYXNlICduZXd0eXBlJzpcclxuICAgICAgICAgIGxpbmVzLnB1c2goYCR7d2hhdH0gJHtzeW0uaWQubmFtZX1gKVxyXG4gICAgICAgICAgYnJlYWtcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgbGluZXMucHVzaChgJHtzeW0uaWQubmFtZX1gKVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoc3ltLmRvY3MpIHtcclxuICAgICAgICBsaW5lcy5wdXNoKCcnLCBgey0gJHtzeW0uZG9jc30gLX1gKVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoc3ltLmlkLm1vZHVsZS5sb2NhdGlvbi5maWxlICYmIHN5bS5wb3MpIHtcclxuICAgICAgICBsaW5lcy5wdXNoKCcnLCBgLS0gRGVmaW5lZCBpbiAke3N5bS5pZC5tb2R1bGUubG9jYXRpb24uZmlsZX06JHtzeW0ucG9zLmxpbmV9OiR7c3ltLnBvcy5jb2x1bW59YClcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4ge3JhbmdlOiBjcmFuZ2UsIGluZm86IGxpbmVzLmpvaW4oJ1xcbicpfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGRvUGluZygpIHtcclxuICAgIHRoaXMuYmFja2VuZC5jYWxsKCdwaW5nJywgdW5kZWZpbmVkLCB7XHJcbiAgICAgIG9uUmVzcG9uc2U6IChyZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgVXRpbC5kZWJ1ZyhgcmVzcG9uc2UgdG8gcGluZzogJHtKU09OLnN0cmluZ2lmeShyZXNwb25zZSl9YClcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgZ2V0VVBJKCkge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmFjZShbdGhpcy51cGlQcm9taXNlLCBQcm9taXNlLnJlc29sdmUodW5kZWZpbmVkKV0pXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHN0YXJ0QmFja2VuZCgpOiBIc0RldlByb2Nlc3NSZWFsIHtcclxuICAgIGNvbnN0IGJhY2tlbmQgPSBuZXcgSHNEZXZQcm9jZXNzUmVhbCgpXHJcbiAgICBiYWNrZW5kLnNjYW5DYWJhbCh7XHJcbiAgICAgIG9uTm90aWZ5OiBhc3luYyAoX25vdGlmaWNhdGlvbjogYW55KSA9PiB7XHJcbiAgICAgICAgY29uc3QgdXBpID0gYXdhaXQgdGhpcy5nZXRVUEkoKVxyXG4gICAgICAgIGlmICh1cGkpIHtcclxuICAgICAgICAgIHVwaS5zZXRTdGF0dXMoe1xyXG4gICAgICAgICAgICBzdGF0dXM6ICdwcm9ncmVzcycsXHJcbiAgICAgICAgICAgIGRldGFpbDogJ3NjYW5uaW5nIGdsb2JhbC1kYi91c2VyLWRiJ1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIG9uRXJyb3I6IGFzeW5jIChlcnJvcjogc3RyaW5nLCBfZGV0YWlsczogYW55KSA9PiB7XHJcbiAgICAgICAgY29uc3QgdXBpID0gYXdhaXQgdGhpcy5nZXRVUEkoKVxyXG4gICAgICAgIGlmICh1cGkpIHtcclxuICAgICAgICAgIHVwaS5zZXRTdGF0dXMoe1xyXG4gICAgICAgICAgICBzdGF0dXM6ICdlcnJvcicsXHJcbiAgICAgICAgICAgIGRldGFpbDogYHNjYW5uaW5nIGdsb2JhbC1kYi91c2VyLWRiIGZhaWxlZDogJHtlcnJvcn1gXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgb25SZXNwb25zZTogYXN5bmMgKF9yZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgY29uc3QgdXBpID0gYXdhaXQgdGhpcy5nZXRVUEkoKVxyXG4gICAgICAgIGlmICh1cGkpIHtcclxuICAgICAgICAgIHVwaS5zZXRTdGF0dXMoe1xyXG4gICAgICAgICAgICBzdGF0dXM6ICdyZWFkeScsXHJcbiAgICAgICAgICAgIGRldGFpbDogJ3NjYW5uZWQgZ2xvYmFsLWRiL3VzZXItZGInXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIHJldHVybiBiYWNrZW5kXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIGluaXRCYWNrZW5kKCk6IFByb21pc2U8SHNEZXZQcm9jZXNzUmVhbD4ge1xyXG4gICAgaWYgKCF0aGlzLmJhY2tlbmQpIHtcclxuICAgICAgdGhpcy5iYWNrZW5kID0gYXdhaXQgdGhpcy5jcmVhdGVCYWNrZW5kKClcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmJhY2tlbmRcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlQmFja2VuZCgpOiBQcm9taXNlPEhzRGV2UHJvY2Vzc1JlYWw+IHtcclxuICAgIGNvbnN0IGJhY2tlbmQgPSBhd2FpdCBjcmVhdGVIc0RldlByb2Nlc3NSZWFsKClcclxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxyXG4gICAgICBiYWNrZW5kLm9uRXJyb3IoKGFyZykgPT4gdGhpcy5lbWl0dGVyLmVtaXQoJ2Vycm9yJywgYXJnKSksXHJcbiAgICAgIGJhY2tlbmQub25XYXJuaW5nKChhcmcpID0+IHRoaXMuZW1pdHRlci5lbWl0KCd3YXJuaW5nJywgYXJnKSksXHJcbiAgICApXHJcbiAgICByZXR1cm4gYmFja2VuZFxyXG4gIH1cclxufVxyXG4iXX0=