"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const CP = require("child_process");
const os_1 = require("os");
const Util = require("../util");
async function buildStack(opts, upi) {
    const messages = [];
    const disp = new atom_1.CompositeDisposable();
    try {
        const vers = await Util.execPromise('stack', ['--numeric-version'], opts)
            .then(({ stdout }) => stdout.split('.').map(n => parseInt(n, 10)))
            .catch(() => undefined);
        const hasCopyCompiler = vers ? Util.versAtLeast(vers, [1, 6, 1]) : false;
        return await new Promise((resolve, reject) => {
            const args = ['build'];
            if (hasCopyCompiler)
                args.push('--copy-compiler-tool');
            args.push('hsdev');
            Util.warn(`Running stack ${args.join(' ')}`);
            const proc = CP.spawn('stack', args, opts);
            const buffered = () => {
                let buffer = '';
                return (data) => {
                    const output = data.toString('utf8');
                    const [first, ...tail] = output.split(os_1.EOL);
                    buffer += first;
                    if (tail.length > 0) {
                        const lines = [buffer, ...(tail.slice(0, -1))];
                        buffer = tail.slice(-1)[0];
                        messages.push(...lines.map(message => ({ message, severity: 'build' })));
                        if (upi) {
                            upi.setMessages(messages);
                        }
                        else {
                            atom.notifications.addInfo(lines.join('\n'));
                        }
                        console.log(lines.join('\n'));
                    }
                };
            };
            proc.stdout.on('data', buffered());
            proc.stderr.on('data', buffered());
            if (upi) {
                disp.add(upi.addPanelControl({
                    element: 'ide-haskell-button',
                    opts: {
                        classes: ['cancel'],
                        events: {
                            click: () => {
                                proc.kill('SIGTERM');
                                proc.kill('SIGKILL');
                            },
                        },
                    },
                }));
            }
            proc.once('exit', (code, signal) => {
                if (code === 0) {
                    resolve(true);
                }
                else {
                    reject(new Error(`Stack build exited with nonzero exit status ${code} due to ${signal}`));
                    Util.warn(messages.map(m => m.message).join('\n'));
                }
            });
        });
    }
    catch (e) {
        Util.warn(e);
        atom.notifications.addError(e.toString(), {
            dismissable: true,
            detail: messages.map(m => m.message).join('\n'),
        });
        return false;
    }
    finally {
        upi && upi.setMessages([]);
        disp.dispose();
    }
}
exports.buildStack = buildStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGQtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaHNkZXYvYnVpbGQtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBMEM7QUFFMUMsb0NBQW1DO0FBQ25DLDJCQUF3QjtBQUN4QixnQ0FBK0I7QUFHeEIsS0FBSyxxQkFBcUIsSUFBZ0IsRUFBRSxHQUE2QjtJQUM5RSxNQUFNLFFBQVEsR0FBa0IsRUFBRSxDQUFBO0lBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUN0QyxJQUFJLENBQUM7UUFDSCxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUMsbUJBQW1CLENBQUMsRUFBRSxJQUFJLENBQUM7YUFDdEUsSUFBSSxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDakUsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3pCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQTtRQUN0RSxNQUFNLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBVSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNwRCxNQUFNLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ3RCLEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQztnQkFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFD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QztvQkFDTixNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsK0NBQStDLElBQUksV0FBVyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUE7b0JBQ3pGLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtnQkFDcEQsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNYLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDWixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDeEMsV0FBVyxFQUFFLElBQUk7WUFDakIsTUFBTSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztTQUNoRCxDQUFDLENBQUE7UUFDRixNQUFNLENBQUMsS0FBSyxDQUFBO0lBQ2QsQ0FBQztZQUFTLENBQUM7UUFDVCxHQUFHLElBQUksR0FBRyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUMxQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDaEIsQ0FBQztBQUNILENBQUM7QUFyRUQsZ0NBcUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXHJcbmltcG9ydCB7IElVUElJbnN0YW5jZSwgSVJlc3VsdEl0ZW0gfSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xyXG5pbXBvcnQgKiBhcyBDUCBmcm9tICdjaGlsZF9wcm9jZXNzJ1xyXG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcydcclxuaW1wb3J0ICogYXMgVXRpbCBmcm9tICcuLi91dGlsJ1xyXG5pbXBvcnQgeyBSdW5PcHRpb25zIH0gZnJvbSAnLi9oc2Rldi1wcm9jZXNzLXJlYWwnXHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYnVpbGRTdGFjayhvcHRzOiBSdW5PcHRpb25zLCB1cGk6IElVUElJbnN0YW5jZSB8IHVuZGVmaW5lZCk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gIGNvbnN0IG1lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdID0gW11cclxuICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB2ZXJzID0gYXdhaXQgVXRpbC5leGVjUHJvbWlzZSgnc3RhY2snLCBbJy0tbnVtZXJpYy12ZXJzaW9uJ10sIG9wdHMpXHJcbiAgICAgIC50aGVuKCh7IHN0ZG91dCB9KSA9PiBzdGRvdXQuc3BsaXQoJy4nKS5tYXAobiA9PiBwYXJzZUludChuLCAxMCkpKVxyXG4gICAgICAuY2F0Y2goKCkgPT4gdW5kZWZpbmVkKVxyXG4gICAgY29uc3QgaGFzQ29weUNvbXBpbGVyID0gdmVycyA/IFV0aWwudmVyc0F0TGVhc3QodmVycywgWzEsNiwxXSkgOiBmYWxzZVxyXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgY29uc3QgYXJncyA9IFsnYnVpbGQnXVxyXG4gICAgICBpZiAoaGFzQ29weUNvbXBpbGVyKSBhcmdzLnB1c2goJy0tY29weS1jb21waWxlci10b29sJylcclxuICAgICAgYXJncy5wdXNoKCdoc2RldicpXHJcbiAgICAgIFV0aWwud2FybihgUnVubmluZyBzdGFjayAke2FyZ3Muam9pbignICcpfWApXHJcbiAgICAgIGNvbnN0IHByb2MgPSBDUC5zcGF3bignc3RhY2snLCBhcmdzLCBvcHRzKVxyXG4gICAgICBjb25zdCBidWZmZXJlZCA9ICgpID0+IHtcclxuICAgICAgICBsZXQgYnVmZmVyID0gJydcclxuICAgICAgICByZXR1cm4gKGRhdGE6IEJ1ZmZlcikgPT4ge1xyXG4gICAgICAgICAgY29uc3Qgb3V0cHV0ID0gZGF0YS50b1N0cmluZygndXRmOCcpXHJcbiAgICAgICAgICBjb25zdCBbZmlyc3QsIC4uLnRhaWxdID0gb3V0cHV0LnNwbGl0KEVPTClcclxuICAgICAgICAgIGJ1ZmZlciArPSBmaXJzdFxyXG4gICAgICAgICAgaWYgKHRhaWwubGVuZ3RoID4gMCkgeyAvLyBpdCBtZWFucyB0aGVyZSdzIGF0IGxlYXN0IG9uZSBuZXdsaW5lXHJcbiAgICAgICAgICAgIGNvbnN0IGxpbmVzID0gW2J1ZmZlciwgLi4uKHRhaWwuc2xpY2UoMCwgLTEpKV1cclxuICAgICAgICAgICAgYnVmZmVyID0gdGFpbC5zbGljZSgtMSlbMF1cclxuICAgICAgICAgICAgbWVzc2FnZXMucHVzaCguLi5saW5lcy5tYXAobWVzc2FnZSA9PiAoeyBtZXNzYWdlLCBzZXZlcml0eTogJ2J1aWxkJyB9KSkpXHJcbiAgICAgICAgICAgIGlmICh1cGkpIHtcclxuICAgICAgICAgICAgICB1cGkuc2V0TWVzc2FnZXMobWVzc2FnZXMpXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8obGluZXMuam9pbignXFxuJykpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc29sZS5sb2cobGluZXMuam9pbignXFxuJykpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHByb2Muc3Rkb3V0Lm9uKCdkYXRhJywgYnVmZmVyZWQoKSlcclxuICAgICAgcHJvYy5zdGRlcnIub24oJ2RhdGEnLCBidWZmZXJlZCgpKVxyXG4gICAgICBpZiAodXBpKSB7XHJcbiAgICAgICAgZGlzcC5hZGQodXBpLmFkZFBhbmVsQ29udHJvbCh7XHJcbiAgICAgICAgICBlbGVtZW50OiAnaWRlLWhhc2tlbGwtYnV0dG9uJyxcclxuICAgICAgICAgIG9wdHM6IHtcclxuICAgICAgICAgICAgY2xhc3NlczogWydjYW5jZWwnXSxcclxuICAgICAgICAgICAgZXZlbnRzOiB7XHJcbiAgICAgICAgICAgICAgY2xpY2s6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHByb2Mua2lsbCgnU0lHVEVSTScpXHJcbiAgICAgICAgICAgICAgICBwcm9jLmtpbGwoJ1NJR0tJTEwnKVxyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0pKVxyXG4gICAgICB9XHJcbiAgICAgIHByb2Mub25jZSgnZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcclxuICAgICAgICBpZiAoY29kZSA9PT0gMCkge1xyXG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBTdGFjayBidWlsZCBleGl0ZWQgd2l0aCBub256ZXJvIGV4aXQgc3RhdHVzICR7Y29kZX0gZHVlIHRvICR7c2lnbmFsfWApKVxyXG4gICAgICAgICAgVXRpbC53YXJuKG1lc3NhZ2VzLm1hcChtID0+IG0ubWVzc2FnZSkuam9pbignXFxuJykpXHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgfSlcclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICBVdGlsLndhcm4oZSlcclxuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlLnRvU3RyaW5nKCksIHtcclxuICAgICAgZGlzbWlzc2FibGU6IHRydWUsXHJcbiAgICAgIGRldGFpbDogbWVzc2FnZXMubWFwKG0gPT4gbS5tZXNzYWdlKS5qb2luKCdcXG4nKSxcclxuICAgIH0pXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9IGZpbmFsbHkge1xyXG4gICAgdXBpICYmIHVwaS5zZXRNZXNzYWdlcyhbXSlcclxuICAgIGRpc3AuZGlzcG9zZSgpXHJcbiAgfVxyXG59XHJcbiJdfQ==