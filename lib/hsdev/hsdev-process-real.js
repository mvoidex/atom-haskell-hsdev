"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const interactive_process_1 = require("./interactive-process");
const Util = require("../util");
const { debug, withTempFile, EOT } = Util;
const net = require("net");
class HsDevProcessReal {
    constructor(options = {}) {
        this.options = options;
        this.buffer = '';
        this.id = 0;
        this.callbacks = {};
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
    }
    async run(runArgs) {
        const { command } = runArgs;
        try {
            this.call(command);
        }
        catch (err) {
            debug(err);
            this.emitter.emit('error', { runArgs, err });
        }
    }
    killProcess() {
        debug(`Killing hsdev process`);
        this.proc && this.proc.kill();
    }
    destroy() {
        debug('HsDevProcessBase destroying');
        this.killProcess();
        this.emitter.emit('did-destroy');
        this.disposables.dispose();
    }
    onDidDestroy(callback) {
        return this.emitter.on('did-destroy', callback);
    }
    onWarning(callback) {
        return this.emitter.on('warning', callback);
    }
    onError(callback) {
        return this.emitter.on('error', callback);
    }
    async startServer() {
        debug(`Checking for hsdev`);
        if (this.proc) {
            debug(`Found running hsdev instance`);
            return this.proc;
        }
        debug(`Spawning new hsdev instance for with`, this.options);
        const modPath = atom.config.get('atom-haskell-hsdev.hsdevPath');
        const dbPath = atom.config.get('atom-haskell-hsdev.hsdevDb');
        const runOpts = [];
        runOpts.push('run');
        if (this.options.port) {
            runOpts.push('--port', this.options.port.toString());
        }
        if (this.options.db) {
            runOpts.push('--db', this.options.db);
        }
        else if (dbPath) {
            runOpts.push('--db', dbPath);
        }
        if (this.options.logFile) {
            runOpts.push('--log', this.options.logFile);
        }
        if (this.options.logLevel) {
            runOpts.push('--log-level', this.options.logLevel);
        }
        this.proc = new interactive_process_1.InteractiveProcess(modPath, runOpts);
        this.proc.onceExit((code) => {
            debug(`hsdev ended with ${code}`);
            this.proc = undefined;
        });
        const { stdout } = await this.proc.readLine();
        debug(`Received line: ${stdout[0]}`);
        const started = /Server started at port (.*)$/.exec(stdout[0]);
        if (started) {
            debug('Started hsdev');
            return this.proc;
        }
        return;
    }
    async connectHsDev() {
        if (this.sock) {
            return this.sock;
        }
        this.id = 0;
        this.sock = new net.Socket();
        this.sock.setEncoding('utf-8');
        this.sock.on('data', (data) => {
            const lines = data.split('\n');
            if (lines.length == 1) {
                this.buffer = this.buffer + (lines.pop() || '');
            }
            else {
                lines[0] = this.buffer + lines[0];
                this.buffer = lines.pop() || '';
            }
            for (const line of lines) {
                debug(`received response: ${line}`);
                const resp = JSON.parse(line);
                const id = resp['id'];
                if (id) {
                    if (this.callbacks[id]) {
                        const { onError, onNotify, onResponse } = this.callbacks[id];
                        if (resp['error'] && onError) {
                            onError(resp['error'], resp);
                            delete this.callbacks[id];
                        }
                        else if (resp['notify'] && onNotify) {
                            onNotify(resp['notify']);
                        }
                        else if (resp['result'] && onResponse) {
                            onResponse(resp['result']);
                            delete this.callbacks[id];
                        }
                    }
                }
            }
        });
        this.sock.connect({ port: 4567 });
        return this.sock;
    }
    async initProcess() {
        const proc = await this.startServer();
        if (!proc) {
            throw 'Error spawning process';
        }
        return this.connectHsDev();
    }
    async call(command, opts = {}, callbacks) {
        debug(`Running hsdev command ${command} with opts: ${opts}`);
        const sock = await this.initProcess();
        if (!sock) {
            throw ('Error getting socket');
        }
        let cmd = opts;
        const id = this.id.toString();
        ++this.id;
        opts['command'] = command;
        opts['no-file'] = true;
        opts['id'] = id;
        return await new Promise((resolve, reject) => {
            const calls = {
                onError: (error, details) => {
                    reject(`Error returned: ${error}`);
                    if (callbacks && callbacks.onError) {
                        callbacks.onError(error, details);
                    }
                },
                onNotify: callbacks ? callbacks.onNotify : undefined,
                onResponse: (response) => {
                    resolve(response);
                    if (callbacks && callbacks.onResponse) {
                        callbacks.onResponse(response);
                    }
                }
            };
            this.callbacks[id] = calls;
            debug(`Sending command: ${JSON.stringify(cmd)}`);
            sock.write(JSON.stringify(cmd) + '\n');
        });
    }
    async ping(callbacks) {
        return await this.call('ping', {}, callbacks);
    }
    async whoat(file, line, column, callbacks) {
        return await this.call('whoat', { 'file': file, 'line': line, 'column': column }, callbacks);
    }
    async whois(file, name, callbacks) {
        return await this.call('whois', { 'file': file, 'name': name }, callbacks);
    }
    async lookup(file, name, callbacks) {
        return await this.call('lookup', { 'file': file, 'name': name }, callbacks);
    }
    async symbol(opts = {
        query: '',
        searchType: 'prefix',
        installed: false,
        sourced: false,
        standalone: false,
        localNames: false,
        header: false
    }, callbacks) {
        const params = {
            'input': opts.query,
            'type': opts.searchType,
            'locals': opts.localNames,
            'header': opts.header,
        };
        const filters = [];
        if (opts.project) {
            filters.push({ 'project': opts.project });
        }
        if (opts.file) {
            filters.push({ 'file': opts.file });
        }
        if (opts.module) {
            filters.push({ 'module': opts.module });
        }
        if (opts.package) {
            filters.push({ 'package': opts.package });
        }
        if (opts.installed) {
            filters.push('installed');
        }
        if (opts.sourced) {
            filters.push('sourced');
        }
        if (opts.standalone) {
            filters.push('standalone');
        }
        params['filters'] = filters;
        return await this.call('symbol', params, callbacks);
    }
    async infer(files, callbacks) {
        return await this.call('infer', { 'projects': [], 'files': files }, callbacks);
    }
    async scanFile(file, callbacks) {
        return await this.call('scan', { 'files': [{ 'file': file, 'contents': null }] }, callbacks);
    }
    async scanCabal(callbacks) {
        return await this.call('scan', { 'cabal': true }, callbacks);
    }
}
exports.HsDevProcessReal = HsDevProcessReal;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHNkZXYtcHJvY2Vzcy1yZWFsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2hzZGV2L2hzZGV2LXByb2Nlc3MtcmVhbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE4RDtBQUM5RCwrREFBMEQ7QUFDMUQsZ0NBQStCO0FBQy9CLE1BQU0sRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQTtBQUV6QywyQkFBMEI7QUFrQzFCO0lBY0UsWUFDVSxVQUFzQixFQUFFO1FBQXhCLFlBQU8sR0FBUCxPQUFPLENBQWlCO1FBTDFCLFdBQU0sR0FBVyxFQUFFLENBQUE7UUFDbkIsT0FBRSxHQUFXLENBQUMsQ0FBQTtRQUNkLGNBQVMsR0FBOEIsRUFBRSxDQUFBO1FBSy9DLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQzVDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxjQUFPLEVBQUUsQ0FBQTtRQUM1QixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUVNLEtBQUssQ0FBQyxHQUFHLENBQ2QsT0FBZ0I7UUFFaEIsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQTtRQUUzQixJQUFJLENBQUM7WUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ3BCLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2IsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBRVYsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUE7UUFDOUMsQ0FBQztJQUNILENBQUM7SUFFTSxXQUFXO1FBQ2hCLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFB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b250ZW50IjpbImltcG9ydCB7IERpcmVjdG9yeSwgRW1pdHRlciwgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXHJcbmltcG9ydCB7IEludGVyYWN0aXZlUHJvY2VzcyB9IGZyb20gJy4vaW50ZXJhY3RpdmUtcHJvY2VzcydcclxuaW1wb3J0ICogYXMgVXRpbCBmcm9tICcuLi91dGlsJ1xyXG5jb25zdCB7IGRlYnVnLCB3aXRoVGVtcEZpbGUsIEVPVCB9ID0gVXRpbFxyXG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcydcclxuaW1wb3J0ICogYXMgbmV0IGZyb20gJ25ldCdcclxuaW1wb3J0ICogYXMgXyBmcm9tICd1bmRlcnNjb3JlJ1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSdW5BcmdzIHtcclxuICBpbnRlcmFjdGl2ZT86IGJvb2xlYW5cclxuICBjb21tYW5kOiBzdHJpbmdcclxuICB0ZXh0Pzogc3RyaW5nXHJcbiAgdXJpPzogc3RyaW5nXHJcbiAgZGFzaEFyZ3M/OiBzdHJpbmdbXVxyXG4gIGFyZ3M/OiBzdHJpbmdbXVxyXG4gIHN1cHByZXNzRXJyb3JzPzogYm9vbGVhblxyXG4gIGdoY09wdGlvbnM/OiBzdHJpbmdbXVxyXG4gIGdoY01vZE9wdGlvbnM/OiBzdHJpbmdbXVxyXG4gIGJ1aWxkZXI6IHN0cmluZyB8IHVuZGVmaW5lZFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFJ1bk9wdGlvbnMge1xyXG4gIHBvcnQ/OiBudW1iZXJcclxuICBkYj86IHN0cmluZ1xyXG4gIGxvZ0ZpbGU/OiBzdHJpbmdcclxuICBsb2dMZXZlbD86ICd0cmFjZScgfCAnZGVidWcnIHwgJ2luZm8nIHwgJ3dhcm5pbmcnIHwgJ2Vycm9yJyB8ICdmYXRhbCdcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJRXJyb3JDYWxsYmFja0FyZ3Mge1xyXG4gIHJ1bkFyZ3M/OiBSdW5BcmdzXHJcbiAgZXJyOiBFcnJvclxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIENhbGxiYWNrcyB7XHJcbiAgb25FcnJvcj86IChlcnJvcjogc3RyaW5nLCBkZXRhaWxzOiBhbnkpID0+IHZvaWRcclxuICBvbk5vdGlmeT86IChub3RpZmljYXRpb246IGFueSkgPT4gdm9pZFxyXG4gIG9uUmVzcG9uc2U/OiAocmVzcG9uc2U6IGFueSkgPT4gdm9pZFxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgSHNEZXZQcm9jZXNzUmVhbCB7XHJcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxyXG4gIHByaXZhdGUgZW1pdHRlcjogRW1pdHRlcjx7XHJcbiAgICAnZGlkLWRlc3Ryb3knOiB2b2lkXHJcbiAgfSx7XHJcbiAgICAnd2FybmluZyc6IHN0cmluZ1xyXG4gICAgJ2Vycm9yJzogSUVycm9yQ2FsbGJhY2tBcmdzXHJcbiAgfT5cclxuICBwcml2YXRlIHByb2M6IEludGVyYWN0aXZlUHJvY2VzcyB8IHVuZGVmaW5lZFxyXG4gIHByaXZhdGUgc29jazogbmV0LlNvY2tldCB8IHVuZGVmaW5lZFxyXG4gIHByaXZhdGUgYnVmZmVyOiBzdHJpbmcgPSAnJ1xyXG4gIHByaXZhdGUgaWQ6IG51bWJlciA9IDBcclxuICBwcml2YXRlIGNhbGxiYWNrczoge1tpZDogc3RyaW5nXTogQ2FsbGJhY2tzfSA9IHt9XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBSdW5PcHRpb25zID0ge30sXHJcbiAgKSB7XHJcbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxyXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxyXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHJ1bihcclxuICAgIHJ1bkFyZ3M6IFJ1bkFyZ3MsXHJcbiAgKSB7XHJcbiAgICBjb25zdCB7IGNvbW1hbmQgfSA9IHJ1bkFyZ3NcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICB0aGlzLmNhbGwoY29tbWFuZClcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBkZWJ1ZyhlcnIpXHJcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tdW5zYWZlLWFueVxyXG4gICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZXJyb3InLCB7IHJ1bkFyZ3MsIGVyciB9KVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGtpbGxQcm9jZXNzKCkge1xyXG4gICAgZGVidWcoYEtpbGxpbmcgaHNkZXYgcHJvY2Vzc2ApXHJcbiAgICB0aGlzLnByb2MgJiYgdGhpcy5wcm9jLmtpbGwoKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGRlc3Ryb3koKSB7XHJcbiAgICBkZWJ1ZygnSHNEZXZQcm9jZXNzQmFzZSBkZXN0cm95aW5nJylcclxuICAgIHRoaXMua2lsbFByb2Nlc3MoKVxyXG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1kZXN0cm95JylcclxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25EaWREZXN0cm95KGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XHJcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtZGVzdHJveScsIGNhbGxiYWNrKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uV2FybmluZyhjYWxsYmFjazogKHdhcm5pbmc6IHN0cmluZykgPT4gdm9pZCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignd2FybmluZycsIGNhbGxiYWNrKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uRXJyb3IoY2FsbGJhY2s6IChlcnJvcjogSUVycm9yQ2FsbGJhY2tBcmdzKSA9PiB2b2lkKSB7XHJcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdlcnJvcicsIGNhbGxiYWNrKVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBzdGFydFNlcnZlcigpOiBQcm9taXNlPEludGVyYWN0aXZlUHJvY2VzcyB8IHVuZGVmaW5lZD4ge1xyXG4gICAgZGVidWcoYENoZWNraW5nIGZvciBoc2RldmApXHJcbiAgICBpZiAodGhpcy5wcm9jKSB7XHJcbiAgICAgIGRlYnVnKGBGb3VuZCBydW5uaW5nIGhzZGV2IGluc3RhbmNlYClcclxuICAgICAgcmV0dXJuIHRoaXMucHJvY1xyXG4gICAgfVxyXG4gICAgZGVidWcoYFNwYXduaW5nIG5ldyBoc2RldiBpbnN0YW5jZSBmb3Igd2l0aGAsIHRoaXMub3B0aW9ucylcclxuICAgIGNvbnN0IG1vZFBhdGggPSBhdG9tLmNvbmZpZy5nZXQoJ2F0b20taGFza2VsbC1oc2Rldi5oc2RldlBhdGgnKVxyXG4gICAgY29uc3QgZGJQYXRoID0gYXRvbS5jb25maWcuZ2V0KCdhdG9tLWhhc2tlbGwtaHNkZXYuaHNkZXZEYicpXHJcbiAgICBjb25zdCBydW5PcHRzOiBzdHJpbmdbXSA9IFtdXHJcbiAgICBydW5PcHRzLnB1c2goJ3J1bicpXHJcbiAgICBpZiAodGhpcy5vcHRpb25zLnBvcnQpIHtcclxuICAgICAgcnVuT3B0cy5wdXNoKCctLXBvcnQnLCB0aGlzLm9wdGlvbnMucG9ydC50b1N0cmluZygpKVxyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMub3B0aW9ucy5kYikge1xyXG4gICAgICBydW5PcHRzLnB1c2goJy0tZGInLCB0aGlzLm9wdGlvbnMuZGIpXHJcbiAgICB9XHJcbiAgICBlbHNlIGlmIChkYlBhdGgpIHtcclxuICAgICAgcnVuT3B0cy5wdXNoKCctLWRiJywgZGJQYXRoKVxyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMub3B0aW9ucy5sb2dGaWxlKSB7XHJcbiAgICAgIHJ1bk9wdHMucHVzaCgnLS1sb2cnLCB0aGlzLm9wdGlvbnMubG9nRmlsZSlcclxuICAgIH1cclxuICAgIGlmICh0aGlzLm9wdGlvbnMubG9nTGV2ZWwpIHtcclxuICAgICAgcnVuT3B0cy5wdXNoKCctLWxvZy1sZXZlbCcsIHRoaXMub3B0aW9ucy5sb2dMZXZlbClcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnByb2MgPSBuZXcgSW50ZXJhY3RpdmVQcm9jZXNzKG1vZFBhdGgsIHJ1bk9wdHMpXHJcbiAgICB0aGlzLnByb2Mub25jZUV4aXQoKGNvZGUpID0+IHtcclxuICAgICAgZGVidWcoYGhzZGV2IGVuZGVkIHdpdGggJHtjb2RlfWApXHJcbiAgICAgIHRoaXMucHJvYyA9IHVuZGVmaW5lZFxyXG4gICAgfSlcclxuICAgIGNvbnN0IHsgc3Rkb3V0IH0gPSBhd2FpdCB0aGlzLnByb2MucmVhZExpbmUoKVxyXG4gICAgZGVidWcoYFJlY2VpdmVkIGxpbmU6ICR7c3Rkb3V0WzBdfWApXHJcbiAgICBjb25zdCBzdGFydGVkID0gL1NlcnZlciBzdGFydGVkIGF0IHBvcnQgKC4qKSQvLmV4ZWMoc3Rkb3V0WzBdKVxyXG4gICAgaWYgKHN0YXJ0ZWQpIHtcclxuICAgICAgZGVidWcoJ1N0YXJ0ZWQgaHNkZXYnKVxyXG4gICAgICByZXR1cm4gdGhpcy5wcm9jXHJcbiAgICB9XHJcbiAgICByZXR1cm5cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBjb25uZWN0SHNEZXYoKTogUHJvbWlzZTxuZXQuU29ja2V0IHwgdW5kZWZpbmVkPiB7XHJcbiAgICBpZiAodGhpcy5zb2NrKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnNvY2tcclxuICAgIH1cclxuICAgIHRoaXMuaWQgPSAwXHJcbiAgICB0aGlzLnNvY2sgPSBuZXcgbmV0LlNvY2tldCgpXHJcbiAgICB0aGlzLnNvY2suc2V0RW5jb2RpbmcoJ3V0Zi04JylcclxuICAgIHRoaXMuc29jay5vbignZGF0YScsIChkYXRhOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbGluZXMgPSBkYXRhLnNwbGl0KCdcXG4nKVxyXG4gICAgICBpZiAobGluZXMubGVuZ3RoID09IDEpIHtcclxuICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyICsgKGxpbmVzLnBvcCgpIHx8ICcnKVxyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIGxpbmVzWzBdID0gdGhpcy5idWZmZXIgKyBsaW5lc1swXVxyXG4gICAgICAgIHRoaXMuYnVmZmVyID0gbGluZXMucG9wKCkgfHwgJydcclxuICAgICAgfVxyXG4gICAgICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcclxuICAgICAgICBkZWJ1ZyhgcmVjZWl2ZWQgcmVzcG9uc2U6ICR7bGluZX1gKVxyXG4gICAgICAgIGNvbnN0IHJlc3AgPSBKU09OLnBhcnNlKGxpbmUpXHJcbiAgICAgICAgY29uc3QgaWQgPSByZXNwWydpZCddXHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICBpZiAodGhpcy5jYWxsYmFja3NbaWRdKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgb25FcnJvciwgb25Ob3RpZnksIG9uUmVzcG9uc2UgfSA9IHRoaXMuY2FsbGJhY2tzW2lkXVxyXG4gICAgICAgICAgICBpZiAocmVzcFsnZXJyb3InXSAmJiBvbkVycm9yKSB7XHJcbiAgICAgICAgICAgICAgb25FcnJvcihyZXNwWydlcnJvciddLCByZXNwKVxyXG4gICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbGxiYWNrc1tpZF1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChyZXNwWydub3RpZnknXSAmJiBvbk5vdGlmeSkge1xyXG4gICAgICAgICAgICAgIG9uTm90aWZ5KHJlc3BbJ25vdGlmeSddKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHJlc3BbJ3Jlc3VsdCddICYmIG9uUmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICBvblJlc3BvbnNlKHJlc3BbJ3Jlc3VsdCddKVxyXG4gICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbGxiYWNrc1tpZF1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIHRoaXMuc29jay5jb25uZWN0KHtwb3J0OiA0NTY3fSlcclxuICAgIHJldHVybiB0aGlzLnNvY2tcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBpbml0UHJvY2VzcygpOiBQcm9taXNlPG5ldC5Tb2NrZXQgfCB1bmRlZmluZWQ+IHtcclxuICAgIGNvbnN0IHByb2MgPSBhd2FpdCB0aGlzLnN0YXJ0U2VydmVyKClcclxuICAgIGlmICghcHJvYykge1xyXG4gICAgICB0aHJvdyAnRXJyb3Igc3Bhd25pbmcgcHJvY2VzcydcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmNvbm5lY3RIc0RldigpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgY2FsbChcclxuICAgIGNvbW1hbmQ6IHN0cmluZyxcclxuICAgIG9wdHM6IHtbbmFtZTogc3RyaW5nXTogYW55fSA9IHt9LFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIGRlYnVnKGBSdW5uaW5nIGhzZGV2IGNvbW1hbmQgJHtjb21tYW5kfSB3aXRoIG9wdHM6ICR7b3B0c31gKVxyXG4gICAgY29uc3Qgc29jayA9IGF3YWl0IHRoaXMuaW5pdFByb2Nlc3MoKVxyXG4gICAgaWYgKCFzb2NrKSB7XHJcbiAgICAgIHRocm93KCdFcnJvciBnZXR0aW5nIHNvY2tldCcpXHJcbiAgICB9XHJcbiAgICBsZXQgY21kID0gb3B0c1xyXG4gICAgY29uc3QgaWQgPSB0aGlzLmlkLnRvU3RyaW5nKClcclxuICAgICsrdGhpcy5pZFxyXG4gICAgb3B0c1snY29tbWFuZCddID0gY29tbWFuZFxyXG4gICAgb3B0c1snbm8tZmlsZSddID0gdHJ1ZVxyXG4gICAgb3B0c1snaWQnXSA9IGlkXHJcbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IGNhbGxzOiBDYWxsYmFja3MgPSB7XHJcbiAgICAgICAgb25FcnJvcjogKGVycm9yOiBzdHJpbmcsIGRldGFpbHM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgcmVqZWN0KGBFcnJvciByZXR1cm5lZDogJHtlcnJvcn1gKVxyXG4gICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Mub25FcnJvcikge1xyXG4gICAgICAgICAgICBjYWxsYmFja3Mub25FcnJvcihlcnJvciwgZGV0YWlscylcclxuICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uTm90aWZ5OiBjYWxsYmFja3MgPyBjYWxsYmFja3Mub25Ob3RpZnkgOiB1bmRlZmluZWQsXHJcbiAgICAgICAgb25SZXNwb25zZTogKHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpXHJcbiAgICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5vblJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrcy5vblJlc3BvbnNlKHJlc3BvbnNlKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICB0aGlzLmNhbGxiYWNrc1tpZF0gPSBjYWxsc1xyXG4gICAgICBkZWJ1ZyhgU2VuZGluZyBjb21tYW5kOiAke0pTT04uc3RyaW5naWZ5KGNtZCl9YClcclxuICAgICAgc29jay53cml0ZShKU09OLnN0cmluZ2lmeShjbWQpICsgJ1xcbicpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHBpbmcoY2FsbGJhY2tzPzogQ2FsbGJhY2tzKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdwaW5nJywge30sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyB3aG9hdChcclxuICAgIGZpbGU6IHN0cmluZyxcclxuICAgIGxpbmU6IG51bWJlcixcclxuICAgIGNvbHVtbjogbnVtYmVyLFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCd3aG9hdCcsIHsnZmlsZSc6IGZpbGUsICdsaW5lJzogbGluZSwgJ2NvbHVtbic6IGNvbHVtbn0sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyB3aG9pcyhcclxuICAgIGZpbGU6IHN0cmluZyxcclxuICAgIG5hbWU6IHN0cmluZyxcclxuICAgIGNhbGxiYWNrcz86IENhbGxiYWNrc1xyXG4gICkge1xyXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuY2FsbCgnd2hvaXMnLCB7J2ZpbGUnOiBmaWxlLCAnbmFtZSc6IG5hbWV9LCBjYWxsYmFja3MpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgbG9va3VwKFxyXG4gICAgZmlsZTogc3RyaW5nLFxyXG4gICAgbmFtZTogc3RyaW5nLFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdsb29rdXAnLCB7J2ZpbGUnOiBmaWxlLCAnbmFtZSc6IG5hbWV9LCBjYWxsYmFja3MpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgc3ltYm9sKFxyXG4gICAgb3B0czoge1xyXG4gICAgICBxdWVyeTogc3RyaW5nLFxyXG4gICAgICBzZWFyY2hUeXBlOiAnZXhhY3QnIHwgJ3ByZWZpeCcgfCAnaW5maXgnIHwgJ3N1ZmZpeCcsXHJcbiAgICAgIHByb2plY3Q/OiBzdHJpbmcsXHJcbiAgICAgIGZpbGU/OiBzdHJpbmcsXHJcbiAgICAgIG1vZHVsZT86IHN0cmluZyxcclxuICAgICAgcGFja2FnZT86IHN0cmluZyxcclxuICAgICAgaW5zdGFsbGVkOiBib29sZWFuLFxyXG4gICAgICBzb3VyY2VkOiBib29sZWFuLFxyXG4gICAgICBzdGFuZGFsb25lOiBib29sZWFuLFxyXG4gICAgICBsb2NhbE5hbWVzOiBib29sZWFuLFxyXG4gICAgICBoZWFkZXI6IGJvb2xlYW5cclxuICAgIH0gPSB7XHJcbiAgICAgIHF1ZXJ5OiAnJyxcclxuICAgICAgc2VhcmNoVHlwZTogJ3ByZWZpeCcsXHJcbiAgICAgIGluc3RhbGxlZDogZmFsc2UsXHJcbiAgICAgIHNvdXJjZWQ6IGZhbHNlLFxyXG4gICAgICBzdGFuZGFsb25lOiBmYWxzZSxcclxuICAgICAgbG9jYWxOYW1lczogZmFsc2UsXHJcbiAgICAgIGhlYWRlcjogZmFsc2VcclxuICAgIH0sXHJcbiAgICBjYWxsYmFja3M/OiBDYWxsYmFja3NcclxuICApIHtcclxuICAgIGNvbnN0IHBhcmFtcyA9IHtcclxuICAgICAgJ2lucHV0Jzogb3B0cy5xdWVyeSxcclxuICAgICAgJ3R5cGUnOiBvcHRzLnNlYXJjaFR5cGUsXHJcbiAgICAgICdsb2NhbHMnOiBvcHRzLmxvY2FsTmFtZXMsXHJcbiAgICAgICdoZWFkZXInOiBvcHRzLmhlYWRlcixcclxuICAgIH1cclxuICAgIGNvbnN0IGZpbHRlcnM6IGFueVtdID0gW11cclxuICAgIGlmIChvcHRzLnByb2plY3QpIHsgZmlsdGVycy5wdXNoKHsncHJvamVjdCc6IG9wdHMucHJvamVjdH0pIH1cclxuICAgIGlmIChvcHRzLmZpbGUpIHsgZmlsdGVycy5wdXNoKHsnZmlsZSc6IG9wdHMuZmlsZX0pIH1cclxuICAgIGlmIChvcHRzLm1vZHVsZSkgeyBmaWx0ZXJzLnB1c2goeydtb2R1bGUnOiBvcHRzLm1vZHVsZX0pIH1cclxuICAgIGlmIChvcHRzLnBhY2thZ2UpIHsgZmlsdGVycy5wdXNoKHsncGFja2FnZSc6IG9wdHMucGFja2FnZX0pIH1cclxuICAgIGlmIChvcHRzLmluc3RhbGxlZCkgeyBmaWx0ZXJzLnB1c2goJ2luc3RhbGxlZCcpIH1cclxuICAgIGlmIChvcHRzLnNvdXJjZWQpIHsgZmlsdGVycy5wdXNoKCdzb3VyY2VkJykgfVxyXG4gICAgaWYgKG9wdHMuc3RhbmRhbG9uZSkgeyBmaWx0ZXJzLnB1c2goJ3N0YW5kYWxvbmUnKSB9XHJcbiAgICBwYXJhbXNbJ2ZpbHRlcnMnXSA9IGZpbHRlcnNcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ3N5bWJvbCcsIHBhcmFtcywgY2FsbGJhY2tzKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGluZmVyKFxyXG4gICAgZmlsZXM6IHN0cmluZ1tdLFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdpbmZlcicsIHsncHJvamVjdHMnOiBbXSwgJ2ZpbGVzJzogZmlsZXN9LCBjYWxsYmFja3MpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgc2NhbkZpbGUoXHJcbiAgICBmaWxlOiBzdHJpbmcsXHJcbiAgICBjYWxsYmFja3M/OiBDYWxsYmFja3NcclxuICApIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ3NjYW4nLCB7J2ZpbGVzJzogW3snZmlsZSc6IGZpbGUsICdjb250ZW50cyc6IG51bGx9XX0sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzY2FuQ2FiYWwoY2FsbGJhY2tzPzogQ2FsbGJhY2tzKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdzY2FuJywgeydjYWJhbCc6IHRydWV9LCBjYWxsYmFja3MpXHJcbiAgfVxyXG59XHJcbiJdfQ==