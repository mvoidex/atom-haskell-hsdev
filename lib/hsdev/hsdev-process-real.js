"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const interactive_process_1 = require("./interactive-process");
const Util = require("../util");
const { debug, withTempFile, EOT } = Util;
const net = require("net");
class HsDevProcessReal {
    constructor(options = {}) {
        this.options = options;
        this.buffer = '';
        this.id = 0;
        this.callbacks = {};
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
    }
    async run(runArgs) {
        const { command } = runArgs;
        try {
            this.call(command);
        }
        catch (err) {
            debug(err);
            this.emitter.emit('error', { runArgs, err });
        }
    }
    killProcess() {
        debug(`Killing hsdev process`);
        this.proc && this.proc.kill();
    }
    destroy() {
        debug('HsDevProcessBase destroying');
        this.killProcess();
        this.emitter.emit('did-destroy');
        this.disposables.dispose();
    }
    onDidDestroy(callback) {
        return this.emitter.on('did-destroy', callback);
    }
    onWarning(callback) {
        return this.emitter.on('warning', callback);
    }
    onError(callback) {
        return this.emitter.on('error', callback);
    }
    async startServer() {
        if (this.proc) {
            return this.proc;
        }
        debug(`Spawning new hsdev instance for with`, this.options);
        const modPath = atom.config.get('atom-haskell-hsdev.hsdevPath');
        const dbPath = atom.config.get('atom-haskell-hsdev.hsdevDb');
        const hsdevPort = atom.config.get('atom-haskell-hsdev.hsdevPort');
        const runOpts = [];
        runOpts.push('run');
        if (this.options.port) {
            runOpts.push('--port', this.options.port.toString());
        }
        else if (hsdevPort) {
            runOpts.push('--port', hsdevPort.toString());
        }
        if (this.options.db) {
            runOpts.push('--db', this.options.db);
        }
        else if (dbPath) {
            runOpts.push('--db', dbPath);
        }
        if (this.options.logFile) {
            runOpts.push('--log', this.options.logFile);
        }
        if (this.options.logLevel) {
            runOpts.push('--log-level', this.options.logLevel);
        }
        this.proc = new interactive_process_1.InteractiveProcess(modPath, runOpts);
        this.proc.onceExit((code) => {
            debug(`hsdev ended with ${code}`);
            this.proc = undefined;
        });
        const { stdout } = await this.proc.readLine();
        const started = /Server started at port (.*)$/.exec(stdout[0]);
        if (started) {
            debug('Started hsdev');
            return this.proc;
        }
        return;
    }
    async connectHsDev() {
        if (this.sock) {
            return this.sock;
        }
        this.id = 0;
        this.sock = new net.Socket();
        this.sock.setEncoding('utf-8');
        this.sock.on('data', (data) => {
            const lines = data.split('\n');
            if (lines.length == 1) {
                this.buffer = this.buffer + (lines.pop() || '');
            }
            else {
                lines[0] = this.buffer + lines[0];
                this.buffer = lines.pop() || '';
            }
            for (const line of lines) {
                const resp = JSON.parse(line);
                const id = resp['id'];
                if (id) {
                    if (this.callbacks[id]) {
                        const { onError, onNotify, onResponse } = this.callbacks[id];
                        if (resp['error'] && onError) {
                            onError(resp['error'], resp);
                            delete this.callbacks[id];
                        }
                        else if (resp['notify'] && onNotify) {
                            onNotify(resp['notify']);
                        }
                        else if (resp['result'] && onResponse) {
                            onResponse(resp['result']);
                            delete this.callbacks[id];
                        }
                    }
                }
            }
        });
        this.sock.connect({ port: 4567 });
        return this.sock;
    }
    async initProcess() {
        const proc = await this.startServer();
        if (!proc) {
            throw 'Error spawning process';
        }
        return this.connectHsDev();
    }
    async socket() {
        if (!this.asyncSocket) {
            this.asyncSocket = this.initProcess();
        }
        return await this.asyncSocket;
    }
    async call(command, opts = {}, callbacks) {
        const sock = await this.socket();
        if (!sock) {
            throw ('Error getting socket');
        }
        let cmd = opts;
        const id = this.id.toString();
        ++this.id;
        opts['command'] = command;
        opts['no-file'] = true;
        opts['id'] = id;
        return await new Promise((resolve, reject) => {
            const calls = {
                onError: (error, details) => {
                    reject(`Error returned: ${error}`);
                    if (callbacks && callbacks.onError) {
                        callbacks.onError(error, details);
                    }
                },
                onNotify: callbacks ? callbacks.onNotify : undefined,
                onResponse: (response) => {
                    resolve(response);
                    if (callbacks && callbacks.onResponse) {
                        callbacks.onResponse(response);
                    }
                }
            };
            this.callbacks[id] = calls;
            sock.write(JSON.stringify(cmd) + '\n');
        });
    }
    async ping(callbacks) {
        return await this.call('ping', {}, callbacks);
    }
    async setFileContents(file, contents, callbacks) {
        return await this.call('set-file-contents', { 'file': file, 'contents': contents }, callbacks);
    }
    async whoat(file, line, column, callbacks) {
        return await this.call('whoat', { 'file': file, 'line': line, 'column': column }, callbacks);
    }
    async whois(file, name, callbacks) {
        return await this.call('whois', { 'file': file, 'name': name }, callbacks);
    }
    async lookup(file, name, callbacks) {
        return await this.call('lookup', { 'file': file, 'name': name }, callbacks);
    }
    async symbol(opts, callbacks) {
        const params = {
            'query': {
                'input': opts.query,
                'type': opts.searchType || 'prefix',
            },
            'locals': opts.localNames == true,
            'header': opts.header == true,
        };
        const filters = [];
        if (opts.project) {
            filters.push({ 'project': opts.project });
        }
        if (opts.file) {
            filters.push({ 'file': opts.file });
        }
        if (opts.module) {
            filters.push({ 'module': opts.module });
        }
        if (opts.package) {
            filters.push({ 'package': opts.package });
        }
        if (opts.installed) {
            filters.push('installed');
        }
        if (opts.sourced) {
            filters.push('sourced');
        }
        if (opts.standalone) {
            filters.push('standalone');
        }
        params['filters'] = filters;
        return await this.call('symbol', params, callbacks);
    }
    async module(opts, callbacks) {
        const params = {
            'query': {
                'input': opts.query,
                'type': opts.searchType || 'prefix',
            },
            'header': opts.header == true,
        };
        const filters = [];
        if (opts.project) {
            filters.push({ 'project': opts.project });
        }
        if (opts.file) {
            filters.push({ 'file': opts.file });
        }
        if (opts.module) {
            filters.push({ 'module': opts.module });
        }
        if (opts.package) {
            filters.push({ 'package': opts.package });
        }
        if (opts.installed) {
            filters.push('installed');
        }
        if (opts.sourced) {
            filters.push('sourced');
        }
        if (opts.standalone) {
            filters.push('standalone');
        }
        params['filters'] = filters;
        return await this.call('module', params, callbacks);
    }
    async complete(prefix, file, wide = false, callbacks) {
        return await this.call('complete', {
            'prefix': prefix,
            'file': file,
            'wide': wide,
        }, callbacks);
    }
    async scope(opts, callbacks) {
        return await this.call('scope', {
            'query': {
                'input': opts.query,
                'type': opts.searchType || 'prefix',
            },
            'file': opts.file,
        }, callbacks);
    }
    async scopeModules(opts, callbacks) {
        return await this.call('scope modules', {
            'query': {
                'input': opts.query,
                'type': opts.searchType || 'prefix',
            },
            'file': opts.file,
        }, callbacks);
    }
    async infer(files, callbacks) {
        return await this.call('infer', { 'projects': [], 'files': files }, callbacks);
    }
    async check(files, ghcOpts = [], callbacks) {
        return await this.call('check', {
            'files': files.map((value, _index, _array) => {
                return { 'file': value, 'contents': null };
            }),
            'ghc-opts': ghcOpts
        }, callbacks);
    }
    async lint(files, lintOpts = [], callbacks) {
        return await this.call('lint', {
            'files': files.map((value, _index, _array) => {
                return { 'file': value, 'contents': null };
            }),
            'lint-opts': lintOpts
        }, callbacks);
    }
    async checkLint(files, ghcOpts = [], lintOpts = [], callbacks) {
        return await this.call('check-lint', {
            'files': files.map((value, _index, _array) => {
                return { 'file': value, 'contents': null };
            }),
            'ghc-opts': ghcOpts,
            'lint-opts': lintOpts
        }, callbacks);
    }
    async scanFile(opts, callbacks) {
        const tool = atom.config.get('atom-haskell-hsdev.buildTool');
        return await this.call('scan file', {
            'file': opts.file,
            'build-tool': opts.buildTool || tool,
            'scan-project': opts.scanProject != false,
            'scan-deps': opts.scanDeps != false
        }, callbacks);
    }
    async scanCabal(callbacks) {
        return await this.call('scan', { 'cabal': true }, callbacks);
    }
    async langs(callbacks) {
        return await this.call('langs', {}, callbacks);
    }
    async flags(callbacks) {
        return await this.call('flags', {}, callbacks);
    }
}
exports.HsDevProcessReal = HsDevProcessReal;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHNkZXYtcHJvY2Vzcy1yZWFsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2hzZGV2L2hzZGV2LXByb2Nlc3MtcmVhbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE4RDtBQUM5RCwrREFBMEQ7QUFDMUQsZ0NBQStCO0FBQy9CLE1BQU0sRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQTtBQUV6QywyQkFBMEI7QUFvRDFCO0lBZUUsWUFDVSxVQUFzQixFQUFFO1FBQXhCLFlBQU8sR0FBUCxPQUFPLENBQWlCO1FBTDFCLFdBQU0sR0FBVyxFQUFFLENBQUE7UUFDbkIsT0FBRSxHQUFXLENBQUMsQ0FBQTtRQUNkLGNBQVMsR0FBOEIsRUFBRSxDQUFBO1FBSy9DLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQzVDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxjQUFPLEVBQUUsQ0FBQTtRQUM1QixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUVNLEtBQUssQ0FBQyxHQUFHLENBQ2QsT0FBZ0I7UUFFaEIsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQTtRQUUzQixJQUFJLENBQUM7WUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ3BCLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2IsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBRVYsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUE7UUFDOUMsQ0FBQztJQUNILENBQUM7SUFFTSxXQUFXO1FBQ2hCLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFB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Q25CLFdBQVcsRUFBRSxRQUFRO1NBQ3RCLEVBQUUsU0FBUyxDQUFDLENBQUE7SUFDZixDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQVEsQ0FDbkIsSUFLQyxFQUNELFNBQXFCO1FBRXJCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDhCQUE4QixDQUFDLENBQUE7UUFDNUQsTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDbEMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ2pCLFlBQVksRUFBRSxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUk7WUFDcEMsY0FBYyxFQUFFLElBQUksQ0FBQyxXQUFXLElBQUksS0FBSztZQUN6QyxXQUFXLEVBQUUsSUFBSSxDQUFDLFFBQVEsSUFBSSxLQUFLO1NBQ3BDLEVBQUUsU0FBUyxDQUFDLENBQUE7SUFDZixDQUFDO0lBRU0sS0FBSyxDQUFDLFNBQVMsQ0FBQyxTQUFxQjtRQUMxQyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUM1RCxDQUFDO0lBRU0sS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFxQjtRQUN0QyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUE7SUFDaEQsQ0FBQztJQUVNLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBcUI7UUFDdEMsTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFBO0lBQ2hELENBQUM7Q0FDRjtBQTlZRCw0Q0E4WUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RvcnksIEVtaXR0ZXIsIENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xyXG5pbXBvcnQgeyBJbnRlcmFjdGl2ZVByb2Nlc3MgfSBmcm9tICcuL2ludGVyYWN0aXZlLXByb2Nlc3MnXHJcbmltcG9ydCAqIGFzIFV0aWwgZnJvbSAnLi4vdXRpbCdcclxuY29uc3QgeyBkZWJ1Zywgd2l0aFRlbXBGaWxlLCBFT1QgfSA9IFV0aWxcclxuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnXHJcbmltcG9ydCAqIGFzIG5ldCBmcm9tICduZXQnXHJcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSdcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUnVuQXJncyB7XHJcbiAgaW50ZXJhY3RpdmU/OiBib29sZWFuXHJcbiAgY29tbWFuZDogc3RyaW5nXHJcbiAgdGV4dD86IHN0cmluZ1xyXG4gIHVyaT86IHN0cmluZ1xyXG4gIGRhc2hBcmdzPzogc3RyaW5nW11cclxuICBhcmdzPzogc3RyaW5nW11cclxuICBzdXBwcmVzc0Vycm9ycz86IGJvb2xlYW5cclxuICBnaGNPcHRpb25zPzogc3RyaW5nW11cclxuICBnaGNNb2RPcHRpb25zPzogc3RyaW5nW11cclxuICBidWlsZGVyOiBzdHJpbmcgfCB1bmRlZmluZWRcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSdW5PcHRpb25zIHtcclxuICBwb3J0PzogbnVtYmVyXHJcbiAgZGI/OiBzdHJpbmdcclxuICBsb2dGaWxlPzogc3RyaW5nXHJcbiAgbG9nTGV2ZWw/OiAndHJhY2UnIHwgJ2RlYnVnJyB8ICdpbmZvJyB8ICd3YXJuaW5nJyB8ICdlcnJvcicgfCAnZmF0YWwnXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSUVycm9yQ2FsbGJhY2tBcmdzIHtcclxuICBydW5BcmdzPzogUnVuQXJnc1xyXG4gIGVycjogRXJyb3JcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDYWxsYmFja3Mge1xyXG4gIG9uRXJyb3I/OiAoZXJyb3I6IHN0cmluZywgZGV0YWlsczogYW55KSA9PiB2b2lkXHJcbiAgb25Ob3RpZnk/OiAobm90aWZpY2F0aW9uOiBhbnkpID0+IHZvaWRcclxuICBvblJlc3BvbnNlPzogKHJlc3BvbnNlOiBhbnkpID0+IHZvaWRcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgU2VhcmNoVHlwZSA9ICdleGFjdCcgfCAncHJlZml4JyB8ICdpbmZpeCcgfCAnc3VmZml4J1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBRdWVyeSB7XHJcbiAgcXVlcnk6IHN0cmluZyxcclxuICBzZWFyY2hUeXBlPzogU2VhcmNoVHlwZSxcclxuICBoZWFkZXI/OiBib29sZWFuLFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5RmlsdGVycyB7XHJcbiAgcHJvamVjdD86IHN0cmluZyxcclxuICBmaWxlPzogc3RyaW5nLFxyXG4gIG1vZHVsZT86IHN0cmluZyxcclxuICBwYWNrYWdlPzogc3RyaW5nLFxyXG4gIGluc3RhbGxlZD86IGJvb2xlYW4sXHJcbiAgc291cmNlZD86IGJvb2xlYW4sXHJcbiAgc3RhbmRhbG9uZT86IGJvb2xlYW4sXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBIc0RldlByb2Nlc3NSZWFsIHtcclxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXHJcbiAgcHJpdmF0ZSBlbWl0dGVyOiBFbWl0dGVyPHtcclxuICAgICdkaWQtZGVzdHJveSc6IHZvaWRcclxuICB9LHtcclxuICAgICd3YXJuaW5nJzogc3RyaW5nXHJcbiAgICAnZXJyb3InOiBJRXJyb3JDYWxsYmFja0FyZ3NcclxuICB9PlxyXG4gIHByaXZhdGUgcHJvYzogSW50ZXJhY3RpdmVQcm9jZXNzIHwgdW5kZWZpbmVkXHJcbiAgcHJpdmF0ZSBzb2NrOiBuZXQuU29ja2V0IHwgdW5kZWZpbmVkXHJcbiAgcHJpdmF0ZSBhc3luY1NvY2tldDogUHJvbWlzZTxuZXQuU29ja2V0IHwgdW5kZWZpbmVkPiB8IHVuZGVmaW5lZFxyXG4gIHByaXZhdGUgYnVmZmVyOiBzdHJpbmcgPSAnJ1xyXG4gIHByaXZhdGUgaWQ6IG51bWJlciA9IDBcclxuICBwcml2YXRlIGNhbGxiYWNrczoge1tpZDogc3RyaW5nXTogQ2FsbGJhY2tzfSA9IHt9XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBSdW5PcHRpb25zID0ge30sXHJcbiAgKSB7XHJcbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxyXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxyXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHJ1bihcclxuICAgIHJ1bkFyZ3M6IFJ1bkFyZ3MsXHJcbiAgKSB7XHJcbiAgICBjb25zdCB7IGNvbW1hbmQgfSA9IHJ1bkFyZ3NcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICB0aGlzLmNhbGwoY29tbWFuZClcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBkZWJ1ZyhlcnIpXHJcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tdW5zYWZlLWFueVxyXG4gICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZXJyb3InLCB7IHJ1bkFyZ3MsIGVyciB9KVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGtpbGxQcm9jZXNzKCkge1xyXG4gICAgZGVidWcoYEtpbGxpbmcgaHNkZXYgcHJvY2Vzc2ApXHJcbiAgICB0aGlzLnByb2MgJiYgdGhpcy5wcm9jLmtpbGwoKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGRlc3Ryb3koKSB7XHJcbiAgICBkZWJ1ZygnSHNEZXZQcm9jZXNzQmFzZSBkZXN0cm95aW5nJylcclxuICAgIHRoaXMua2lsbFByb2Nlc3MoKVxyXG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1kZXN0cm95JylcclxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25EaWREZXN0cm95KGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XHJcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtZGVzdHJveScsIGNhbGxiYWNrKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uV2FybmluZyhjYWxsYmFjazogKHdhcm5pbmc6IHN0cmluZykgPT4gdm9pZCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignd2FybmluZycsIGNhbGxiYWNrKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uRXJyb3IoY2FsbGJhY2s6IChlcnJvcjogSUVycm9yQ2FsbGJhY2tBcmdzKSA9PiB2b2lkKSB7XHJcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdlcnJvcicsIGNhbGxiYWNrKVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBzdGFydFNlcnZlcigpOiBQcm9taXNlPEludGVyYWN0aXZlUHJvY2VzcyB8IHVuZGVmaW5lZD4ge1xyXG4gICAgaWYgKHRoaXMucHJvYykge1xyXG4gICAgICByZXR1cm4gdGhpcy5wcm9jXHJcbiAgICB9XHJcbiAgICBkZWJ1ZyhgU3Bhd25pbmcgbmV3IGhzZGV2IGluc3RhbmNlIGZvciB3aXRoYCwgdGhpcy5vcHRpb25zKVxyXG4gICAgY29uc3QgbW9kUGF0aCA9IGF0b20uY29uZmlnLmdldCgnYXRvbS1oYXNrZWxsLWhzZGV2LmhzZGV2UGF0aCcpXHJcbiAgICBjb25zdCBkYlBhdGggPSBhdG9tLmNvbmZpZy5nZXQoJ2F0b20taGFza2VsbC1oc2Rldi5oc2RldkRiJylcclxuICAgIGNvbnN0IGhzZGV2UG9ydDogbnVtYmVyIHwgdW5kZWZpbmVkID0gYXRvbS5jb25maWcuZ2V0KCdhdG9tLWhhc2tlbGwtaHNkZXYuaHNkZXZQb3J0JylcclxuICAgIGNvbnN0IHJ1bk9wdHM6IHN0cmluZ1tdID0gW11cclxuICAgIHJ1bk9wdHMucHVzaCgncnVuJylcclxuICAgIGlmICh0aGlzLm9wdGlvbnMucG9ydCkge1xyXG4gICAgICBydW5PcHRzLnB1c2goJy0tcG9ydCcsIHRoaXMub3B0aW9ucy5wb3J0LnRvU3RyaW5nKCkpXHJcbiAgICB9XHJcbiAgICBlbHNlIGlmIChoc2RldlBvcnQpIHtcclxuICAgICAgcnVuT3B0cy5wdXNoKCctLXBvcnQnLCBoc2RldlBvcnQudG9TdHJpbmcoKSlcclxuICAgIH1cclxuICAgIGlmICh0aGlzLm9wdGlvbnMuZGIpIHtcclxuICAgICAgcnVuT3B0cy5wdXNoKCctLWRiJywgdGhpcy5vcHRpb25zLmRiKVxyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoZGJQYXRoKSB7XHJcbiAgICAgIHJ1bk9wdHMucHVzaCgnLS1kYicsIGRiUGF0aClcclxuICAgIH1cclxuICAgIGlmICh0aGlzLm9wdGlvbnMubG9nRmlsZSkge1xyXG4gICAgICBydW5PcHRzLnB1c2goJy0tbG9nJywgdGhpcy5vcHRpb25zLmxvZ0ZpbGUpXHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5vcHRpb25zLmxvZ0xldmVsKSB7XHJcbiAgICAgIHJ1bk9wdHMucHVzaCgnLS1sb2ctbGV2ZWwnLCB0aGlzLm9wdGlvbnMubG9nTGV2ZWwpXHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5wcm9jID0gbmV3IEludGVyYWN0aXZlUHJvY2Vzcyhtb2RQYXRoLCBydW5PcHRzKVxyXG4gICAgdGhpcy5wcm9jLm9uY2VFeGl0KChjb2RlKSA9PiB7XHJcbiAgICAgIGRlYnVnKGBoc2RldiBlbmRlZCB3aXRoICR7Y29kZX1gKVxyXG4gICAgICB0aGlzLnByb2MgPSB1bmRlZmluZWRcclxuICAgIH0pXHJcbiAgICBjb25zdCB7IHN0ZG91dCB9ID0gYXdhaXQgdGhpcy5wcm9jLnJlYWRMaW5lKClcclxuICAgIGNvbnN0IHN0YXJ0ZWQgPSAvU2VydmVyIHN0YXJ0ZWQgYXQgcG9ydCAoLiopJC8uZXhlYyhzdGRvdXRbMF0pXHJcbiAgICBpZiAoc3RhcnRlZCkge1xyXG4gICAgICBkZWJ1ZygnU3RhcnRlZCBoc2RldicpXHJcbiAgICAgIHJldHVybiB0aGlzLnByb2NcclxuICAgIH1cclxuICAgIHJldHVyblxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGNvbm5lY3RIc0RldigpOiBQcm9taXNlPG5ldC5Tb2NrZXQgfCB1bmRlZmluZWQ+IHtcclxuICAgIGlmICh0aGlzLnNvY2spIHtcclxuICAgICAgcmV0dXJuIHRoaXMuc29ja1xyXG4gICAgfVxyXG4gICAgdGhpcy5pZCA9IDBcclxuICAgIHRoaXMuc29jayA9IG5ldyBuZXQuU29ja2V0KClcclxuICAgIHRoaXMuc29jay5zZXRFbmNvZGluZygndXRmLTgnKVxyXG4gICAgdGhpcy5zb2NrLm9uKCdkYXRhJywgKGRhdGE6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBsaW5lcyA9IGRhdGEuc3BsaXQoJ1xcbicpXHJcbiAgICAgIGlmIChsaW5lcy5sZW5ndGggPT0gMSkge1xyXG4gICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIgKyAobGluZXMucG9wKCkgfHwgJycpXHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgbGluZXNbMF0gPSB0aGlzLmJ1ZmZlciArIGxpbmVzWzBdXHJcbiAgICAgICAgdGhpcy5idWZmZXIgPSBsaW5lcy5wb3AoKSB8fCAnJ1xyXG4gICAgICB9XHJcbiAgICAgIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xyXG4gICAgICAgIGNvbnN0IHJlc3AgPSBKU09OLnBhcnNlKGxpbmUpXHJcbiAgICAgICAgY29uc3QgaWQgPSByZXNwWydpZCddXHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICBpZiAodGhpcy5jYWxsYmFja3NbaWRdKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgb25FcnJvciwgb25Ob3RpZnksIG9uUmVzcG9uc2UgfSA9IHRoaXMuY2FsbGJhY2tzW2lkXVxyXG4gICAgICAgICAgICBpZiAocmVzcFsnZXJyb3InXSAmJiBvbkVycm9yKSB7XHJcbiAgICAgICAgICAgICAgb25FcnJvcihyZXNwWydlcnJvciddLCByZXNwKVxyXG4gICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbGxiYWNrc1tpZF1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChyZXNwWydub3RpZnknXSAmJiBvbk5vdGlmeSkge1xyXG4gICAgICAgICAgICAgIG9uTm90aWZ5KHJlc3BbJ25vdGlmeSddKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHJlc3BbJ3Jlc3VsdCddICYmIG9uUmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICBvblJlc3BvbnNlKHJlc3BbJ3Jlc3VsdCddKVxyXG4gICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbGxiYWNrc1tpZF1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIHRoaXMuc29jay5jb25uZWN0KHtwb3J0OiA0NTY3fSlcclxuICAgIHJldHVybiB0aGlzLnNvY2tcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBpbml0UHJvY2VzcygpOiBQcm9taXNlPG5ldC5Tb2NrZXQgfCB1bmRlZmluZWQ+IHtcclxuICAgIGNvbnN0IHByb2MgPSBhd2FpdCB0aGlzLnN0YXJ0U2VydmVyKClcclxuICAgIGlmICghcHJvYykge1xyXG4gICAgICB0aHJvdyAnRXJyb3Igc3Bhd25pbmcgcHJvY2VzcydcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmNvbm5lY3RIc0RldigpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgc29ja2V0KCk6IFByb21pc2U8bmV0LlNvY2tldCB8IHVuZGVmaW5lZD4ge1xyXG4gICAgaWYgKCF0aGlzLmFzeW5jU29ja2V0KSB7XHJcbiAgICAgIHRoaXMuYXN5bmNTb2NrZXQgPSB0aGlzLmluaXRQcm9jZXNzKClcclxuICAgIH1cclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmFzeW5jU29ja2V0XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgY2FsbChcclxuICAgIGNvbW1hbmQ6IHN0cmluZyxcclxuICAgIG9wdHM6IHtbbmFtZTogc3RyaW5nXTogYW55fSA9IHt9LFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIC8vIGRlYnVnKGBSdW5uaW5nIGhzZGV2IGNvbW1hbmQgJHtjb21tYW5kfSB3aXRoIG9wdHM6ICR7b3B0c31gKVxyXG4gICAgY29uc3Qgc29jayA9IGF3YWl0IHRoaXMuc29ja2V0KClcclxuICAgIGlmICghc29jaykge1xyXG4gICAgICB0aHJvdygnRXJyb3IgZ2V0dGluZyBzb2NrZXQnKVxyXG4gICAgfVxyXG4gICAgbGV0IGNtZCA9IG9wdHNcclxuICAgIGNvbnN0IGlkID0gdGhpcy5pZC50b1N0cmluZygpXHJcbiAgICArK3RoaXMuaWRcclxuICAgIG9wdHNbJ2NvbW1hbmQnXSA9IGNvbW1hbmRcclxuICAgIG9wdHNbJ25vLWZpbGUnXSA9IHRydWVcclxuICAgIG9wdHNbJ2lkJ10gPSBpZFxyXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBjb25zdCBjYWxsczogQ2FsbGJhY2tzID0ge1xyXG4gICAgICAgIG9uRXJyb3I6IChlcnJvcjogc3RyaW5nLCBkZXRhaWxzOiBhbnkpID0+IHtcclxuICAgICAgICAgIHJlamVjdChgRXJyb3IgcmV0dXJuZWQ6ICR7ZXJyb3J9YClcclxuICAgICAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLm9uRXJyb3IpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2tzLm9uRXJyb3IoZXJyb3IsIGRldGFpbHMpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvbk5vdGlmeTogY2FsbGJhY2tzID8gY2FsbGJhY2tzLm9uTm90aWZ5IDogdW5kZWZpbmVkLFxyXG4gICAgICAgIG9uUmVzcG9uc2U6IChyZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKVxyXG4gICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Mub25SZXNwb25zZSkge1xyXG4gICAgICAgICAgICBjYWxsYmFja3Mub25SZXNwb25zZShyZXNwb25zZSlcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5jYWxsYmFja3NbaWRdID0gY2FsbHNcclxuICAgICAgc29jay53cml0ZShKU09OLnN0cmluZ2lmeShjbWQpICsgJ1xcbicpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHBpbmcoY2FsbGJhY2tzPzogQ2FsbGJhY2tzKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdwaW5nJywge30sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzZXRGaWxlQ29udGVudHMoXHJcbiAgICBmaWxlOiBzdHJpbmcsXHJcbiAgICBjb250ZW50czogc3RyaW5nLFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdzZXQtZmlsZS1jb250ZW50cycsIHsnZmlsZSc6IGZpbGUsICdjb250ZW50cyc6IGNvbnRlbnRzfSwgY2FsbGJhY2tzKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHdob2F0KFxyXG4gICAgZmlsZTogc3RyaW5nLFxyXG4gICAgbGluZTogbnVtYmVyLFxyXG4gICAgY29sdW1uOiBudW1iZXIsXHJcbiAgICBjYWxsYmFja3M/OiBDYWxsYmFja3NcclxuICApIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ3dob2F0JywgeydmaWxlJzogZmlsZSwgJ2xpbmUnOiBsaW5lLCAnY29sdW1uJzogY29sdW1ufSwgY2FsbGJhY2tzKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHdob2lzKFxyXG4gICAgZmlsZTogc3RyaW5nLFxyXG4gICAgbmFtZTogc3RyaW5nLFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCd3aG9pcycsIHsnZmlsZSc6IGZpbGUsICduYW1lJzogbmFtZX0sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBsb29rdXAoXHJcbiAgICBmaWxlOiBzdHJpbmcsXHJcbiAgICBuYW1lOiBzdHJpbmcsXHJcbiAgICBjYWxsYmFja3M/OiBDYWxsYmFja3NcclxuICApIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ2xvb2t1cCcsIHsnZmlsZSc6IGZpbGUsICduYW1lJzogbmFtZX0sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzeW1ib2woXHJcbiAgICBvcHRzOiBRdWVyeSAmIFF1ZXJ5RmlsdGVycyAmIHsgbG9jYWxOYW1lcz86IGJvb2xlYW4gfSxcclxuICAgIGNhbGxiYWNrcz86IENhbGxiYWNrc1xyXG4gICkge1xyXG4gICAgY29uc3QgcGFyYW1zID0ge1xyXG4gICAgICAncXVlcnknOiB7XHJcbiAgICAgICAgJ2lucHV0Jzogb3B0cy5xdWVyeSxcclxuICAgICAgICAndHlwZSc6IG9wdHMuc2VhcmNoVHlwZSB8fCAncHJlZml4JyxcclxuICAgICAgfSxcclxuICAgICAgJ2xvY2Fscyc6IG9wdHMubG9jYWxOYW1lcyA9PSB0cnVlLFxyXG4gICAgICAnaGVhZGVyJzogb3B0cy5oZWFkZXIgPT0gdHJ1ZSxcclxuICAgIH1cclxuICAgIGNvbnN0IGZpbHRlcnM6IGFueVtdID0gW11cclxuICAgIGlmIChvcHRzLnByb2plY3QpIHsgZmlsdGVycy5wdXNoKHsncHJvamVjdCc6IG9wdHMucHJvamVjdH0pIH1cclxuICAgIGlmIChvcHRzLmZpbGUpIHsgZmlsdGVycy5wdXNoKHsnZmlsZSc6IG9wdHMuZmlsZX0pIH1cclxuICAgIGlmIChvcHRzLm1vZHVsZSkgeyBmaWx0ZXJzLnB1c2goeydtb2R1bGUnOiBvcHRzLm1vZHVsZX0pIH1cclxuICAgIGlmIChvcHRzLnBhY2thZ2UpIHsgZmlsdGVycy5wdXNoKHsncGFja2FnZSc6IG9wdHMucGFja2FnZX0pIH1cclxuICAgIGlmIChvcHRzLmluc3RhbGxlZCkgeyBmaWx0ZXJzLnB1c2goJ2luc3RhbGxlZCcpIH1cclxuICAgIGlmIChvcHRzLnNvdXJjZWQpIHsgZmlsdGVycy5wdXNoKCdzb3VyY2VkJykgfVxyXG4gICAgaWYgKG9wdHMuc3RhbmRhbG9uZSkgeyBmaWx0ZXJzLnB1c2goJ3N0YW5kYWxvbmUnKSB9XHJcbiAgICBwYXJhbXNbJ2ZpbHRlcnMnXSA9IGZpbHRlcnNcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ3N5bWJvbCcsIHBhcmFtcywgY2FsbGJhY2tzKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIG1vZHVsZShcclxuICAgIG9wdHM6IFF1ZXJ5ICYgUXVlcnlGaWx0ZXJzLFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKSB7XHJcbiAgICBjb25zdCBwYXJhbXMgPSB7XHJcbiAgICAgICdxdWVyeSc6IHtcclxuICAgICAgICAnaW5wdXQnOiBvcHRzLnF1ZXJ5LFxyXG4gICAgICAgICd0eXBlJzogb3B0cy5zZWFyY2hUeXBlIHx8ICdwcmVmaXgnLFxyXG4gICAgICB9LFxyXG4gICAgICAnaGVhZGVyJzogb3B0cy5oZWFkZXIgPT0gdHJ1ZSxcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmaWx0ZXJzOiBhbnlbXSA9IFtdXHJcbiAgICBpZiAob3B0cy5wcm9qZWN0KSB7IGZpbHRlcnMucHVzaCh7J3Byb2plY3QnOiBvcHRzLnByb2plY3R9KSB9XHJcbiAgICBpZiAob3B0cy5maWxlKSB7IGZpbHRlcnMucHVzaCh7J2ZpbGUnOiBvcHRzLmZpbGV9KSB9XHJcbiAgICBpZiAob3B0cy5tb2R1bGUpIHsgZmlsdGVycy5wdXNoKHsnbW9kdWxlJzogb3B0cy5tb2R1bGV9KSB9XHJcbiAgICBpZiAob3B0cy5wYWNrYWdlKSB7IGZpbHRlcnMucHVzaCh7J3BhY2thZ2UnOiBvcHRzLnBhY2thZ2V9KSB9XHJcbiAgICBpZiAob3B0cy5pbnN0YWxsZWQpIHsgZmlsdGVycy5wdXNoKCdpbnN0YWxsZWQnKSB9XHJcbiAgICBpZiAob3B0cy5zb3VyY2VkKSB7IGZpbHRlcnMucHVzaCgnc291cmNlZCcpIH1cclxuICAgIGlmIChvcHRzLnN0YW5kYWxvbmUpIHsgZmlsdGVycy5wdXNoKCdzdGFuZGFsb25lJykgfVxyXG4gICAgcGFyYW1zWydmaWx0ZXJzJ10gPSBmaWx0ZXJzXHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdtb2R1bGUnLCBwYXJhbXMsIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBjb21wbGV0ZShcclxuICAgIHByZWZpeDogc3RyaW5nLFxyXG4gICAgZmlsZTogc3RyaW5nLFxyXG4gICAgd2lkZTogYm9vbGVhbiA9IGZhbHNlLFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdjb21wbGV0ZScsIHtcclxuICAgICAgJ3ByZWZpeCc6IHByZWZpeCxcclxuICAgICAgJ2ZpbGUnOiBmaWxlLFxyXG4gICAgICAnd2lkZSc6IHdpZGUsXHJcbiAgICB9LCBjYWxsYmFja3MpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgc2NvcGUoXHJcbiAgICBvcHRzOiBRdWVyeSAmIHsgZmlsZTogc3RyaW5nIH0sXHJcbiAgICBjYWxsYmFja3M/OiBDYWxsYmFja3NcclxuICApIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ3Njb3BlJywge1xyXG4gICAgICAncXVlcnknOiB7XHJcbiAgICAgICAgJ2lucHV0Jzogb3B0cy5xdWVyeSxcclxuICAgICAgICAndHlwZSc6IG9wdHMuc2VhcmNoVHlwZSB8fCAncHJlZml4JyxcclxuICAgICAgfSxcclxuICAgICAgJ2ZpbGUnOiBvcHRzLmZpbGUsXHJcbiAgICB9LCBjYWxsYmFja3MpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgc2NvcGVNb2R1bGVzKFxyXG4gICAgb3B0czogUXVlcnkgJiB7IGZpbGU6IHN0cmluZyB9LFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdzY29wZSBtb2R1bGVzJywge1xyXG4gICAgICAncXVlcnknOiB7XHJcbiAgICAgICAgJ2lucHV0Jzogb3B0cy5xdWVyeSxcclxuICAgICAgICAndHlwZSc6IG9wdHMuc2VhcmNoVHlwZSB8fCAncHJlZml4JyxcclxuICAgICAgfSxcclxuICAgICAgJ2ZpbGUnOiBvcHRzLmZpbGUsXHJcbiAgICB9LCBjYWxsYmFja3MpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgaW5mZXIoXHJcbiAgICBmaWxlczogc3RyaW5nW10sXHJcbiAgICBjYWxsYmFja3M/OiBDYWxsYmFja3NcclxuICApIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ2luZmVyJywgeydwcm9qZWN0cyc6IFtdLCAnZmlsZXMnOiBmaWxlc30sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBjaGVjayhcclxuICAgIGZpbGVzOiBzdHJpbmdbXSxcclxuICAgIGdoY09wdHM6IHN0cmluZ1tdID0gW10sXHJcbiAgICBjYWxsYmFja3M/OiBDYWxsYmFja3NcclxuICApIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ2NoZWNrJywge1xyXG4gICAgICAnZmlsZXMnOiBmaWxlcy5tYXAoKHZhbHVlLCBfaW5kZXgsIF9hcnJheSkgPT4ge1xyXG4gICAgICAgIHJldHVybiB7J2ZpbGUnOiB2YWx1ZSwgJ2NvbnRlbnRzJzogbnVsbH1cclxuICAgICAgfSksXHJcbiAgICAgICdnaGMtb3B0cyc6IGdoY09wdHNcclxuICAgIH0sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBsaW50KFxyXG4gICAgZmlsZXM6IHN0cmluZ1tdLFxyXG4gICAgbGludE9wdHM6IHN0cmluZ1tdID0gW10sXHJcbiAgICBjYWxsYmFja3M/OiBDYWxsYmFja3NcclxuICApIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ2xpbnQnLCB7XHJcbiAgICAgICdmaWxlcyc6IGZpbGVzLm1hcCgodmFsdWUsIF9pbmRleCwgX2FycmF5KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHsnZmlsZSc6IHZhbHVlLCAnY29udGVudHMnOiBudWxsfVxyXG4gICAgICB9KSxcclxuICAgICAgJ2xpbnQtb3B0cyc6IGxpbnRPcHRzXHJcbiAgICB9LCBjYWxsYmFja3MpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgY2hlY2tMaW50KFxyXG4gICAgZmlsZXM6IHN0cmluZ1tdLFxyXG4gICAgZ2hjT3B0czogc3RyaW5nW10gPSBbXSxcclxuICAgIGxpbnRPcHRzOiBzdHJpbmdbXSA9IFtdLFxyXG4gICAgY2FsbGJhY2tzPzogQ2FsbGJhY2tzXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdjaGVjay1saW50Jywge1xyXG4gICAgICAnZmlsZXMnOiBmaWxlcy5tYXAoKHZhbHVlLCBfaW5kZXgsIF9hcnJheSkgPT4ge1xyXG4gICAgICAgIHJldHVybiB7J2ZpbGUnOiB2YWx1ZSwgJ2NvbnRlbnRzJzogbnVsbH1cclxuICAgICAgfSksXHJcbiAgICAgICdnaGMtb3B0cyc6IGdoY09wdHMsXHJcbiAgICAgICdsaW50LW9wdHMnOiBsaW50T3B0c1xyXG4gICAgfSwgY2FsbGJhY2tzKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHNjYW5GaWxlKFxyXG4gICAgb3B0czoge1xyXG4gICAgICBmaWxlOiBzdHJpbmcsXHJcbiAgICAgIGJ1aWxkVG9vbD86ICdjYWJhbCcgfCAnc3RhY2snLFxyXG4gICAgICBzY2FuUHJvamVjdD86IGJvb2xlYW4sXHJcbiAgICAgIHNjYW5EZXBzPzogYm9vbGVhblxyXG4gICAgfSxcclxuICAgIGNhbGxiYWNrcz86IENhbGxiYWNrc1xyXG4gICkge1xyXG4gICAgY29uc3QgdG9vbCA9IGF0b20uY29uZmlnLmdldCgnYXRvbS1oYXNrZWxsLWhzZGV2LmJ1aWxkVG9vbCcpXHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jYWxsKCdzY2FuIGZpbGUnLCB7XHJcbiAgICAgICdmaWxlJzogb3B0cy5maWxlLFxyXG4gICAgICAnYnVpbGQtdG9vbCc6IG9wdHMuYnVpbGRUb29sIHx8IHRvb2wsXHJcbiAgICAgICdzY2FuLXByb2plY3QnOiBvcHRzLnNjYW5Qcm9qZWN0ICE9IGZhbHNlLFxyXG4gICAgICAnc2Nhbi1kZXBzJzogb3B0cy5zY2FuRGVwcyAhPSBmYWxzZVxyXG4gICAgfSwgY2FsbGJhY2tzKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHNjYW5DYWJhbChjYWxsYmFja3M/OiBDYWxsYmFja3MpIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ3NjYW4nLCB7J2NhYmFsJzogdHJ1ZX0sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBsYW5ncyhjYWxsYmFja3M/OiBDYWxsYmFja3MpIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ2xhbmdzJywge30sIGNhbGxiYWNrcylcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBmbGFncyhjYWxsYmFja3M/OiBDYWxsYmFja3MpIHtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGwoJ2ZsYWdzJywge30sIGNhbGxiYWNrcylcclxuICB9XHJcbn1cclxuIl19