"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const FZ = require("fuzzaldrin");
const atom_1 = require("atom");
const buffer_info_1 = require("./buffer-info");
const module_info_1 = require("./module-info");
const Util = require("../util");
const { handleException } = Util;
class CompletionBackend {
    constructor(process, upi) {
        this.process = process;
        this.upi = upi;
        this.bufferMap = new WeakMap();
        this.dirMap = new WeakMap();
        this.modListMap = new WeakMap();
        this.languagePragmas = new WeakMap();
        this.compilerOptions = new WeakMap();
        this.name = this.name.bind(this);
        this.onDidDestroy = this.onDidDestroy.bind(this);
        this.registerCompletionBuffer = this.registerCompletionBuffer.bind(this);
        this.unregisterCompletionBuffer = this.unregisterCompletionBuffer.bind(this);
        this.getCompletionsForSymbol = this.getCompletionsForSymbol.bind(this);
        this.getCompletionsForType = this.getCompletionsForType.bind(this);
        this.getCompletionsForClass = this.getCompletionsForClass.bind(this);
        this.getCompletionsForModule = this.getCompletionsForModule.bind(this);
        this.getCompletionsForSymbolInModule = this.getCompletionsForSymbolInModule.bind(this);
        this.getCompletionsForLanguagePragmas = this.getCompletionsForLanguagePragmas.bind(this);
        this.getCompletionsForCompilerOptions = this.getCompletionsForCompilerOptions.bind(this);
        this.getCompletionsForHole = this.getCompletionsForHole.bind(this);
        this.process = process;
        this.isActive = true;
        this.process.onDidDestroy(() => { this.isActive = false; });
    }
    name() { return 'atom-haskell-hsdev'; }
    onDidDestroy(callback) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        return this.process.onDidDestroy(callback);
    }
    registerCompletionBuffer(buffer) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        if (this.bufferMap.has(buffer)) {
            return new atom_1.Disposable(() => { });
        }
        const { bufferInfo } = this.getBufferInfo({ buffer });
        setImmediate(async () => {
            const { rootDir, moduleMap } = await this.getModuleMap({ bufferInfo });
            this.getModuleInfo({ bufferInfo, rootDir, moduleMap });
            const imports = await bufferInfo.getImports();
            for (const imprt of imports) {
                this.getModuleInfo({ moduleName: imprt.name, bufferInfo, rootDir, moduleMap });
            }
        });
        return new atom_1.Disposable(() => this.unregisterCompletionBuffer(buffer));
    }
    unregisterCompletionBuffer(buffer) {
        const x = this.bufferMap.get(buffer);
        if (x) {
            x.destroy();
        }
    }
    async getCompletionsForSymbol(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getSymbolsForBuffer(buffer);
        return this.filter(symbols, prefix, ['qname', 'qparent']);
    }
    async getCompletionsForType(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getSymbolsForBuffer(buffer, ['type', 'class']);
        return FZ.filter(symbols, prefix, { key: 'qname' });
    }
    async getCompletionsForClass(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getSymbolsForBuffer(buffer, ['class']);
        return FZ.filter(symbols, prefix, { key: 'qname' });
    }
    async getCompletionsForModule(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const rootDir = await this.process.getRootDir(buffer);
        let modules = this.modListMap.get(rootDir);
        if (!modules) {
            modules = await this.process.runList(buffer);
            this.modListMap.set(rootDir, modules);
            setTimeout((() => this.modListMap.delete(rootDir)), 60 * 1000);
        }
        return FZ.filter(modules, prefix);
    }
    async getCompletionsForSymbolInModule(buffer, prefix, position, opts) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        let moduleName = opts ? opts.module : undefined;
        if (!moduleName) {
            const lineRange = new atom_1.Range([0, position.row], position);
            buffer.backwardsScanInRange(/^import\s+([\w.]+)/, lineRange, ({ match }) => moduleName = match[1]);
        }
        const { bufferInfo } = this.getBufferInfo({ buffer });
        const mis = await this.getModuleInfo({ bufferInfo, moduleName });
        const symbols = await mis.moduleInfo.select({
            qualified: false,
            hiding: false,
            name: moduleName || mis.moduleName,
            importList: null,
            alias: null,
        }, undefined, true);
        return FZ.filter(symbols, prefix, { key: 'name' });
    }
    async getCompletionsForLanguagePragmas(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const dir = await this.process.getRootDir(buffer);
        let ps = this.languagePragmas.get(dir);
        if (!ps) {
            ps = await this.process.runLang(dir);
            ps && this.languagePragmas.set(dir, ps);
        }
        return FZ.filter(ps, prefix);
    }
    async getCompletionsForCompilerOptions(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const dir = await this.process.getRootDir(buffer);
        let co = this.compilerOptions.get(dir);
        if (!co) {
            co = await this.process.runFlag(dir);
            this.compilerOptions.set(dir, co);
        }
        return FZ.filter(co, prefix);
    }
    async getCompletionsForHole(buffer, prefix, position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const range = new atom_1.Range(position, position);
        if (prefix.startsWith('_')) {
            prefix = prefix.slice(1);
        }
        const { type } = await this.process.getTypeInBuffer(buffer, range);
        const symbols = await this.getSymbolsForBuffer(buffer);
        const ts = symbols.filter((s) => {
            if (!s.typeSignature) {
                return false;
            }
            const tl = s.typeSignature.split(' -> ').slice(-1)[0];
            if (tl.match(/^[a-z]$/)) {
                return false;
            }
            const ts2 = tl.replace(/[.?*+^$[\]\\(){}|-]/g, '\\$&');
            const rx = RegExp(ts2.replace(/\b[a-z]\b/g, '.+'), '');
            return rx.test(type);
        });
        if (prefix.length === 0) {
            return ts.sort((a, b) => FZ.score(b.typeSignature, type) - FZ.score(a.typeSignature, type));
        }
        else {
            return FZ.filter(ts, prefix, { key: 'qname' });
        }
    }
    async getSymbolsForBuffer(buffer, symbolTypes) {
        const { bufferInfo } = this.getBufferInfo({ buffer });
        const { rootDir, moduleMap } = await this.getModuleMap({ bufferInfo });
        if (bufferInfo && moduleMap) {
            const imports = await bufferInfo.getImports();
            const promises = await Promise.all(imports.map(async (imp) => {
                const res = await this.getModuleInfo({
                    bufferInfo,
                    moduleName: imp.name,
                    rootDir,
                    moduleMap,
                });
                if (!res) {
                    return [];
                }
                return res.moduleInfo.select(imp, symbolTypes);
            }));
            return [].concat(...promises);
        }
        else {
            return [];
        }
    }
    getBufferInfo({ buffer }) {
        let bi = this.bufferMap.get(buffer);
        if (!bi) {
            bi = new buffer_info_1.BufferInfo(buffer);
            this.bufferMap.set(buffer, bi);
        }
        return { bufferInfo: bi };
    }
    async getModuleMap({ bufferInfo, rootDir }) {
        if (!rootDir) {
            rootDir = await this.process.getRootDir(bufferInfo.buffer);
        }
        let mm = this.dirMap.get(rootDir);
        if (!mm) {
            mm = new Map();
            this.dirMap.set(rootDir, mm);
        }
        return {
            rootDir,
            moduleMap: mm,
        };
    }
    async getModuleInfo(arg) {
        const { bufferInfo } = arg;
        let dat;
        if (arg.rootDir && arg.moduleMap) {
            dat = { rootDir: arg.rootDir, moduleMap: arg.moduleMap };
        }
        else {
            dat = await this.getModuleMap({ bufferInfo });
        }
        const { moduleMap, rootDir } = dat;
        let moduleName = arg.moduleName;
        if (!moduleName) {
            moduleName = await bufferInfo.getModuleName();
        }
        if (!moduleName) {
            throw new Error(`Nameless module in ${bufferInfo.buffer.getUri()}`);
        }
        let moduleInfo = moduleMap.get(moduleName);
        if (!moduleInfo) {
            moduleInfo = new module_info_1.ModuleInfo(moduleName, this.process, rootDir);
            moduleMap.set(moduleName, moduleInfo);
            const mn = moduleName;
            moduleInfo.onDidDestroy(() => {
                moduleMap.delete(mn);
                Util.debug(`${moduleName} removed from map`);
            });
        }
        await moduleInfo.setBuffer(bufferInfo);
        return { bufferInfo, rootDir, moduleMap, moduleInfo, moduleName };
    }
    filter(candidates, prefix, keys) {
        if (!prefix) {
            return candidates;
        }
        const list = [];
        for (const candidate of candidates) {
            const scores = keys.map((key) => {
                const ck = candidate[key];
                if (ck) {
                    return FZ.score(ck.toString(), prefix);
                }
                else {
                    return 0;
                }
            });
            const score = Math.max(...scores);
            if (score > 0) {
                list.push({
                    score,
                    scoreN: scores.indexOf(score),
                    data: candidate,
                });
            }
        }
        return list.sort((a, b) => {
            const s = b.score - a.score;
            if (s === 0) {
                return a.scoreN - b.scoreN;
            }
            return s;
        }).map(({ data }) => data);
    }
}
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [typeof (_a = typeof atom_1.TextBuffer !== "undefined" && atom_1.TextBuffer) === "function" && _a || Object, String, typeof (_b = typeof atom_1.Point !== "undefined" && atom_1.Point) === "function" && _b || Object]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForSymbol", null);
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [typeof (_c = typeof atom_1.TextBuffer !== "undefined" && atom_1.TextBuffer) === "function" && _c || Object, String, typeof (_d = typeof atom_1.Point !== "undefined" && atom_1.Point) === "function" && _d || Object]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForType", null);
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [typeof (_e = typeof atom_1.TextBuffer !== "undefined" && atom_1.TextBuffer) === "function" && _e || Object, String, typeof (_f = typeof atom_1.Point !== "undefined" && atom_1.Point) === "function" && _f || Object]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForHole", null);
exports.CompletionBackend = CompletionBackend;
var _a, _b, _c, _d, _e, _f;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tcGxldGlvbi1iYWNrZW5kL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUFnQztBQUNoQywrQkFFYTtBQUNiLCtDQUEwQztBQUMxQywrQ0FBMEM7QUFFMUMsZ0NBQStCO0FBSS9CLE1BQU0sRUFBRSxlQUFlLEVBQUUsR0FBRyxJQUFJLENBQUE7QUFHaEM7SUFRRSxZQUFvQixPQUFxQixFQUFTLEdBQThCO1FBQTVELFlBQU8sR0FBUCxPQUFPLENBQWM7UUFBUyxRQUFHLEdBQUgsR0FBRyxDQUEyQjtRQUM5RSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFDOUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBQzNCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUMvQixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFDcEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBR3BDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDaEMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNoRCxJQUFJLENBQUMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN4RSxJQUFJLENBQUMsMEJBQTBCLEdBQUcsSUFBSSxDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUM1RSxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxJQUFJ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QUNqQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDZCxJQUFJLENBQUMsSUFBSSxDQUFDO29CQUNSLEtBQUs7b0JBQ0wsTUFBTSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO29CQUM3QixJQUFJLEVBQUUsU0FBUztpQkFDaEIsQ0FBQyxDQUFBO1lBQ0osQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN4QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUE7WUFDM0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ1osTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtZQUM1QixDQUFDO1lBQ0QsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUNWLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzVCLENBQUM7Q0FDRjtBQXRVQztJQURDLGVBQWU7O2lFQUVOLGlCQUFVLG9CQUFWLGlCQUFVLDhEQUE2QixZQUFLLG9CQUFMLFlBQUs7O2dFQU1yRDtBQWFEO0lBREMsZUFBZTs7aUVBRU4saUJBQVUsb0JBQVYsaUJBQVUsOERBQTZCLFlBQUssb0JBQUwsWUFBSzs7OERBTXJEO0FBMkpEO0lBREMsZUFBZTs7aUVBRU4saUJBQVUsb0JBQVYsaUJBQVUsOERBQTRCLFlBQUssb0JBQUwsWUFBSzs7OERBcUJwRDtBQXRVSCw4Q0FnY0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBGWiBmcm9tICdmdXp6YWxkcmluJ1xyXG5pbXBvcnQge1xyXG4gIFRleHRCdWZmZXIsIFBvaW50LCBEaXNwb3NhYmxlLCBSYW5nZSwgRGlyZWN0b3J5XHJcbn0gZnJvbSAnYXRvbSdcclxuaW1wb3J0IHsgQnVmZmVySW5mbyB9IGZyb20gJy4vYnVmZmVyLWluZm8nXHJcbmltcG9ydCB7IE1vZHVsZUluZm8gfSBmcm9tICcuL21vZHVsZS1pbmZvJ1xyXG5pbXBvcnQgeyBIc0RldlByb2Nlc3MgfSBmcm9tICcuLi9oc2RldidcclxuaW1wb3J0ICogYXMgVXRpbCBmcm9tICcuLi91dGlsJ1xyXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcclxuaW1wb3J0ICogYXMgQ0IgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaS9jb21wbGV0aW9uLWJhY2tlbmQnXHJcblxyXG5jb25zdCB7IGhhbmRsZUV4Y2VwdGlvbiB9ID0gVXRpbFxyXG5cclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuc2FmZS1hbnlcclxuZXhwb3J0IGNsYXNzIENvbXBsZXRpb25CYWNrZW5kIGltcGxlbWVudHMgQ0IuSUNvbXBsZXRpb25CYWNrZW5kIHtcclxuICBwcml2YXRlIGJ1ZmZlck1hcDogV2Vha01hcDxUZXh0QnVmZmVyLCBCdWZmZXJJbmZvPlxyXG4gIHByaXZhdGUgZGlyTWFwOiBXZWFrTWFwPERpcmVjdG9yeSwgTWFwPHN0cmluZywgTW9kdWxlSW5mbz4+XHJcbiAgcHJpdmF0ZSBtb2RMaXN0TWFwOiBXZWFrTWFwPERpcmVjdG9yeSwgc3RyaW5nW10+XHJcbiAgcHJpdmF0ZSBsYW5ndWFnZVByYWdtYXM6IFdlYWtNYXA8RGlyZWN0b3J5LCBzdHJpbmdbXT5cclxuICBwcml2YXRlIGNvbXBpbGVyT3B0aW9uczogV2Vha01hcDxEaXJlY3RvcnksIHN0cmluZ1tdPlxyXG4gIHByaXZhdGUgaXNBY3RpdmU6IGJvb2xlYW5cclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwcm9jZXNzOiBIc0RldlByb2Nlc3MsIHB1YmxpYyB1cGk6IFByb21pc2U8VVBJLklVUElJbnN0YW5jZT4pIHtcclxuICAgIHRoaXMuYnVmZmVyTWFwID0gbmV3IFdlYWtNYXAoKVxyXG4gICAgdGhpcy5kaXJNYXAgPSBuZXcgV2Vha01hcCgpXHJcbiAgICB0aGlzLm1vZExpc3RNYXAgPSBuZXcgV2Vha01hcCgpXHJcbiAgICB0aGlzLmxhbmd1YWdlUHJhZ21hcyA9IG5ldyBXZWFrTWFwKClcclxuICAgIHRoaXMuY29tcGlsZXJPcHRpb25zID0gbmV3IFdlYWtNYXAoKVxyXG5cclxuICAgIC8vIGNvbXBhdGliaWxpdHkgd2l0aCBvbGQgY2xpZW50c1xyXG4gICAgdGhpcy5uYW1lID0gdGhpcy5uYW1lLmJpbmQodGhpcylcclxuICAgIHRoaXMub25EaWREZXN0cm95ID0gdGhpcy5vbkRpZERlc3Ryb3kuYmluZCh0aGlzKVxyXG4gICAgdGhpcy5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIgPSB0aGlzLnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlci5iaW5kKHRoaXMpXHJcbiAgICB0aGlzLnVucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyID0gdGhpcy51bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlci5iaW5kKHRoaXMpXHJcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9yU3ltYm9sID0gdGhpcy5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbC5iaW5kKHRoaXMpXHJcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9yVHlwZSA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JUeXBlLmJpbmQodGhpcylcclxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDbGFzcyA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDbGFzcy5iaW5kKHRoaXMpXHJcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9yTW9kdWxlID0gdGhpcy5nZXRDb21wbGV0aW9uc0Zvck1vZHVsZS5iaW5kKHRoaXMpXHJcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUuYmluZCh0aGlzKVxyXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0Zvckxhbmd1YWdlUHJhZ21hcyA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JMYW5ndWFnZVByYWdtYXMuYmluZCh0aGlzKVxyXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0ZvckNvbXBpbGVyT3B0aW9ucyA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDb21waWxlck9wdGlvbnMuYmluZCh0aGlzKVxyXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0ZvckhvbGUgPSB0aGlzLmdldENvbXBsZXRpb25zRm9ySG9sZS5iaW5kKHRoaXMpXHJcblxyXG4gICAgdGhpcy5wcm9jZXNzID0gcHJvY2Vzc1xyXG4gICAgdGhpcy5pc0FjdGl2ZSA9IHRydWVcclxuICAgIHRoaXMucHJvY2Vzcy5vbkRpZERlc3Ryb3koKCkgPT4geyB0aGlzLmlzQWN0aXZlID0gZmFsc2UgfSlcclxuICB9XHJcblxyXG4gIC8qIFB1YmxpYyBpbnRlcmZhY2UgYmVsb3cgKi9cclxuXHJcbiAgLypcclxuICBuYW1lKClcclxuICBHZXQgYmFja2VuZCBuYW1lXHJcblxyXG4gIFJldHVybnMgU3RyaW5nLCB1bmlxdWUgc3RyaW5nIGRlc2NyaWJpbmcgYSBnaXZlbiBiYWNrZW5kXHJcbiAgKi9cclxuICBwdWJsaWMgbmFtZSgpIHsgcmV0dXJuICdhdG9tLWhhc2tlbGwtaHNkZXYnIH1cclxuXHJcbiAgLypcclxuICBvbkRpZERlc3Ryb3koY2FsbGJhY2spXHJcbiAgRGVzdHJ1Y3Rpb24gZXZlbnQgc3Vic2NyaXB0aW9uLiBVc3VhbGx5IHNob3VsZCBiZSBjYWxsZWQgb25seSBvblxyXG4gIHBhY2thZ2UgZGVhY3RpdmF0aW9uLlxyXG4gIGNhbGxiYWNrOiAoKSAtPlxyXG4gICovXHJcbiAgcHVibGljIG9uRGlkRGVzdHJveShjYWxsYmFjazogKCkgPT4gdm9pZCkge1xyXG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7IHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpIH1cclxuICAgIHJldHVybiB0aGlzLnByb2Nlc3Mub25EaWREZXN0cm95KGNhbGxiYWNrKVxyXG4gIH1cclxuXHJcbiAgLypcclxuICByZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyKVxyXG4gIEV2ZXJ5IGJ1ZmZlciB0aGF0IHdvdWxkIGJlIHVzZWQgd2l0aCBhdXRvY29tcGxldGlvbiBmdW5jdGlvbnMgaGFzIHRvXHJcbiAgYmUgcmVnaXN0ZXJlZCB3aXRoIHRoaXMgZnVuY3Rpb24uXHJcblxyXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRvIGJlIHVzZWQgaW4gYXV0b2NvbXBsZXRpb25cclxuXHJcbiAgUmV0dXJuczogRGlzcG9zYWJsZSwgd2hpY2ggd2lsbCByZW1vdmUgYnVmZmVyIGZyb20gYXV0b2NvbXBsZXRpb25cclxuICAqL1xyXG4gIHB1YmxpYyByZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XHJcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHsgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJykgfVxyXG5cclxuICAgIGlmICh0aGlzLmJ1ZmZlck1hcC5oYXMoYnVmZmVyKSkge1xyXG4gICAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4geyAvKiB2b2lkICovIH0pXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyBidWZmZXJJbmZvIH0gPSB0aGlzLmdldEJ1ZmZlckluZm8oeyBidWZmZXIgfSlcclxuXHJcbiAgICBzZXRJbW1lZGlhdGUoYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB7IHJvb3REaXIsIG1vZHVsZU1hcCB9ID0gYXdhaXQgdGhpcy5nZXRNb2R1bGVNYXAoeyBidWZmZXJJbmZvIH0pXHJcblxyXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcclxuICAgICAgdGhpcy5nZXRNb2R1bGVJbmZvKHsgYnVmZmVySW5mbywgcm9vdERpciwgbW9kdWxlTWFwIH0pXHJcblxyXG4gICAgICBjb25zdCBpbXBvcnRzID0gYXdhaXQgYnVmZmVySW5mby5nZXRJbXBvcnRzKClcclxuICAgICAgZm9yIChjb25zdCBpbXBydCBvZiBpbXBvcnRzKSB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXHJcbiAgICAgICAgdGhpcy5nZXRNb2R1bGVJbmZvKHsgbW9kdWxlTmFtZTogaW1wcnQubmFtZSwgYnVmZmVySW5mbywgcm9vdERpciwgbW9kdWxlTWFwIH0pXHJcbiAgICAgIH1cclxuICAgIH0pXHJcblxyXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+XHJcbiAgICAgIHRoaXMudW5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyKSlcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgdW5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyKVxyXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRvIGJlIHJlbW92ZWQgZnJvbSBhdXRvY29tcGxldGlvblxyXG4gICovXHJcbiAgcHVibGljIHVucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xyXG4gICAgY29uc3QgeCA9IHRoaXMuYnVmZmVyTWFwLmdldChidWZmZXIpXHJcbiAgICBpZiAoeCkge1xyXG4gICAgICB4LmRlc3Ryb3koKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLypcclxuICBnZXRDb21wbGV0aW9uc0ZvclN5bWJvbChidWZmZXIscHJlZml4LHBvc2l0aW9uKVxyXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcclxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXHJcblxyXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXHJcbiAgc3ltYm9sOiBPYmplY3QsIGEgY29tcGxldGlvbiBzeW1ib2xcclxuICAgIG5hbWU6IFN0cmluZywgc3ltYm9sIG5hbWVcclxuICAgIHFuYW1lOiBTdHJpbmcsIHF1YWxpZmllZCBuYW1lLCBpZiBtb2R1bGUgaXMgcXVhbGlmaWVkLlxyXG4gICAgICAgICAgIE90aGVyd2lzZSwgc2FtZSBhcyBuYW1lXHJcbiAgICB0eXBlU2lnbmF0dXJlOiBTdHJpbmcsIHR5cGUgc2lnbmF0dXJlXHJcbiAgICBzeW1ib2xUeXBlOiBTdHJpbmcsIG9uZSBvZiBbJ3R5cGUnLCAnY2xhc3MnLCAnZnVuY3Rpb24nXVxyXG4gICAgbW9kdWxlOiBPYmplY3QsIHN5bWJvbCBtb2R1bGUgaW5mb3JtYXRpb25cclxuICAgICAgcXVhbGlmaWVkOiBCb29sZWFuLCB0cnVlIGlmIG1vZHVsZSBpcyBpbXBvcnRlZCBhcyBxdWFsaWZpZWRcclxuICAgICAgbmFtZTogU3RyaW5nLCBtb2R1bGUgbmFtZVxyXG4gICAgICBhbGlhczogU3RyaW5nLCBtb2R1bGUgYWxpYXNcclxuICAgICAgaGlkaW5nOiBCb29sZWFuLCB0cnVlIGlmIG1vZHVsZSBpcyBpbXBvcnRlZCB3aXRoIGhpZGluZyBjbGF1c2VcclxuICAgICAgaW1wb3J0TGlzdDogW1N0cmluZ10sIGFycmF5IG9mIGV4cGxpY2l0IGltcG9ydHMvaGlkZGVuIGltcG9ydHNcclxuICAqL1xyXG4gIEBoYW5kbGVFeGNlcHRpb25cclxuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2woXHJcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBfcG9zaXRpb246IFBvaW50LFxyXG4gICk6IFByb21pc2U8Q0IuSVN5bWJvbFtdPiB7XHJcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHsgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJykgfVxyXG5cclxuICAgIGNvbnN0IHN5bWJvbHMgPSBhd2FpdCB0aGlzLmdldFN5bWJvbHNGb3JCdWZmZXIoYnVmZmVyKVxyXG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyKHN5bWJvbHMsIHByZWZpeCwgWydxbmFtZScsICdxcGFyZW50J10pXHJcbiAgfVxyXG5cclxuICAvKlxyXG4gIGdldENvbXBsZXRpb25zRm9yVHlwZShidWZmZXIscHJlZml4LHBvc2l0aW9uKVxyXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcclxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXHJcblxyXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXHJcbiAgc3ltYm9sOiBTYW1lIGFzIGdldENvbXBsZXRpb25zRm9yU3ltYm9sLCBleGNlcHRcclxuICAgICAgICAgIHN5bWJvbFR5cGUgaXMgb25lIG9mIFsndHlwZScsICdjbGFzcyddXHJcbiAgKi9cclxuICBAaGFuZGxlRXhjZXB0aW9uXHJcbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yVHlwZShcclxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIF9wb3NpdGlvbjogUG9pbnQsXHJcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcclxuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XHJcblxyXG4gICAgY29uc3Qgc3ltYm9scyA9IGF3YWl0IHRoaXMuZ2V0U3ltYm9sc0ZvckJ1ZmZlcihidWZmZXIsIFsndHlwZScsICdjbGFzcyddKVxyXG4gICAgcmV0dXJuIEZaLmZpbHRlcihzeW1ib2xzLCBwcmVmaXgsIHsga2V5OiAncW5hbWUnIH0pXHJcbiAgfVxyXG5cclxuICAvKlxyXG4gIGdldENvbXBsZXRpb25zRm9yQ2xhc3MoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcclxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXHJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XHJcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxyXG5cclxuICBSZXR1cm5zOiBQcm9taXNlKFtzeW1ib2xdKVxyXG4gIHN5bWJvbDogU2FtZSBhcyBnZXRDb21wbGV0aW9uc0ZvclN5bWJvbCwgZXhjZXB0XHJcbiAgICAgICAgICBzeW1ib2xUeXBlIGlzIG9uZSBvZiBbJ2NsYXNzJ11cclxuICAqL1xyXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0ZvckNsYXNzKFxyXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBwcmVmaXg6IHN0cmluZywgX3Bvc2l0aW9uOiBQb2ludCxcclxuICApOiBQcm9taXNlPENCLklTeW1ib2xbXT4ge1xyXG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7IHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpIH1cclxuXHJcbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgdGhpcy5nZXRTeW1ib2xzRm9yQnVmZmVyKGJ1ZmZlciwgWydjbGFzcyddKVxyXG4gICAgcmV0dXJuIEZaLmZpbHRlcihzeW1ib2xzLCBwcmVmaXgsIHsga2V5OiAncW5hbWUnIH0pXHJcbiAgfVxyXG5cclxuICAvKlxyXG4gIGdldENvbXBsZXRpb25zRm9yTW9kdWxlKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXHJcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxyXG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cclxuXHJcbiAgUmV0dXJuczogUHJvbWlzZShbbW9kdWxlXSlcclxuICBtb2R1bGU6IFN0cmluZywgbW9kdWxlIG5hbWVcclxuICAqL1xyXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0Zvck1vZHVsZShcclxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIF9wb3NpdGlvbjogUG9pbnQsXHJcbiAgKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xyXG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7IHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpIH1cclxuICAgIGNvbnN0IHJvb3REaXIgPSBhd2FpdCB0aGlzLnByb2Nlc3MuZ2V0Um9vdERpcihidWZmZXIpXHJcbiAgICBsZXQgbW9kdWxlcyA9IHRoaXMubW9kTGlzdE1hcC5nZXQocm9vdERpcilcclxuICAgIGlmICghbW9kdWxlcykge1xyXG4gICAgICBtb2R1bGVzID0gYXdhaXQgdGhpcy5wcm9jZXNzLnJ1bkxpc3QoYnVmZmVyKVxyXG4gICAgICB0aGlzLm1vZExpc3RNYXAuc2V0KHJvb3REaXIsIG1vZHVsZXMpXHJcbiAgICAgIC8vIHJlZnJlc2ggZXZlcnkgbWludXRlXHJcbiAgICAgIHNldFRpbWVvdXQoKCgpID0+IHRoaXMubW9kTGlzdE1hcC5kZWxldGUocm9vdERpcikpLCA2MCAqIDEwMDApXHJcbiAgICB9XHJcbiAgICByZXR1cm4gRlouZmlsdGVyKG1vZHVsZXMsIHByZWZpeClcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZShidWZmZXIscHJlZml4LHBvc2l0aW9uLHttb2R1bGV9KVxyXG4gIFVzZWQgaW4gaW1wb3J0IGhpZGluZy9saXN0IGNvbXBsZXRpb25zXHJcblxyXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcclxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXHJcbiAgbW9kdWxlOiBTdHJpbmcsIG1vZHVsZSBuYW1lIChvcHRpb25hbCkuIElmIHVuZGVmaW5lZCwgZnVuY3Rpb25cclxuICAgICAgICAgIHdpbGwgYXR0ZW1wdCB0byBpbmZlciBtb2R1bGUgbmFtZSBmcm9tIHBvc2l0aW9uIGFuZCBidWZmZXIuXHJcblxyXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXHJcbiAgc3ltYm9sOiBPYmplY3QsIHN5bWJvbCBpbiBnaXZlbiBtb2R1bGVcclxuICAgIG5hbWU6IFN0cmluZywgc3ltYm9sIG5hbWVcclxuICAgIHR5cGVTaWduYXR1cmU6IFN0cmluZywgdHlwZSBzaWduYXR1cmVcclxuICAgIHN5bWJvbFR5cGU6IFN0cmluZywgb25lIG9mIFsndHlwZScsICdjbGFzcycsICdmdW5jdGlvbiddXHJcbiAgKi9cclxuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZShcclxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIHBvc2l0aW9uOiBQb2ludCxcclxuICAgIG9wdHM/OiB7IG1vZHVsZTogc3RyaW5nIH0sXHJcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcclxuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XHJcbiAgICBsZXQgbW9kdWxlTmFtZSA9IG9wdHMgPyBvcHRzLm1vZHVsZSA6IHVuZGVmaW5lZFxyXG4gICAgaWYgKCFtb2R1bGVOYW1lKSB7XHJcbiAgICAgIGNvbnN0IGxpbmVSYW5nZSA9IG5ldyBSYW5nZShbMCwgcG9zaXRpb24ucm93XSwgcG9zaXRpb24pXHJcbiAgICAgIGJ1ZmZlci5iYWNrd2FyZHNTY2FuSW5SYW5nZShcclxuICAgICAgICAvXmltcG9ydFxccysoW1xcdy5dKykvLFxyXG4gICAgICAgIGxpbmVSYW5nZSwgKHsgbWF0Y2ggfSkgPT4gbW9kdWxlTmFtZSA9IG1hdGNoWzFdLFxyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyBidWZmZXJJbmZvIH0gPSB0aGlzLmdldEJ1ZmZlckluZm8oeyBidWZmZXIgfSlcclxuICAgIGNvbnN0IG1pcyA9IGF3YWl0IHRoaXMuZ2V0TW9kdWxlSW5mbyh7IGJ1ZmZlckluZm8sIG1vZHVsZU5hbWUgfSlcclxuXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZTogbm8tbnVsbC1rZXl3b3JkXHJcbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgbWlzLm1vZHVsZUluZm8uc2VsZWN0KFxyXG4gICAgICB7XHJcbiAgICAgICAgcXVhbGlmaWVkOiBmYWxzZSxcclxuICAgICAgICBoaWRpbmc6IGZhbHNlLFxyXG4gICAgICAgIG5hbWU6IG1vZHVsZU5hbWUgfHwgbWlzLm1vZHVsZU5hbWUsXHJcbiAgICAgICAgaW1wb3J0TGlzdDogbnVsbCxcclxuICAgICAgICBhbGlhczogbnVsbCxcclxuICAgICAgfSxcclxuICAgICAgdW5kZWZpbmVkLFxyXG4gICAgICB0cnVlLFxyXG4gICAgKVxyXG4gICAgLy8gdHNsaW50OmVuYWJsZTogbm8tbnVsbC1rZXl3b3JkXHJcbiAgICByZXR1cm4gRlouZmlsdGVyKHN5bWJvbHMsIHByZWZpeCwgeyBrZXk6ICduYW1lJyB9KVxyXG4gIH1cclxuXHJcbiAgLypcclxuICBnZXRDb21wbGV0aW9uc0Zvckxhbmd1YWdlUHJhZ21hcyhidWZmZXIscHJlZml4LHBvc2l0aW9uKVxyXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcclxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXHJcblxyXG4gIFJldHVybnM6IFByb21pc2UoW3ByYWdtYV0pXHJcbiAgcHJhZ21hOiBTdHJpbmcsIGxhbmd1YWdlIG9wdGlvblxyXG4gICovXHJcbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yTGFuZ3VhZ2VQcmFnbWFzKFxyXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBwcmVmaXg6IHN0cmluZywgX3Bvc2l0aW9uOiBQb2ludCxcclxuICApOiBQcm9taXNlPHN0cmluZ1tdPiB7XHJcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHsgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJykgfVxyXG5cclxuICAgIGNvbnN0IGRpciA9IGF3YWl0IHRoaXMucHJvY2Vzcy5nZXRSb290RGlyKGJ1ZmZlcilcclxuXHJcbiAgICBsZXQgcHMgPSB0aGlzLmxhbmd1YWdlUHJhZ21hcy5nZXQoZGlyKVxyXG4gICAgaWYgKCFwcykge1xyXG4gICAgICBwcyA9IGF3YWl0IHRoaXMucHJvY2Vzcy5ydW5MYW5nKGRpcilcclxuICAgICAgcHMgJiYgdGhpcy5sYW5ndWFnZVByYWdtYXMuc2V0KGRpciwgcHMpXHJcbiAgICB9XHJcbiAgICByZXR1cm4gRlouZmlsdGVyKHBzLCBwcmVmaXgpXHJcbiAgfVxyXG5cclxuICAvKlxyXG4gIGdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXHJcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxyXG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cclxuXHJcbiAgUmV0dXJuczogUHJvbWlzZShbZ2hjb3B0XSlcclxuICBnaGNvcHQ6IFN0cmluZywgY29tcGlsZXIgb3B0aW9uIChzdGFydHMgd2l0aCAnLWYnKVxyXG4gICovXHJcbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zKFxyXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBwcmVmaXg6IHN0cmluZywgX3Bvc2l0aW9uOiBQb2ludCxcclxuICApOiBQcm9taXNlPHN0cmluZ1tdPiB7XHJcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHsgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJykgfVxyXG5cclxuICAgIGNvbnN0IGRpciA9IGF3YWl0IHRoaXMucHJvY2Vzcy5nZXRSb290RGlyKGJ1ZmZlcilcclxuXHJcbiAgICBsZXQgY28gPSB0aGlzLmNvbXBpbGVyT3B0aW9ucy5nZXQoZGlyKVxyXG4gICAgaWYgKCFjbykge1xyXG4gICAgICBjbyA9IGF3YWl0IHRoaXMucHJvY2Vzcy5ydW5GbGFnKGRpcilcclxuICAgICAgdGhpcy5jb21waWxlck9wdGlvbnMuc2V0KGRpciwgY28pXHJcbiAgICB9XHJcbiAgICByZXR1cm4gRlouZmlsdGVyKGNvLCBwcmVmaXgpXHJcbiAgfVxyXG5cclxuICAvKlxyXG4gIGdldENvbXBsZXRpb25zRm9ySG9sZShidWZmZXIscHJlZml4LHBvc2l0aW9uKVxyXG4gIEdldCBjb21wbGV0aW9ucyBiYXNlZCBvbiBleHByZXNzaW9uIHR5cGUuXHJcbiAgSXQgaXMgYXNzdW1lZCB0aGF0IGBwcmVmaXhgIHN0YXJ0cyB3aXRoICdfJ1xyXG5cclxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXHJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XHJcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxyXG5cclxuICBSZXR1cm5zOiBQcm9taXNlKFtzeW1ib2xdKVxyXG4gIHN5bWJvbDogU2FtZSBhcyBnZXRDb21wbGV0aW9uc0ZvclN5bWJvbFxyXG4gICovXHJcbiAgQGhhbmRsZUV4Y2VwdGlvblxyXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0ZvckhvbGUoXHJcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBwb3NpdGlvbjogUG9pbnQsXHJcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcclxuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XHJcbiAgICBjb25zdCByYW5nZSA9IG5ldyBSYW5nZShwb3NpdGlvbiwgcG9zaXRpb24pXHJcbiAgICBpZiAocHJlZml4LnN0YXJ0c1dpdGgoJ18nKSkgeyBwcmVmaXggPSBwcmVmaXguc2xpY2UoMSkgfVxyXG4gICAgY29uc3QgeyB0eXBlIH0gPSBhd2FpdCB0aGlzLnByb2Nlc3MuZ2V0VHlwZUluQnVmZmVyKGJ1ZmZlciwgcmFuZ2UpXHJcbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgdGhpcy5nZXRTeW1ib2xzRm9yQnVmZmVyKGJ1ZmZlcilcclxuICAgIGNvbnN0IHRzID0gc3ltYm9scy5maWx0ZXIoKHMpID0+IHtcclxuICAgICAgaWYgKCFzLnR5cGVTaWduYXR1cmUpIHsgcmV0dXJuIGZhbHNlIH1cclxuICAgICAgY29uc3QgdGwgPSBzLnR5cGVTaWduYXR1cmUuc3BsaXQoJyAtPiAnKS5zbGljZSgtMSlbMF1cclxuICAgICAgaWYgKHRsLm1hdGNoKC9eW2Etel0kLykpIHsgcmV0dXJuIGZhbHNlIH1cclxuICAgICAgY29uc3QgdHMyID0gdGwucmVwbGFjZSgvWy4/KiteJFtcXF1cXFxcKCl7fXwtXS9nLCAnXFxcXCQmJylcclxuICAgICAgY29uc3QgcnggPSBSZWdFeHAodHMyLnJlcGxhY2UoL1xcYlthLXpdXFxiL2csICcuKycpLCAnJylcclxuICAgICAgcmV0dXJuIHJ4LnRlc3QodHlwZSlcclxuICAgIH0pXHJcbiAgICBpZiAocHJlZml4Lmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICByZXR1cm4gdHMuc29ydCgoYSwgYikgPT4gRlouc2NvcmUoYi50eXBlU2lnbmF0dXJlISwgdHlwZSkgLSBGWi5zY29yZShhLnR5cGVTaWduYXR1cmUhLCB0eXBlKSlcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBGWi5maWx0ZXIodHMsIHByZWZpeCwgeyBrZXk6ICdxbmFtZScgfSlcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgZ2V0U3ltYm9sc0ZvckJ1ZmZlcihcclxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgc3ltYm9sVHlwZXM/OiBDQi5TeW1ib2xUeXBlW10sXHJcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcclxuICAgIGNvbnN0IHsgYnVmZmVySW5mbyB9ID0gdGhpcy5nZXRCdWZmZXJJbmZvKHsgYnVmZmVyIH0pXHJcbiAgICBjb25zdCB7IHJvb3REaXIsIG1vZHVsZU1hcCB9ID0gYXdhaXQgdGhpcy5nZXRNb2R1bGVNYXAoeyBidWZmZXJJbmZvIH0pXHJcbiAgICBpZiAoYnVmZmVySW5mbyAmJiBtb2R1bGVNYXApIHtcclxuICAgICAgY29uc3QgaW1wb3J0cyA9IGF3YWl0IGJ1ZmZlckluZm8uZ2V0SW1wb3J0cygpXHJcbiAgICAgIGNvbnN0IHByb21pc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICAgICAgaW1wb3J0cy5tYXAoYXN5bmMgKGltcCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5nZXRNb2R1bGVJbmZvKHtcclxuICAgICAgICAgICAgYnVmZmVySW5mbyxcclxuICAgICAgICAgICAgbW9kdWxlTmFtZTogaW1wLm5hbWUsXHJcbiAgICAgICAgICAgIHJvb3REaXIsXHJcbiAgICAgICAgICAgIG1vZHVsZU1hcCxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICBpZiAoIXJlcykgeyByZXR1cm4gW10gfVxyXG4gICAgICAgICAgcmV0dXJuIHJlcy5tb2R1bGVJbmZvLnNlbGVjdChpbXAsIHN5bWJvbFR5cGVzKVxyXG4gICAgICAgIH0pLFxyXG4gICAgICApXHJcbiAgICAgIHJldHVybiAoW10gYXMgdHlwZW9mIHByb21pc2VzWzBdKS5jb25jYXQoLi4ucHJvbWlzZXMpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gW11cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0QnVmZmVySW5mbyh7IGJ1ZmZlciB9OiB7IGJ1ZmZlcjogVGV4dEJ1ZmZlciB9KTogeyBidWZmZXJJbmZvOiBCdWZmZXJJbmZvIH0ge1xyXG4gICAgbGV0IGJpID0gdGhpcy5idWZmZXJNYXAuZ2V0KGJ1ZmZlcilcclxuICAgIGlmICghYmkpIHtcclxuICAgICAgYmkgPSBuZXcgQnVmZmVySW5mbyhidWZmZXIpXHJcbiAgICAgIHRoaXMuYnVmZmVyTWFwLnNldChidWZmZXIsIGJpKVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHsgYnVmZmVySW5mbzogYmkgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRNb2R1bGVNYXAoXHJcbiAgICB7IGJ1ZmZlckluZm8sIHJvb3REaXIgfTogeyBidWZmZXJJbmZvOiBCdWZmZXJJbmZvLCByb290RGlyPzogRGlyZWN0b3J5IH0sXHJcbiAgKTogUHJvbWlzZTx7IHJvb3REaXI6IERpcmVjdG9yeSwgbW9kdWxlTWFwOiBNYXA8c3RyaW5nLCBNb2R1bGVJbmZvPiB9PiB7XHJcbiAgICBpZiAoIXJvb3REaXIpIHtcclxuICAgICAgcm9vdERpciA9IGF3YWl0IHRoaXMucHJvY2Vzcy5nZXRSb290RGlyKGJ1ZmZlckluZm8uYnVmZmVyKVxyXG4gICAgfVxyXG4gICAgbGV0IG1tID0gdGhpcy5kaXJNYXAuZ2V0KHJvb3REaXIpXHJcbiAgICBpZiAoIW1tKSB7XHJcbiAgICAgIG1tID0gbmV3IE1hcCgpXHJcbiAgICAgIHRoaXMuZGlyTWFwLnNldChyb290RGlyLCBtbSlcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICByb290RGlyLFxyXG4gICAgICBtb2R1bGVNYXA6IG1tLFxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRNb2R1bGVJbmZvKFxyXG4gICAgYXJnOiB7XHJcbiAgICAgIGJ1ZmZlckluZm86IEJ1ZmZlckluZm8sIG1vZHVsZU5hbWU/OiBzdHJpbmcsXHJcbiAgICAgIHJvb3REaXI/OiBEaXJlY3RvcnksIG1vZHVsZU1hcD86IE1hcDxzdHJpbmcsIE1vZHVsZUluZm8+XHJcbiAgICB9LFxyXG4gICkge1xyXG4gICAgY29uc3QgeyBidWZmZXJJbmZvIH0gPSBhcmdcclxuICAgIGxldCBkYXRcclxuICAgIGlmIChhcmcucm9vdERpciAmJiBhcmcubW9kdWxlTWFwKSB7XHJcbiAgICAgIGRhdCA9IHsgcm9vdERpcjogYXJnLnJvb3REaXIsIG1vZHVsZU1hcDogYXJnLm1vZHVsZU1hcCB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBkYXQgPSBhd2FpdCB0aGlzLmdldE1vZHVsZU1hcCh7IGJ1ZmZlckluZm8gfSlcclxuICAgIH1cclxuICAgIGNvbnN0IHsgbW9kdWxlTWFwLCByb290RGlyIH0gPSBkYXRcclxuICAgIGxldCBtb2R1bGVOYW1lID0gYXJnLm1vZHVsZU5hbWVcclxuICAgIGlmICghbW9kdWxlTmFtZSkge1xyXG4gICAgICBtb2R1bGVOYW1lID0gYXdhaXQgYnVmZmVySW5mby5nZXRNb2R1bGVOYW1lKClcclxuICAgIH1cclxuICAgIGlmICghbW9kdWxlTmFtZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5hbWVsZXNzIG1vZHVsZSBpbiAke2J1ZmZlckluZm8uYnVmZmVyLmdldFVyaSgpfWApXHJcbiAgICB9XHJcblxyXG4gICAgbGV0IG1vZHVsZUluZm8gPSBtb2R1bGVNYXAuZ2V0KG1vZHVsZU5hbWUpXHJcbiAgICBpZiAoIW1vZHVsZUluZm8pIHtcclxuICAgICAgbW9kdWxlSW5mbyA9IG5ldyBNb2R1bGVJbmZvKG1vZHVsZU5hbWUsIHRoaXMucHJvY2Vzcywgcm9vdERpcilcclxuICAgICAgbW9kdWxlTWFwLnNldChtb2R1bGVOYW1lLCBtb2R1bGVJbmZvKVxyXG5cclxuICAgICAgY29uc3QgbW4gPSBtb2R1bGVOYW1lXHJcbiAgICAgIG1vZHVsZUluZm8ub25EaWREZXN0cm95KCgpID0+IHtcclxuICAgICAgICBtb2R1bGVNYXAuZGVsZXRlKG1uKVxyXG4gICAgICAgIFV0aWwuZGVidWcoYCR7bW9kdWxlTmFtZX0gcmVtb3ZlZCBmcm9tIG1hcGApXHJcbiAgICAgIH0pXHJcbiAgICB9XHJcbiAgICBhd2FpdCBtb2R1bGVJbmZvLnNldEJ1ZmZlcihidWZmZXJJbmZvKVxyXG4gICAgcmV0dXJuIHsgYnVmZmVySW5mbywgcm9vdERpciwgbW9kdWxlTWFwLCBtb2R1bGVJbmZvLCBtb2R1bGVOYW1lIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZmlsdGVyPFQsIEsgZXh0ZW5kcyBrZXlvZiBUPihjYW5kaWRhdGVzOiBUW10sIHByZWZpeDogc3RyaW5nLCBrZXlzOiBLW10pOiBUW10ge1xyXG4gICAgaWYgKCFwcmVmaXgpIHtcclxuICAgICAgcmV0dXJuIGNhbmRpZGF0ZXNcclxuICAgIH1cclxuICAgIGNvbnN0IGxpc3QgPSBbXVxyXG4gICAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykge1xyXG4gICAgICBjb25zdCBzY29yZXMgPSBrZXlzLm1hcCgoa2V5KSA9PiB7XHJcbiAgICAgICAgY29uc3QgY2sgPSBjYW5kaWRhdGVba2V5XVxyXG4gICAgICAgIGlmIChjaykge1xyXG4gICAgICAgICAgcmV0dXJuIEZaLnNjb3JlKGNrLnRvU3RyaW5nKCksIHByZWZpeClcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIDBcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgIGNvbnN0IHNjb3JlID0gTWF0aC5tYXgoLi4uc2NvcmVzKVxyXG4gICAgICBpZiAoc2NvcmUgPiAwKSB7XHJcbiAgICAgICAgbGlzdC5wdXNoKHtcclxuICAgICAgICAgIHNjb3JlLFxyXG4gICAgICAgICAgc2NvcmVOOiBzY29yZXMuaW5kZXhPZihzY29yZSksXHJcbiAgICAgICAgICBkYXRhOiBjYW5kaWRhdGUsXHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGxpc3Quc29ydCgoYSwgYikgPT4ge1xyXG4gICAgICBjb25zdCBzID0gYi5zY29yZSAtIGEuc2NvcmVcclxuICAgICAgaWYgKHMgPT09IDApIHtcclxuICAgICAgICByZXR1cm4gYS5zY29yZU4gLSBiLnNjb3JlTlxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBzXHJcbiAgICB9KS5tYXAoKHsgZGF0YSB9KSA9PiBkYXRhKVxyXG4gIH1cclxufVxyXG4iXX0=