"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const FZ = require("fuzzaldrin");
const atom_1 = require("atom");
const buffer_info_1 = require("./buffer-info");
const Util = require("../util");
const { handleException } = Util;
class CompletionBackend {
    constructor(process, upi) {
        this.process = process;
        this.upi = upi;
        this.bufferMap = new WeakMap();
        this.name = this.name.bind(this);
        this.onDidDestroy = this.onDidDestroy.bind(this);
        this.registerCompletionBuffer = this.registerCompletionBuffer.bind(this);
        this.unregisterCompletionBuffer = this.unregisterCompletionBuffer.bind(this);
        this.getCompletionsForSymbol = this.getCompletionsForSymbol.bind(this);
        this.getCompletionsForType = this.getCompletionsForType.bind(this);
        this.getCompletionsForClass = this.getCompletionsForClass.bind(this);
        this.getCompletionsForModule = this.getCompletionsForModule.bind(this);
        this.getCompletionsForSymbolInModule = this.getCompletionsForSymbolInModule.bind(this);
        this.getCompletionsForLanguagePragmas = this.getCompletionsForLanguagePragmas.bind(this);
        this.getCompletionsForCompilerOptions = this.getCompletionsForCompilerOptions.bind(this);
        this.getCompletionsForHole = this.getCompletionsForHole.bind(this);
        this.process = process;
        this.isActive = true;
        this.process.onDidDestroy(() => { this.isActive = false; });
    }
    name() { return 'atom-haskell-hsdev'; }
    onDidDestroy(callback) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        return this.process.onDidDestroy(callback);
    }
    registerCompletionBuffer(buffer) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        if (this.bufferMap.has(buffer)) {
            return new atom_1.Disposable(() => { });
        }
        this.bufferMap.set(buffer, new buffer_info_1.BufferInfo(buffer));
        const file = buffer.getUri();
        buffer.onDidSave(async (_event) => {
            const buf = this.bufferMap.get(buffer);
            if (buf) {
                delete buf.completions;
            }
            const contents = buffer.getText();
            await this.process.backend.setFileContents(file, contents);
            await this.process.backend.scanFile({ file, scanProject: false, scanDeps: false });
        });
        setImmediate(async () => {
            this.process.backend.scanFile({ file });
        });
        return new atom_1.Disposable(() => this.unregisterCompletionBuffer(buffer));
    }
    unregisterCompletionBuffer(buffer) {
        const x = this.bufferMap.get(buffer);
        if (x) {
            x.destroy();
        }
    }
    async getCompletionsForSymbol(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getCompletionsForBuffer(buffer);
        return this.filter(symbols, prefix, ['qname', 'qparent']);
    }
    async getCompletionsForType(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getCompletionsForBuffer(buffer, ['type', 'class']);
        return FZ.filter(symbols, prefix, { key: 'qname' });
    }
    async getCompletionsForClass(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getCompletionsForBuffer(buffer, ['class']);
        return FZ.filter(symbols, prefix, { key: 'qname' });
    }
    async getCompletionsForModule(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const modules = await this.process.backend.scopeModules({
            query: prefix,
            searchType: 'prefix',
            file: buffer.getUri(),
        });
        const parts = prefix.split('.').length;
        const names = [];
        for (const m of modules) {
            if (m.name.split('.').length == parts) {
                names.push(m.name);
            }
        }
        return names;
    }
    async getCompletionsForSymbolInModule(buffer, prefix, position, opts) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        let moduleName = opts ? opts.module : undefined;
        if (!moduleName) {
            const lineRange = new atom_1.Range([0, position.row], position);
            buffer.backwardsScanInRange(/^import\s+([\w.]+)/, lineRange, ({ match }) => moduleName = match[1]);
        }
        return [];
    }
    async getCompletionsForLanguagePragmas(_buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const ps = await this.process.backend.langs();
        return FZ.filter(ps, prefix);
    }
    async getCompletionsForCompilerOptions(_buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const co = await this.process.backend.flags();
        return FZ.filter(co, prefix);
    }
    async getCompletionsForHole(_buffer, _prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        return [];
    }
    async getCompletionsForBuffer(buffer, symbolTypes) {
        let symbols = [];
        const buf = this.bufferMap.get(buffer);
        if (buf && buf.completions) {
            symbols = buf.completions;
        }
        else {
            const comps = await this.process.backend.complete('', buffer.getUri());
            for (const comp of comps) {
                let symType = 'function';
                switch (comp.info.what) {
                    case 'function':
                    case 'method':
                    case 'selector':
                    case 'pat-selector':
                    case 'pat-constructor':
                    case 'constructor':
                        symType = 'function';
                        break;
                    case 'type':
                    case 'newtype':
                    case 'data':
                    case 'type-family':
                    case 'data-family':
                        symType = 'type';
                        break;
                    case 'class':
                        symType = 'class';
                        break;
                    default:
                        break;
                }
                if (symbolTypes && !(symType in symbolTypes)) {
                    continue;
                }
                symbols.push({
                    qparent: comp.qualifier,
                    qname: comp.qualifier ? `${comp.qualifier}.${comp.id.name}` : comp.id.name,
                    name: comp.id.name,
                    symbolType: symType,
                    typeSignature: comp.info.type,
                    module: {
                        name: comp.id.module.name,
                        hiding: false,
                        qualified: false,
                        alias: null,
                        importList: null,
                    }
                });
            }
            if (buf) {
                Util.debug(`Caching ${symbols.length} completions`);
                buf.completions = symbols;
            }
        }
        if (!symbolTypes) {
            return symbols;
        }
        const result = [];
        for (const sym of symbols) {
            if (sym.symbolType in symbolTypes) {
                result.push(sym);
            }
        }
        return result;
    }
    filter(candidates, prefix, keys) {
        if (!prefix) {
            return candidates;
        }
        const list = [];
        for (const candidate of candidates) {
            const scores = keys.map((key) => {
                const ck = candidate[key];
                if (ck) {
                    return FZ.score(ck.toString(), prefix);
                }
                else {
                    return 0;
                }
            });
            const score = Math.max(...scores);
            if (score > 0) {
                list.push({
                    score,
                    scoreN: scores.indexOf(score),
                    data: candidate,
                });
            }
        }
        return list.sort((a, b) => {
            const s = b.score - a.score;
            if (s === 0) {
                return a.scoreN - b.scoreN;
            }
            return s;
        }).map(({ data }) => data);
    }
}
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [typeof (_a = typeof atom_1.TextBuffer !== "undefined" && atom_1.TextBuffer) === "function" && _a || Object, String, typeof (_b = typeof atom_1.Point !== "undefined" && atom_1.Point) === "function" && _b || Object]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForSymbol", null);
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [typeof (_c = typeof atom_1.TextBuffer !== "undefined" && atom_1.TextBuffer) === "function" && _c || Object, String, typeof (_d = typeof atom_1.Point !== "undefined" && atom_1.Point) === "function" && _d || Object]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForType", null);
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [typeof (_e = typeof atom_1.TextBuffer !== "undefined" && atom_1.TextBuffer) === "function" && _e || Object, String, typeof (_f = typeof atom_1.Point !== "undefined" && atom_1.Point) === "function" && _f || Object]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForHole", null);
exports.CompletionBackend = CompletionBackend;
var _a, _b, _c, _d, _e, _f;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tcGxldGlvbi1iYWNrZW5kL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUFnQztBQUNoQywrQkFFYTtBQUNiLCtDQUEwQztBQUcxQyxnQ0FBK0I7QUFJL0IsTUFBTSxFQUFFLGVBQWUsRUFBRSxHQUFHLElBQUksQ0FBQTtBQUdoQztJQUlFLFlBQW9CLE9BQXFCLEVBQVMsR0FBOEI7UUFBNUQsWUFBTyxHQUFQLE9BQU8sQ0FBYztRQUFTLFFBQUcsR0FBSCxHQUFHLENBQTJCO1FBQzlFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUc5QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDaEQsSUFBSSxDQUFDLHdCQUF3QixHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDeEUsSUFBSSxDQUFDLDBCQUEwQixHQUFHLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUUsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDdEUsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDbEUsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDcEUsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FB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Q0FBQztnQkFDWixNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFBO1lBQzVCLENBQUM7WUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFBO1FBQ1YsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDNUIsQ0FBQztDQUNGO0FBL1FDO0lBREMsZUFBZTs7aUVBRU4saUJBQVUsb0JBQVYsaUJBQVUsOERBQTZCLFlBQUssb0JBQUwsWUFBSzs7Z0VBTXJEO0FBYUQ7SUFEQyxlQUFlOztpRUFFTixpQkFBVSxvQkFBVixpQkFBVSw4REFBNkIsWUFBSyxvQkFBTCxZQUFLOzs4REFNckQ7QUFtSUQ7SUFEQyxlQUFlOztpRUFFTCxpQkFBVSxvQkFBVixpQkFBVSw4REFBOEIsWUFBSyxvQkFBTCxZQUFLOzs4REFJdkQ7QUF2UkgsOENBbVlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgRlogZnJvbSAnZnV6emFsZHJpbidcclxuaW1wb3J0IHtcclxuICBUZXh0QnVmZmVyLCBQb2ludCwgRGlzcG9zYWJsZSwgUmFuZ2UsIERpcmVjdG9yeVxyXG59IGZyb20gJ2F0b20nXHJcbmltcG9ydCB7IEJ1ZmZlckluZm8gfSBmcm9tICcuL2J1ZmZlci1pbmZvJ1xyXG5pbXBvcnQgeyBNb2R1bGVJbmZvIH0gZnJvbSAnLi9tb2R1bGUtaW5mbydcclxuaW1wb3J0IHsgSHNEZXZQcm9jZXNzIH0gZnJvbSAnLi4vaHNkZXYnXHJcbmltcG9ydCAqIGFzIFV0aWwgZnJvbSAnLi4vdXRpbCdcclxuaW1wb3J0ICogYXMgVVBJIGZyb20gJ2F0b20taGFza2VsbC11cGknXHJcbmltcG9ydCAqIGFzIENCIGZyb20gJ2F0b20taGFza2VsbC11cGkvY29tcGxldGlvbi1iYWNrZW5kJ1xyXG5cclxuY29uc3QgeyBoYW5kbGVFeGNlcHRpb24gfSA9IFV0aWxcclxuXHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bnNhZmUtYW55XHJcbmV4cG9ydCBjbGFzcyBDb21wbGV0aW9uQmFja2VuZCBpbXBsZW1lbnRzIENCLklDb21wbGV0aW9uQmFja2VuZCB7XHJcbiAgcHJpdmF0ZSBidWZmZXJNYXA6IFdlYWtNYXA8VGV4dEJ1ZmZlciwgQnVmZmVySW5mbz5cclxuICBwcml2YXRlIGlzQWN0aXZlOiBib29sZWFuXHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcHJvY2VzczogSHNEZXZQcm9jZXNzLCBwdWJsaWMgdXBpOiBQcm9taXNlPFVQSS5JVVBJSW5zdGFuY2U+KSB7XHJcbiAgICB0aGlzLmJ1ZmZlck1hcCA9IG5ldyBXZWFrTWFwKClcclxuXHJcbiAgICAvLyBjb21wYXRpYmlsaXR5IHdpdGggb2xkIGNsaWVudHNcclxuICAgIHRoaXMubmFtZSA9IHRoaXMubmFtZS5iaW5kKHRoaXMpXHJcbiAgICB0aGlzLm9uRGlkRGVzdHJveSA9IHRoaXMub25EaWREZXN0cm95LmJpbmQodGhpcylcclxuICAgIHRoaXMucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyID0gdGhpcy5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIuYmluZCh0aGlzKVxyXG4gICAgdGhpcy51bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlciA9IHRoaXMudW5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIuYmluZCh0aGlzKVxyXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbCA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2wuYmluZCh0aGlzKVxyXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0ZvclR5cGUgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yVHlwZS5iaW5kKHRoaXMpXHJcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9yQ2xhc3MgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yQ2xhc3MuYmluZCh0aGlzKVxyXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0Zvck1vZHVsZSA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUuYmluZCh0aGlzKVxyXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbEluTW9kdWxlID0gdGhpcy5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbEluTW9kdWxlLmJpbmQodGhpcylcclxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JMYW5ndWFnZVByYWdtYXMgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yTGFuZ3VhZ2VQcmFnbWFzLmJpbmQodGhpcylcclxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDb21waWxlck9wdGlvbnMgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zLmJpbmQodGhpcylcclxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JIb2xlID0gdGhpcy5nZXRDb21wbGV0aW9uc0ZvckhvbGUuYmluZCh0aGlzKVxyXG5cclxuICAgIHRoaXMucHJvY2VzcyA9IHByb2Nlc3NcclxuICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlXHJcbiAgICB0aGlzLnByb2Nlc3Mub25EaWREZXN0cm95KCgpID0+IHsgdGhpcy5pc0FjdGl2ZSA9IGZhbHNlIH0pXHJcbiAgfVxyXG5cclxuICAvKiBQdWJsaWMgaW50ZXJmYWNlIGJlbG93ICovXHJcblxyXG4gIC8qXHJcbiAgbmFtZSgpXHJcbiAgR2V0IGJhY2tlbmQgbmFtZVxyXG5cclxuICBSZXR1cm5zIFN0cmluZywgdW5pcXVlIHN0cmluZyBkZXNjcmliaW5nIGEgZ2l2ZW4gYmFja2VuZFxyXG4gICovXHJcbiAgcHVibGljIG5hbWUoKSB7IHJldHVybiAnYXRvbS1oYXNrZWxsLWhzZGV2JyB9XHJcblxyXG4gIC8qXHJcbiAgb25EaWREZXN0cm95KGNhbGxiYWNrKVxyXG4gIERlc3RydWN0aW9uIGV2ZW50IHN1YnNjcmlwdGlvbi4gVXN1YWxseSBzaG91bGQgYmUgY2FsbGVkIG9ubHkgb25cclxuICBwYWNrYWdlIGRlYWN0aXZhdGlvbi5cclxuICBjYWxsYmFjazogKCkgLT5cclxuICAqL1xyXG4gIHB1YmxpYyBvbkRpZERlc3Ryb3koY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcclxuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XHJcbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzLm9uRGlkRGVzdHJveShjYWxsYmFjaylcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgcmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyKGJ1ZmZlcilcclxuICBFdmVyeSBidWZmZXIgdGhhdCB3b3VsZCBiZSB1c2VkIHdpdGggYXV0b2NvbXBsZXRpb24gZnVuY3Rpb25zIGhhcyB0b1xyXG4gIGJlIHJlZ2lzdGVyZWQgd2l0aCB0aGlzIGZ1bmN0aW9uLlxyXG5cclxuICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0byBiZSB1c2VkIGluIGF1dG9jb21wbGV0aW9uXHJcblxyXG4gIFJldHVybnM6IERpc3Bvc2FibGUsIHdoaWNoIHdpbGwgcmVtb3ZlIGJ1ZmZlciBmcm9tIGF1dG9jb21wbGV0aW9uXHJcbiAgKi9cclxuICBwdWJsaWMgcmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xyXG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7IHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpIH1cclxuXHJcbiAgICBpZiAodGhpcy5idWZmZXJNYXAuaGFzKGJ1ZmZlcikpIHtcclxuICAgICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHsgLyogdm9pZCAqLyB9KVxyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYnVmZmVyTWFwLnNldChidWZmZXIsIG5ldyBCdWZmZXJJbmZvKGJ1ZmZlcikpXHJcblxyXG4gICAgY29uc3QgZmlsZSA9IGJ1ZmZlci5nZXRVcmkoKVxyXG4gICAgYnVmZmVyLm9uRGlkU2F2ZShhc3luYyAoX2V2ZW50KSA9PiB7XHJcbiAgICAgIGNvbnN0IGJ1ZjogQnVmZmVySW5mbyB8IHVuZGVmaW5lZCA9IHRoaXMuYnVmZmVyTWFwLmdldChidWZmZXIpXHJcbiAgICAgIGlmIChidWYpIHtcclxuICAgICAgICBkZWxldGUgYnVmLmNvbXBsZXRpb25zXHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgY29udGVudHM6IHN0cmluZyA9IGJ1ZmZlci5nZXRUZXh0KClcclxuICAgICAgYXdhaXQgdGhpcy5wcm9jZXNzLmJhY2tlbmQuc2V0RmlsZUNvbnRlbnRzKGZpbGUsIGNvbnRlbnRzKVxyXG4gICAgICBhd2FpdCB0aGlzLnByb2Nlc3MuYmFja2VuZC5zY2FuRmlsZSh7IGZpbGUsIHNjYW5Qcm9qZWN0OiBmYWxzZSwgc2NhbkRlcHM6IGZhbHNlIH0pXHJcbiAgICB9KVxyXG5cclxuICAgIHNldEltbWVkaWF0ZShhc3luYyAoKSA9PiB7XHJcbiAgICAgIHRoaXMucHJvY2Vzcy5iYWNrZW5kLnNjYW5GaWxlKHsgZmlsZSB9KVxyXG4gICAgfSlcclxuXHJcbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT5cclxuICAgICAgdGhpcy51bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlcihidWZmZXIpKVxyXG4gIH1cclxuXHJcbiAgLypcclxuICB1bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlcihidWZmZXIpXHJcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBidWZmZXIgdG8gYmUgcmVtb3ZlZCBmcm9tIGF1dG9jb21wbGV0aW9uXHJcbiAgKi9cclxuICBwdWJsaWMgdW5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XHJcbiAgICBjb25zdCB4ID0gdGhpcy5idWZmZXJNYXAuZ2V0KGJ1ZmZlcilcclxuICAgIGlmICh4KSB7XHJcbiAgICAgIHguZGVzdHJveSgpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKlxyXG4gIGdldENvbXBsZXRpb25zRm9yU3ltYm9sKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXHJcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxyXG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cclxuXHJcbiAgUmV0dXJuczogUHJvbWlzZShbc3ltYm9sXSlcclxuICBzeW1ib2w6IE9iamVjdCwgYSBjb21wbGV0aW9uIHN5bWJvbFxyXG4gICAgbmFtZTogU3RyaW5nLCBzeW1ib2wgbmFtZVxyXG4gICAgcW5hbWU6IFN0cmluZywgcXVhbGlmaWVkIG5hbWUsIGlmIG1vZHVsZSBpcyBxdWFsaWZpZWQuXHJcbiAgICAgICAgICAgT3RoZXJ3aXNlLCBzYW1lIGFzIG5hbWVcclxuICAgIHR5cGVTaWduYXR1cmU6IFN0cmluZywgdHlwZSBzaWduYXR1cmVcclxuICAgIHN5bWJvbFR5cGU6IFN0cmluZywgb25lIG9mIFsndHlwZScsICdjbGFzcycsICdmdW5jdGlvbiddXHJcbiAgICBtb2R1bGU6IE9iamVjdCwgc3ltYm9sIG1vZHVsZSBpbmZvcm1hdGlvblxyXG4gICAgICBxdWFsaWZpZWQ6IEJvb2xlYW4sIHRydWUgaWYgbW9kdWxlIGlzIGltcG9ydGVkIGFzIHF1YWxpZmllZFxyXG4gICAgICBuYW1lOiBTdHJpbmcsIG1vZHVsZSBuYW1lXHJcbiAgICAgIGFsaWFzOiBTdHJpbmcsIG1vZHVsZSBhbGlhc1xyXG4gICAgICBoaWRpbmc6IEJvb2xlYW4sIHRydWUgaWYgbW9kdWxlIGlzIGltcG9ydGVkIHdpdGggaGlkaW5nIGNsYXVzZVxyXG4gICAgICBpbXBvcnRMaXN0OiBbU3RyaW5nXSwgYXJyYXkgb2YgZXhwbGljaXQgaW1wb3J0cy9oaWRkZW4gaW1wb3J0c1xyXG4gICovXHJcbiAgQGhhbmRsZUV4Y2VwdGlvblxyXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0ZvclN5bWJvbChcclxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIF9wb3NpdGlvbjogUG9pbnQsXHJcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcclxuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XHJcblxyXG4gICAgY29uc3Qgc3ltYm9scyA9IGF3YWl0IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JCdWZmZXIoYnVmZmVyKVxyXG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyKHN5bWJvbHMsIHByZWZpeCwgWydxbmFtZScsICdxcGFyZW50J10pXHJcbiAgfVxyXG5cclxuICAvKlxyXG4gIGdldENvbXBsZXRpb25zRm9yVHlwZShidWZmZXIscHJlZml4LHBvc2l0aW9uKVxyXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcclxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXHJcblxyXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXHJcbiAgc3ltYm9sOiBTYW1lIGFzIGdldENvbXBsZXRpb25zRm9yU3ltYm9sLCBleGNlcHRcclxuICAgICAgICAgIHN5bWJvbFR5cGUgaXMgb25lIG9mIFsndHlwZScsICdjbGFzcyddXHJcbiAgKi9cclxuICBAaGFuZGxlRXhjZXB0aW9uXHJcbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yVHlwZShcclxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIF9wb3NpdGlvbjogUG9pbnQsXHJcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcclxuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XHJcblxyXG4gICAgY29uc3Qgc3ltYm9scyA9IGF3YWl0IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JCdWZmZXIoYnVmZmVyLCBbJ3R5cGUnLCAnY2xhc3MnXSlcclxuICAgIHJldHVybiBGWi5maWx0ZXIoc3ltYm9scywgcHJlZml4LCB7IGtleTogJ3FuYW1lJyB9KVxyXG4gIH1cclxuXHJcbiAgLypcclxuICBnZXRDb21wbGV0aW9uc0ZvckNsYXNzKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXHJcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxyXG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cclxuXHJcbiAgUmV0dXJuczogUHJvbWlzZShbc3ltYm9sXSlcclxuICBzeW1ib2w6IFNhbWUgYXMgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2wsIGV4Y2VwdFxyXG4gICAgICAgICAgc3ltYm9sVHlwZSBpcyBvbmUgb2YgWydjbGFzcyddXHJcbiAgKi9cclxuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JDbGFzcyhcclxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIF9wb3NpdGlvbjogUG9pbnQsXHJcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcclxuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XHJcblxyXG4gICAgY29uc3Qgc3ltYm9scyA9IGF3YWl0IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JCdWZmZXIoYnVmZmVyLCBbJ2NsYXNzJ10pXHJcbiAgICByZXR1cm4gRlouZmlsdGVyKHN5bWJvbHMsIHByZWZpeCwgeyBrZXk6ICdxbmFtZScgfSlcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcclxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXHJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XHJcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxyXG5cclxuICBSZXR1cm5zOiBQcm9taXNlKFttb2R1bGVdKVxyXG4gIG1vZHVsZTogU3RyaW5nLCBtb2R1bGUgbmFtZVxyXG4gICovXHJcbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yTW9kdWxlKFxyXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBwcmVmaXg6IHN0cmluZywgX3Bvc2l0aW9uOiBQb2ludCxcclxuICApOiBQcm9taXNlPHN0cmluZ1tdPiB7XHJcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHsgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJykgfVxyXG4gICAgY29uc3QgbW9kdWxlcyA9IGF3YWl0IHRoaXMucHJvY2Vzcy5iYWNrZW5kLnNjb3BlTW9kdWxlcyh7XHJcbiAgICAgIHF1ZXJ5OiBwcmVmaXgsXHJcbiAgICAgIHNlYXJjaFR5cGU6ICdwcmVmaXgnLFxyXG4gICAgICBmaWxlOiBidWZmZXIuZ2V0VXJpKCksXHJcbiAgICB9KVxyXG4gICAgY29uc3QgcGFydHM6IG51bWJlciA9IHByZWZpeC5zcGxpdCgnLicpLmxlbmd0aFxyXG4gICAgY29uc3QgbmFtZXM6IHN0cmluZ1tdID0gW11cclxuICAgIGZvciAoY29uc3QgbSBvZiBtb2R1bGVzKSB7XHJcbiAgICAgIGlmIChtLm5hbWUuc3BsaXQoJy4nKS5sZW5ndGggPT0gcGFydHMpIHtcclxuICAgICAgICBuYW1lcy5wdXNoKG0ubmFtZSlcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5hbWVzXHJcbiAgfVxyXG5cclxuICAvKlxyXG4gIGdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUoYnVmZmVyLHByZWZpeCxwb3NpdGlvbix7bW9kdWxlfSlcclxuICBVc2VkIGluIGltcG9ydCBoaWRpbmcvbGlzdCBjb21wbGV0aW9uc1xyXG5cclxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXHJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XHJcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxyXG4gIG1vZHVsZTogU3RyaW5nLCBtb2R1bGUgbmFtZSAob3B0aW9uYWwpLiBJZiB1bmRlZmluZWQsIGZ1bmN0aW9uXHJcbiAgICAgICAgICB3aWxsIGF0dGVtcHQgdG8gaW5mZXIgbW9kdWxlIG5hbWUgZnJvbSBwb3NpdGlvbiBhbmQgYnVmZmVyLlxyXG5cclxuICBSZXR1cm5zOiBQcm9taXNlKFtzeW1ib2xdKVxyXG4gIHN5bWJvbDogT2JqZWN0LCBzeW1ib2wgaW4gZ2l2ZW4gbW9kdWxlXHJcbiAgICBuYW1lOiBTdHJpbmcsIHN5bWJvbCBuYW1lXHJcbiAgICB0eXBlU2lnbmF0dXJlOiBTdHJpbmcsIHR5cGUgc2lnbmF0dXJlXHJcbiAgICBzeW1ib2xUeXBlOiBTdHJpbmcsIG9uZSBvZiBbJ3R5cGUnLCAnY2xhc3MnLCAnZnVuY3Rpb24nXVxyXG4gICovXHJcbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUoXHJcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBwb3NpdGlvbjogUG9pbnQsXHJcbiAgICBvcHRzPzogeyBtb2R1bGU6IHN0cmluZyB9LFxyXG4gICk6IFByb21pc2U8Q0IuSVN5bWJvbFtdPiB7XHJcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHsgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJykgfVxyXG4gICAgbGV0IG1vZHVsZU5hbWUgPSBvcHRzID8gb3B0cy5tb2R1bGUgOiB1bmRlZmluZWRcclxuICAgIGlmICghbW9kdWxlTmFtZSkge1xyXG4gICAgICBjb25zdCBsaW5lUmFuZ2UgPSBuZXcgUmFuZ2UoWzAsIHBvc2l0aW9uLnJvd10sIHBvc2l0aW9uKVxyXG4gICAgICBidWZmZXIuYmFja3dhcmRzU2NhbkluUmFuZ2UoXHJcbiAgICAgICAgL15pbXBvcnRcXHMrKFtcXHcuXSspLyxcclxuICAgICAgICBsaW5lUmFuZ2UsICh7IG1hdGNoIH0pID0+IG1vZHVsZU5hbWUgPSBtYXRjaFsxXSxcclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBbXSAvLyBUT0RPOiBJbXBsZW1lbnRcclxuICAgIC8vIHRzbGludDplbmFibGU6IG5vLW51bGwta2V5d29yZFxyXG4gICAgLy8gcmV0dXJuIEZaLmZpbHRlcihzeW1ib2xzLCBwcmVmaXgsIHsga2V5OiAnbmFtZScgfSlcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgZ2V0Q29tcGxldGlvbnNGb3JMYW5ndWFnZVByYWdtYXMoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcclxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXHJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XHJcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxyXG5cclxuICBSZXR1cm5zOiBQcm9taXNlKFtwcmFnbWFdKVxyXG4gIHByYWdtYTogU3RyaW5nLCBsYW5ndWFnZSBvcHRpb25cclxuICAqL1xyXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0Zvckxhbmd1YWdlUHJhZ21hcyhcclxuICAgIF9idWZmZXI6IFRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBfcG9zaXRpb246IFBvaW50LFxyXG4gICk6IFByb21pc2U8c3RyaW5nW10+IHtcclxuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XHJcbiAgICBjb25zdCBwczogc3RyaW5nW10gPSBhd2FpdCB0aGlzLnByb2Nlc3MuYmFja2VuZC5sYW5ncygpXHJcbiAgICByZXR1cm4gRlouZmlsdGVyKHBzLCBwcmVmaXgpXHJcbiAgfVxyXG5cclxuICAvKlxyXG4gIGdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXHJcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxyXG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cclxuXHJcbiAgUmV0dXJuczogUHJvbWlzZShbZ2hjb3B0XSlcclxuICBnaGNvcHQ6IFN0cmluZywgY29tcGlsZXIgb3B0aW9uIChzdGFydHMgd2l0aCAnLWYnKVxyXG4gICovXHJcbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zKFxyXG4gICAgX2J1ZmZlcjogVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIF9wb3NpdGlvbjogUG9pbnQsXHJcbiAgKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xyXG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7IHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpIH1cclxuICAgIGNvbnN0IGNvOiBzdHJpbmdbXSA9IGF3YWl0IHRoaXMucHJvY2Vzcy5iYWNrZW5kLmZsYWdzKClcclxuICAgIHJldHVybiBGWi5maWx0ZXIoY28sIHByZWZpeClcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgZ2V0Q29tcGxldGlvbnNGb3JIb2xlKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXHJcbiAgR2V0IGNvbXBsZXRpb25zIGJhc2VkIG9uIGV4cHJlc3Npb24gdHlwZS5cclxuICBJdCBpcyBhc3N1bWVkIHRoYXQgYHByZWZpeGAgc3RhcnRzIHdpdGggJ18nXHJcblxyXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcclxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXHJcblxyXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXHJcbiAgc3ltYm9sOiBTYW1lIGFzIGdldENvbXBsZXRpb25zRm9yU3ltYm9sXHJcbiAgKi9cclxuICBAaGFuZGxlRXhjZXB0aW9uXHJcbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9ySG9sZShcclxuICAgIF9idWZmZXI6IFRleHRCdWZmZXIsIF9wcmVmaXg6IHN0cmluZywgX3Bvc2l0aW9uOiBQb2ludCxcclxuICApOiBQcm9taXNlPENCLklTeW1ib2xbXT4ge1xyXG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7IHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpIH1cclxuICAgIHJldHVybiBbXSAvLyBUT0RPOiBJbXBsZW1lbnRcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JCdWZmZXIoXHJcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIHN5bWJvbFR5cGVzPzogQ0IuU3ltYm9sVHlwZVtdLFxyXG4gICk6IFByb21pc2U8Q0IuSVN5bWJvbFtdPiB7XHJcbiAgICBsZXQgc3ltYm9sczogQ0IuSVN5bWJvbFtdID0gW11cclxuXHJcbiAgICBjb25zdCBidWY6IEJ1ZmZlckluZm8gfCB1bmRlZmluZWQgPSB0aGlzLmJ1ZmZlck1hcC5nZXQoYnVmZmVyKVxyXG4gICAgaWYgKGJ1ZiAmJiBidWYuY29tcGxldGlvbnMpIHtcclxuICAgICAgc3ltYm9scyA9IGJ1Zi5jb21wbGV0aW9uc1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGNvbnN0IGNvbXBzOiBhbnlbXSA9IGF3YWl0IHRoaXMucHJvY2Vzcy5iYWNrZW5kLmNvbXBsZXRlKFxyXG4gICAgICAgICcnLFxyXG4gICAgICAgIGJ1ZmZlci5nZXRVcmkoKSxcclxuICAgICAgKVxyXG4gICAgICBmb3IgKGNvbnN0IGNvbXAgb2YgY29tcHMpIHtcclxuICAgICAgICBsZXQgc3ltVHlwZTogQ0IuU3ltYm9sVHlwZSA9ICdmdW5jdGlvbidcclxuICAgICAgICBzd2l0Y2ggKGNvbXAuaW5mby53aGF0KSB7XHJcbiAgICAgICAgICBjYXNlICdmdW5jdGlvbic6XHJcbiAgICAgICAgICBjYXNlICdtZXRob2QnOlxyXG4gICAgICAgICAgY2FzZSAnc2VsZWN0b3InOlxyXG4gICAgICAgICAgY2FzZSAncGF0LXNlbGVjdG9yJzpcclxuICAgICAgICAgIGNhc2UgJ3BhdC1jb25zdHJ1Y3Rvcic6XHJcbiAgICAgICAgICBjYXNlICdjb25zdHJ1Y3Rvcic6XHJcbiAgICAgICAgICAgIHN5bVR5cGUgPSAnZnVuY3Rpb24nXHJcbiAgICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgICBjYXNlICd0eXBlJzpcclxuICAgICAgICAgIGNhc2UgJ25ld3R5cGUnOlxyXG4gICAgICAgICAgY2FzZSAnZGF0YSc6XHJcbiAgICAgICAgICBjYXNlICd0eXBlLWZhbWlseSc6XHJcbiAgICAgICAgICBjYXNlICdkYXRhLWZhbWlseSc6XHJcbiAgICAgICAgICAgIHN5bVR5cGUgPSAndHlwZSdcclxuICAgICAgICAgICAgYnJlYWtcclxuICAgICAgICAgIGNhc2UgJ2NsYXNzJzpcclxuICAgICAgICAgICAgc3ltVHlwZSA9ICdjbGFzcydcclxuICAgICAgICAgICAgYnJlYWtcclxuICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzeW1ib2xUeXBlcyAmJiAhKHN5bVR5cGUgaW4gc3ltYm9sVHlwZXMpKSB7XHJcbiAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgc3ltYm9scy5wdXNoKHtcclxuICAgICAgICAgIHFwYXJlbnQ6IGNvbXAucXVhbGlmaWVyLFxyXG4gICAgICAgICAgcW5hbWU6IGNvbXAucXVhbGlmaWVyID8gYCR7Y29tcC5xdWFsaWZpZXJ9LiR7Y29tcC5pZC5uYW1lfWAgOiBjb21wLmlkLm5hbWUsXHJcbiAgICAgICAgICBuYW1lOiBjb21wLmlkLm5hbWUsXHJcbiAgICAgICAgICBzeW1ib2xUeXBlOiBzeW1UeXBlLFxyXG4gICAgICAgICAgdHlwZVNpZ25hdHVyZTogY29tcC5pbmZvLnR5cGUsXHJcbiAgICAgICAgICAvLyBGSVhNRTogVXNlIGltcG9ydCBtb2R1bGVcclxuICAgICAgICAgIG1vZHVsZToge1xyXG4gICAgICAgICAgICBuYW1lOiBjb21wLmlkLm1vZHVsZS5uYW1lLFxyXG4gICAgICAgICAgICBoaWRpbmc6IGZhbHNlLFxyXG4gICAgICAgICAgICBxdWFsaWZpZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICBhbGlhczogbnVsbCxcclxuICAgICAgICAgICAgaW1wb3J0TGlzdDogbnVsbCxcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChidWYpIHtcclxuICAgICAgICBVdGlsLmRlYnVnKGBDYWNoaW5nICR7c3ltYm9scy5sZW5ndGh9IGNvbXBsZXRpb25zYClcclxuICAgICAgICBidWYuY29tcGxldGlvbnMgPSBzeW1ib2xzXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICghc3ltYm9sVHlwZXMpIHtcclxuICAgICAgcmV0dXJuIHN5bWJvbHNcclxuICAgIH1cclxuICAgIGNvbnN0IHJlc3VsdDogQ0IuSVN5bWJvbFtdID0gW11cclxuICAgIGZvciAoY29uc3Qgc3ltIG9mIHN5bWJvbHMpIHtcclxuICAgICAgaWYgKHN5bS5zeW1ib2xUeXBlIGluIHN5bWJvbFR5cGVzKSB7XHJcbiAgICAgICAgcmVzdWx0LnB1c2goc3ltKVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZpbHRlcjxULCBLIGV4dGVuZHMga2V5b2YgVD4oY2FuZGlkYXRlczogVFtdLCBwcmVmaXg6IHN0cmluZywga2V5czogS1tdKTogVFtdIHtcclxuICAgIGlmICghcHJlZml4KSB7XHJcbiAgICAgIHJldHVybiBjYW5kaWRhdGVzXHJcbiAgICB9XHJcbiAgICBjb25zdCBsaXN0ID0gW11cclxuICAgIGZvciAoY29uc3QgY2FuZGlkYXRlIG9mIGNhbmRpZGF0ZXMpIHtcclxuICAgICAgY29uc3Qgc2NvcmVzID0ga2V5cy5tYXAoKGtleSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNrID0gY2FuZGlkYXRlW2tleV1cclxuICAgICAgICBpZiAoY2spIHtcclxuICAgICAgICAgIHJldHVybiBGWi5zY29yZShjay50b1N0cmluZygpLCBwcmVmaXgpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiAwXHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICBjb25zdCBzY29yZSA9IE1hdGgubWF4KC4uLnNjb3JlcylcclxuICAgICAgaWYgKHNjb3JlID4gMCkge1xyXG4gICAgICAgIGxpc3QucHVzaCh7XHJcbiAgICAgICAgICBzY29yZSxcclxuICAgICAgICAgIHNjb3JlTjogc2NvcmVzLmluZGV4T2Yoc2NvcmUpLFxyXG4gICAgICAgICAgZGF0YTogY2FuZGlkYXRlLFxyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBsaXN0LnNvcnQoKGEsIGIpID0+IHtcclxuICAgICAgY29uc3QgcyA9IGIuc2NvcmUgLSBhLnNjb3JlXHJcbiAgICAgIGlmIChzID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIGEuc2NvcmVOIC0gYi5zY29yZU5cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gc1xyXG4gICAgfSkubWFwKCh7IGRhdGEgfSkgPT4gZGF0YSlcclxuICB9XHJcbn1cclxuIl19