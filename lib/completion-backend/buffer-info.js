"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const atom_haskell_utils_1 = require("atom-haskell-utils");
class BufferInfo {
    constructor(buffer) {
        this.buffer = buffer;
        this.oldText = '';
        this.oldImports = { name: 'Main', imports: [] };
        this.destroy = () => {
            this.disposables.dispose();
        };
        this.disposables = new atom_1.CompositeDisposable();
        this.disposables.add(this.buffer.onDidDestroy(this.destroy));
    }
    async getImports() {
        const parsed = await this.parse();
        const imports = parsed ? parsed.imports : [];
        if (!imports.some(({ name }) => name === 'Prelude')) {
            imports.push({
                qualified: false,
                hiding: false,
                name: 'Prelude',
                importList: null,
                alias: null,
            });
        }
        return imports;
    }
    async getModuleName() {
        const parsed = await this.parse();
        return parsed.name;
    }
    async parse() {
        const newText = this.buffer.getText();
        if (this.oldText === newText) {
            return this.oldImports;
        }
        else {
            this.oldText = newText;
            this.oldImports = await atom_haskell_utils_1.parseHsModuleImports(this.buffer.getText());
            return this.oldImports;
        }
    }
}
exports.BufferInfo = BufferInfo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVmZmVyLWluZm8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tcGxldGlvbi1iYWNrZW5kL2J1ZmZlci1pbmZvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXNEO0FBQ3RELDJEQUFrRjtBQUlsRjtJQUtFLFlBQTRCLE1BQWtCO1FBQWxCLFdBQU0sR0FBTixNQUFNLENBQVk7UUFIdEMsWUFBTyxHQUFXLEVBQUUsQ0FBQTtRQUNwQixlQUFVLEdBQW1CLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUE7UUFPM0QsWUFBTyxHQUFHLEdBQUcsRUFBRTtZQUNwQixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQzVCLENBQUMsQ0FBQTtRQU5DLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQzVDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO0lBQzlELENBQUM7SUFNTSxLQUFLLENBQUMsVUFBVTtRQUNyQixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtRQUNqQyxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtRQUU1QyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BELE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ1gsU0FBUyxFQUFFLEtBQUs7Z0JBQ2hCLE1BQU0sRUFBRSxLQUFLO2dCQUNiLElBQUksRUFBRSxTQUFTO2dCQUNmLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixLQUFLLEVBQUUsSUFBSTthQUNaLENBQUMsQ0FBQTtRQUNKLENBQUM7UUFFRCxNQUFNLENBQUMsT0FBTyxDQUFBO0lBQ2hCLENBQUM7SUFFTSxLQUFLLENBQUMsYUFBYTtRQUN4QixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtRQUNqQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQTtJQUNwQixDQUFDO0lBRU8sS0FBSyxDQUFDLEtBQUs7UUFDakIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtRQUNyQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDN0IsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUE7UUFDeEIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7WUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLHlDQUFvQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTtZQUNuRSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQTtRQUN4QixDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBOUNELGdDQThDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIFRleHRCdWZmZXIgfSBmcm9tICdhdG9tJ1xyXG5pbXBvcnQgeyBwYXJzZUhzTW9kdWxlSW1wb3J0cywgSU1vZHVsZUltcG9ydHMsIElJbXBvcnQgfSBmcm9tICdhdG9tLWhhc2tlbGwtdXRpbHMnXHJcblxyXG5leHBvcnQgeyBJSW1wb3J0IH1cclxuXHJcbmV4cG9ydCBjbGFzcyBCdWZmZXJJbmZvIHtcclxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXHJcbiAgcHJpdmF0ZSBvbGRUZXh0OiBzdHJpbmcgPSAnJ1xyXG4gIHByaXZhdGUgb2xkSW1wb3J0czogSU1vZHVsZUltcG9ydHMgPSB7IG5hbWU6ICdNYWluJywgaW1wb3J0czogW10gfVxyXG5cclxuICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgYnVmZmVyOiBUZXh0QnVmZmVyKSB7XHJcbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxyXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5idWZmZXIub25EaWREZXN0cm95KHRoaXMuZGVzdHJveSkpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZGVzdHJveSA9ICgpID0+IHtcclxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZ2V0SW1wb3J0cygpOiBQcm9taXNlPElJbXBvcnRbXT4ge1xyXG4gICAgY29uc3QgcGFyc2VkID0gYXdhaXQgdGhpcy5wYXJzZSgpXHJcbiAgICBjb25zdCBpbXBvcnRzID0gcGFyc2VkID8gcGFyc2VkLmltcG9ydHMgOiBbXVxyXG4gICAgLy8gdHNsaW50OmRpc2FibGU6IG5vLW51bGwta2V5d29yZFxyXG4gICAgaWYgKCFpbXBvcnRzLnNvbWUoKHsgbmFtZSB9KSA9PiBuYW1lID09PSAnUHJlbHVkZScpKSB7XHJcbiAgICAgIGltcG9ydHMucHVzaCh7XHJcbiAgICAgICAgcXVhbGlmaWVkOiBmYWxzZSxcclxuICAgICAgICBoaWRpbmc6IGZhbHNlLFxyXG4gICAgICAgIG5hbWU6ICdQcmVsdWRlJyxcclxuICAgICAgICBpbXBvcnRMaXN0OiBudWxsLFxyXG4gICAgICAgIGFsaWFzOiBudWxsLFxyXG4gICAgICB9KVxyXG4gICAgfVxyXG4gICAgLy8gdHNsaW50OmVuYWJsZTogbm8tbnVsbC1rZXl3b3JkXHJcbiAgICByZXR1cm4gaW1wb3J0c1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGdldE1vZHVsZU5hbWUoKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIGNvbnN0IHBhcnNlZCA9IGF3YWl0IHRoaXMucGFyc2UoKVxyXG4gICAgcmV0dXJuIHBhcnNlZC5uYW1lXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHBhcnNlKCk6IFByb21pc2U8SU1vZHVsZUltcG9ydHM+IHtcclxuICAgIGNvbnN0IG5ld1RleHQgPSB0aGlzLmJ1ZmZlci5nZXRUZXh0KClcclxuICAgIGlmICh0aGlzLm9sZFRleHQgPT09IG5ld1RleHQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMub2xkSW1wb3J0c1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5vbGRUZXh0ID0gbmV3VGV4dFxyXG4gICAgICB0aGlzLm9sZEltcG9ydHMgPSBhd2FpdCBwYXJzZUhzTW9kdWxlSW1wb3J0cyh0aGlzLmJ1ZmZlci5nZXRUZXh0KCkpXHJcbiAgICAgIHJldHVybiB0aGlzLm9sZEltcG9ydHNcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19