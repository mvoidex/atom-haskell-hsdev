"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const Temp = require("temp");
const FS = require("fs");
const CP = require("child_process");
const os_1 = require("os");
const atom_haskell_utils_1 = require("atom-haskell-utils");
exports.getRootDirFallback = atom_haskell_utils_1.getRootDirFallback;
exports.getRootDir = atom_haskell_utils_1.getRootDir;
exports.isDirectory = atom_haskell_utils_1.isDirectory;
let debuglog = [];
const logKeep = 30000;
function savelog(...messages) {
    const ts = Date.now();
    debuglog.push({
        timestamp: ts,
        messages,
    });
    let ks = 0;
    for (const v of debuglog) {
        if ((ts - v.timestamp) >= logKeep) {
            break;
        }
        ks++;
    }
    debuglog.splice(0, ks);
}
function joinPath(ds) {
    const set = new Set(ds);
    return Array.from(set).join(path_1.delimiter);
}
exports.EOT = `${os_1.EOL}\x04${os_1.EOL}`;
function debug(...messages) {
    if (atom.config.get('atom-haskell-hsdev.debug')) {
        console.log('atom-haskell-hsdev debug:', ...messages);
    }
    savelog(...messages.map((v) => JSON.stringify(v)));
}
exports.debug = debug;
function warn(...messages) {
    console.warn('atom-haskell-hsdev warning:', ...messages);
    savelog(...messages.map((v) => JSON.stringify(v)));
}
exports.warn = warn;
function error(...messages) {
    console.error('atom-haskell-hsdev error:', ...messages);
    savelog(...messages.map((v) => JSON.stringify(v)));
}
exports.error = error;
function getDebugLog() {
    const ts = Date.now();
    debuglog = debuglog.filter(({ timestamp }) => (ts - timestamp) < logKeep);
    return debuglog.map(({ timestamp, messages }) => `${(timestamp - ts) / 1000}s: ${messages.join(',')}`).join(os_1.EOL);
}
exports.getDebugLog = getDebugLog;
async function execPromise(cmd, args, opts, stdin) {
    return new Promise((resolve, reject) => {
        debug(`Running ${cmd} ${args} with opts = `, opts);
        const child = CP.execFile(cmd, args, opts, (error, stdout, stderr) => {
            if (stderr.trim().length > 0) {
                warn(stderr);
            }
            if (error) {
                warn(`Running ${cmd} ${args} failed with `, error);
                if (stdout) {
                    warn(stdout);
                }
                error.stack = (new Error()).stack;
                reject(error);
            }
            else {
                debug(`Got response from ${cmd} ${args}`, { stdout, stderr });
                resolve({ stdout, stderr });
            }
        });
        if (stdin) {
            debug(`sending stdin text to ${cmd} ${args}`);
            child.stdin.write(stdin);
        }
    });
}
exports.execPromise = execPromise;
async function getCabalSandbox(rootPath) {
    debug('Looking for cabal sandbox...');
    const sbc = await parseSandboxConfig(`${rootPath}${path_1.sep}cabal.sandbox.config`);
    if (sbc && sbc['install-dirs'] && sbc['install-dirs']['bindir']) {
        const sandbox = sbc['install-dirs']['bindir'];
        debug('Found cabal sandbox: ', sandbox);
        if (atom_haskell_utils_1.isDirectory(sandbox)) {
            return sandbox;
        }
        else {
            warn('Cabal sandbox ', sandbox, ' is not a directory');
            return undefined;
        }
    }
    else {
        warn('No cabal sandbox found');
        return undefined;
    }
}
exports.getCabalSandbox = getCabalSandbox;
async function getStackSandbox(rootPath, apd, env) {
    debug('Looking for stack sandbox...');
    env.PATH = joinPath(apd);
    debug('Running stack with PATH ', env.PATH);
    try {
        const out = await execPromise('stack', ['path', '--snapshot-install-root', '--local-install-root', '--bin-path'], {
            encoding: 'utf8',
            cwd: rootPath,
            env,
            timeout: atom.config.get('atom-haskell-hsdev.initTimeout') * 1000,
        });
        const lines = out.stdout.split(os_1.EOL);
        const sir = lines.filter((l) => l.startsWith('snapshot-install-root: '))[0].slice(23) + `${path_1.sep}bin`;
        const lir = lines.filter((l) => l.startsWith('local-install-root: '))[0].slice(20) + `${path_1.sep}bin`;
        const bp = lines.filter((l) => l.startsWith('bin-path: '))[0].slice(10).split(path_1.delimiter).filter((p) => !((p === sir) || (p === lir) || (apd.includes(p))));
        debug('Found stack sandbox ', lir, sir, ...bp);
        return [lir, sir, ...bp];
    }
    catch (err) {
        warn('No stack sandbox found because ', err);
        return undefined;
    }
}
exports.getStackSandbox = getStackSandbox;
async function getProcessOptions(rootPath) {
    if (!rootPath) {
        rootPath = atom_haskell_utils_1.getRootDirFallback(null).getPath();
    }
    const res = {};
    return res;
}
exports.getProcessOptions = getProcessOptions;
function getSymbolAtPoint(editor, point) {
    const [scope] = editor.scopeDescriptorForBufferPosition(point).getScopesArray().slice(-1);
    if (scope) {
        const range = editor.bufferRangeForScopeAtPosition(scope, point);
        if (range && !range.isEmpty()) {
            const symbol = editor.getTextInBufferRange(range);
            return { scope, range, symbol };
        }
    }
    return undefined;
}
exports.getSymbolAtPoint = getSymbolAtPoint;
function getSymbolInRange(editor, crange) {
    const buffer = editor.getBuffer();
    if (crange.isEmpty()) {
        return getSymbolAtPoint(editor, crange.start);
    }
    else {
        return {
            symbol: buffer.getTextInRange(crange),
            range: crange,
        };
    }
}
exports.getSymbolInRange = getSymbolInRange;
async function withTempFile(contents, uri, gen) {
    const info = await new Promise((resolve, reject) => Temp.open({ prefix: 'atom-haskell-hsdev', suffix: path_1.extname(uri || '.hs') }, (err, info2) => {
        if (err) {
            reject(err);
        }
        else {
            resolve(info2);
        }
    }));
    return new Promise((resolve, reject) => FS.write(info.fd, contents, async (err) => {
        if (err) {
            reject(err);
        }
        else {
            resolve(await gen(info.path));
            FS.close(info.fd, () => FS.unlink(info.path, () => { }));
        }
    }));
}
exports.withTempFile = withTempFile;
function mkError(name, message) {
    const err = new Error(message);
    err.name = name;
    return err;
}
exports.mkError = mkError;
async function parseSandboxConfig(file) {
    try {
        const sbc = await new Promise((resolve, reject) => FS.readFile(file, { encoding: 'utf-8' }, (err, sbc2) => {
            if (err) {
                reject(err);
            }
            else {
                resolve(sbc2);
            }
        }));
        const vars = {};
        let scope = vars;
        const rv = (v) => {
            for (const k1 of Object.keys(scope)) {
                const v1 = scope[k1];
                if (typeof v1 === 'string') {
                    v = v.split(`$${k1}`).join(v1);
                }
            }
            return v;
        };
        for (const line of sbc.split(/\r?\n|\r/)) {
            if (!line.match(/^\s*--/) && !line.match(/^\s*$/)) {
                const [l] = line.split(/--/);
                const m = l.match(/^\s*([\w-]+):\s*(.*)\s*$/);
                if (m) {
                    const [, name, val] = m;
                    scope[name] = rv(val);
                }
                else {
                    const newscope = {};
                    scope[line] = newscope;
                    scope = newscope;
                }
            }
        }
        return vars;
    }
    catch (err) {
        warn('Reading cabal sandbox config failed with ', err);
        return undefined;
    }
}
exports.parseSandboxConfig = parseSandboxConfig;
function isUpperCase(ch) {
    return ch.toUpperCase() === ch;
}
exports.isUpperCase = isUpperCase;
function getErrorDetail({ err, runArgs }) {
    return `Args:
${JSON.stringify(runArgs, undefined, 2)}
message:
${err.message}
log:
${getDebugLog()}`;
}
exports.getErrorDetail = getErrorDetail;
function formatError({ err, runArgs }) {
    if (err.name === 'InteractiveActionTimeout' && runArgs) {
        return `\
Haskell-ghc-mod: ghc-mod \
${runArgs.interactive ? 'interactive ' : ''}command ${runArgs.command} \
timed out. You can try to fix it by raising 'Interactive Action \
Timeout' setting in atom-haskell-hsdev settings.`;
    }
    else if (runArgs) {
        return `\
Haskell-ghc-mod: ghc-mod \
${runArgs.interactive ? 'interactive ' : ''}command ${runArgs.command} \
failed with error ${err.name}`;
    }
    else {
        return `There was an unexpected error ${err.name}`;
    }
}
exports.formatError = formatError;
function defaultErrorHandler(args) {
    const { err, runArgs } = args;
    const suppressErrors = runArgs && runArgs.suppressErrors;
    if (!suppressErrors) {
        atom.notifications.addError(formatError(args), {
            detail: getErrorDetail(args),
            stack: err.stack,
            dismissable: true,
        });
    }
    else {
        error(runArgs, err);
    }
}
exports.defaultErrorHandler = defaultErrorHandler;
function warnGHCPackagePath() {
    atom.notifications.addWarning('atom-haskell-hsdev: You have GHC_PACKAGE_PATH environment variable set!', {
        dismissable: true,
        detail: `\
This configuration is not supported, and can break arbitrarily. You can try to band-aid it by adding

delete process.env.GHC_PACKAGE_PATH

to your Atom init script (Edit â†’ Init Script...)

You can suppress this warning in atom-haskell-hsdev settings.`,
    });
}
exports.warnGHCPackagePath = warnGHCPackagePath;
function filterEnv(env) {
    const fenv = {};
    for (const evar in env) {
        const evarU = evar.toUpperCase();
        if (evarU === 'PATH'
            || evarU.startsWith('GHC_')
            || evarU.startsWith('STACK_')
            || evarU.startsWith('CABAL_')) {
            fenv[evar] = env[evar];
        }
    }
    return fenv;
}
function notifySpawnFail(args) {
    const debugInfo = Object.assign({}, args);
    if (args.opts) {
        const optsclone = Object.assign({}, args.opts);
        debugInfo.opts = optsclone;
    }
    atom.notifications.addFatalError(`Haskell-ghc-mod: ghc-mod failed to launch.
It is probably missing or misconfigured. ${args.err.code}`, {
        detail: `\
Error was: ${debugInfo.err.name}
${debugInfo.err.message}
Debug information:
${JSON.stringify(debugInfo, undefined, 2)}
Config:
${JSON.stringify(atom.config.get('atom-haskell-hsdev'), undefined, 2)}
`,
        stack: debugInfo.err.stack,
        dismissable: true,
    });
}
exports.notifySpawnFail = notifySpawnFail;
function handleException(_target, _key, desc) {
    return Object.assign({}, desc, { async value(...args) {
            try {
                return await desc.value.call(this, ...args);
            }
            catch (e) {
                debug(e);
                const upi = await this.upi;
                upi.setStatus({
                    status: 'warning',
                    detail: e.toString(),
                });
                return new Promise(() => { });
            }
        } });
}
exports.handleException = handleException;
function versAtLeast(vers, b) {
    for (let i = 0; i < b.length; i++) {
        const v = b[i];
        const t = vers[i];
        const vv = t !== undefined ? t : 0;
        if (vv > v) {
            return true;
        }
        else if (vv < v) {
            return false;
        }
    }
    return true;
}
exports.versAtLeast = versAtLeast;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsK0JBQThDO0FBQzlDLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFDeEIsb0NBQW1DO0FBQ25DLDJCQUF3QjtBQUN4QiwyREFBZ0Y7QUFNdkUsNkJBTkEsdUNBQWtCLENBTUE7QUFBRSxxQkFOQSwrQkFBVSxDQU1BO0FBQUUsc0JBTkEsZ0NBQVcsQ0FNQTtBQUVwRCxJQUFJLFFBQVEsR0FBcUQsRUFBRSxDQUFBO0FBQ25FLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQTtBQUVyQixpQkFBaUIsR0FBRyxRQUFrQjtJQUNwQyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUE7SUFDckIsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNaLFNBQVMsRUFBRSxFQUFFO1FBQ2IsUUFBUTtLQUNULENBQUMsQ0FBQTtJQUNGLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQTtJQUNWLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDekIsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDbEMsS0FBSyxDQUFBO1FBQ1AsQ0FBQztRQUNELEVBQUUsRUFBRSxDQUFBO0lBQ04sQ0FBQztJQUNELFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3hCLENBQUM7QUFFRCxrQkFBa0IsRUFBWTtJQUM1QixNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUN2QixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQVMsQ0FBQyxDQUFBO0FBQ3hDLENBQUM7QUFFWSxRQUFBLEdB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QztnQkFDWCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBRVIsTUFBTSxHQUFHLEdBQXFCLE1BQU8sSUFBWSxDQUFDLEdBQUcsQ0FBQTtnQkFDckQsR0FBRyxDQUFDLFNBQVMsQ0FBQztvQkFDWixNQUFNLEVBQUUsU0FBUztvQkFFakIsTUFBTSxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7aUJBQ3JCLENBQUMsQ0FBQTtnQkFFRixNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQWMsQ0FBQyxDQUFDLENBQUE7WUFDMUMsQ0FBQztRQUNILENBQUMsSUFDRjtBQUNILENBQUM7QUF4QkQsMENBd0JDO0FBRUQscUJBQTRCLElBQTJDLEVBQUUsQ0FBVztJQUNsRixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNsQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDZCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDakIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDbEMsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDWCxNQUFNLENBQUMsSUFBSSxDQUFBO1FBQ2IsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixNQUFNLENBQUMsS0FBSyxDQUFBO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFDRCxNQUFNLENBQUMsSUFBSSxDQUFBO0FBQ2IsQ0FBQztBQVpELGtDQVlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmFuZ2UsIFBvaW50LCBUZXh0QnVmZmVyLCBUZXh0RWRpdG9yIH0gZnJvbSAnYXRvbSdcclxuaW1wb3J0IHsgZGVsaW1pdGVyLCBzZXAsIGV4dG5hbWUgfSBmcm9tICdwYXRoJ1xyXG5pbXBvcnQgKiBhcyBUZW1wIGZyb20gJ3RlbXAnXHJcbmltcG9ydCAqIGFzIEZTIGZyb20gJ2ZzJ1xyXG5pbXBvcnQgKiBhcyBDUCBmcm9tICdjaGlsZF9wcm9jZXNzJ1xyXG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcydcclxuaW1wb3J0IHsgZ2V0Um9vdERpckZhbGxiYWNrLCBnZXRSb290RGlyLCBpc0RpcmVjdG9yeSB9IGZyb20gJ2F0b20taGFza2VsbC11dGlscydcclxuaW1wb3J0IHsgUnVuT3B0aW9ucywgSUVycm9yQ2FsbGJhY2tBcmdzIH0gZnJvbSAnLi9oc2Rldi9oc2Rldi1wcm9jZXNzLXJlYWwnXHJcbmltcG9ydCB7IEhzRGV2VmVyc2lvbiB9IGZyb20gJy4vaHNkZXYvaHNkZXYtcHJvY2Vzcy1yZWFsLWZhY3RvcnknXHJcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xyXG5cclxudHlwZSBFeGVjT3B0cyA9IENQLkV4ZWNGaWxlT3B0aW9uc1dpdGhTdHJpbmdFbmNvZGluZ1xyXG5leHBvcnQgeyBnZXRSb290RGlyRmFsbGJhY2ssIGdldFJvb3REaXIsIGlzRGlyZWN0b3J5LCBFeGVjT3B0cyB9XHJcblxyXG5sZXQgZGVidWdsb2c6IEFycmF5PHsgdGltZXN0YW1wOiBudW1iZXIsIG1lc3NhZ2VzOiBzdHJpbmdbXSB9PiA9IFtdXHJcbmNvbnN0IGxvZ0tlZXAgPSAzMDAwMCAvLyBtc1xyXG5cclxuZnVuY3Rpb24gc2F2ZWxvZyguLi5tZXNzYWdlczogc3RyaW5nW10pIHtcclxuICBjb25zdCB0cyA9IERhdGUubm93KClcclxuICBkZWJ1Z2xvZy5wdXNoKHtcclxuICAgIHRpbWVzdGFtcDogdHMsXHJcbiAgICBtZXNzYWdlcyxcclxuICB9KVxyXG4gIGxldCBrcyA9IDBcclxuICBmb3IgKGNvbnN0IHYgb2YgZGVidWdsb2cpIHtcclxuICAgIGlmICgodHMgLSB2LnRpbWVzdGFtcCkgPj0gbG9nS2VlcCkge1xyXG4gICAgICBicmVha1xyXG4gICAgfVxyXG4gICAga3MrK1xyXG4gIH1cclxuICBkZWJ1Z2xvZy5zcGxpY2UoMCwga3MpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGpvaW5QYXRoKGRzOiBzdHJpbmdbXSkge1xyXG4gIGNvbnN0IHNldCA9IG5ldyBTZXQoZHMpXHJcbiAgcmV0dXJuIEFycmF5LmZyb20oc2V0KS5qb2luKGRlbGltaXRlcilcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IEVPVCA9IGAke0VPTH1cXHgwNCR7RU9MfWBcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBkZWJ1ZyguLi5tZXNzYWdlczogYW55W10pIHtcclxuICBpZiAoYXRvbS5jb25maWcuZ2V0KCdhdG9tLWhhc2tlbGwtaHNkZXYuZGVidWcnKSkge1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25zb2xlXHJcbiAgICBjb25zb2xlLmxvZygnYXRvbS1oYXNrZWxsLWhzZGV2IGRlYnVnOicsIC4uLm1lc3NhZ2VzKVxyXG4gIH1cclxuICBzYXZlbG9nKC4uLm1lc3NhZ2VzLm1hcCgodikgPT4gSlNPTi5zdHJpbmdpZnkodikpKVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gd2FybiguLi5tZXNzYWdlczogYW55W10pIHtcclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbnNvbGVcclxuICBjb25zb2xlLndhcm4oJ2F0b20taGFza2VsbC1oc2RldiB3YXJuaW5nOicsIC4uLm1lc3NhZ2VzKVxyXG4gIHNhdmVsb2coLi4ubWVzc2FnZXMubWFwKCh2KSA9PiBKU09OLnN0cmluZ2lmeSh2KSkpXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBlcnJvciguLi5tZXNzYWdlczogYW55W10pIHtcclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbnNvbGVcclxuICBjb25zb2xlLmVycm9yKCdhdG9tLWhhc2tlbGwtaHNkZXYgZXJyb3I6JywgLi4ubWVzc2FnZXMpXHJcbiAgc2F2ZWxvZyguLi5tZXNzYWdlcy5tYXAoKHYpID0+IEpTT04uc3RyaW5naWZ5KHYpKSlcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldERlYnVnTG9nKCkge1xyXG4gIGNvbnN0IHRzID0gRGF0ZS5ub3coKVxyXG4gIGRlYnVnbG9nID0gZGVidWdsb2cuZmlsdGVyKCh7IHRpbWVzdGFtcCB9KSA9PiAodHMgLSB0aW1lc3RhbXApIDwgbG9nS2VlcClcclxuICByZXR1cm4gZGVidWdsb2cubWFwKCh7IHRpbWVzdGFtcCwgbWVzc2FnZXMgfSkgPT4gYCR7KHRpbWVzdGFtcCAtIHRzKSAvIDEwMDB9czogJHttZXNzYWdlcy5qb2luKCcsJyl9YCkuam9pbihFT0wpXHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleGVjUHJvbWlzZShjbWQ6IHN0cmluZywgYXJnczogc3RyaW5nW10sIG9wdHM6IEV4ZWNPcHRzLCBzdGRpbj86IHN0cmluZykge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZTx7IHN0ZG91dDogc3RyaW5nLCBzdGRlcnI6IHN0cmluZyB9PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBkZWJ1ZyhgUnVubmluZyAke2NtZH0gJHthcmdzfSB3aXRoIG9wdHMgPSBgLCBvcHRzKVxyXG4gICAgY29uc3QgY2hpbGQgPSBDUC5leGVjRmlsZShjbWQsIGFyZ3MsIG9wdHMsIChlcnJvciwgc3Rkb3V0OiBzdHJpbmcsIHN0ZGVycjogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmIChzdGRlcnIudHJpbSgpLmxlbmd0aCA+IDApIHsgd2FybihzdGRlcnIpIH1cclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgd2FybihgUnVubmluZyAke2NtZH0gJHthcmdzfSBmYWlsZWQgd2l0aCBgLCBlcnJvcilcclxuICAgICAgICBpZiAoc3Rkb3V0KSB7IHdhcm4oc3Rkb3V0KSB9XHJcbiAgICAgICAgZXJyb3Iuc3RhY2sgPSAobmV3IEVycm9yKCkpLnN0YWNrXHJcbiAgICAgICAgcmVqZWN0KGVycm9yKVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRlYnVnKGBHb3QgcmVzcG9uc2UgZnJvbSAke2NtZH0gJHthcmdzfWAsIHsgc3Rkb3V0LCBzdGRlcnIgfSlcclxuICAgICAgICByZXNvbHZlKHsgc3Rkb3V0LCBzdGRlcnIgfSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIGlmIChzdGRpbikge1xyXG4gICAgICBkZWJ1Zyhgc2VuZGluZyBzdGRpbiB0ZXh0IHRvICR7Y21kfSAke2FyZ3N9YClcclxuICAgICAgY2hpbGQuc3RkaW4ud3JpdGUoc3RkaW4pXHJcbiAgICB9XHJcbiAgfSlcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENhYmFsU2FuZGJveChyb290UGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcclxuICBkZWJ1ZygnTG9va2luZyBmb3IgY2FiYWwgc2FuZGJveC4uLicpXHJcbiAgY29uc3Qgc2JjID0gYXdhaXQgcGFyc2VTYW5kYm94Q29uZmlnKGAke3Jvb3RQYXRofSR7c2VwfWNhYmFsLnNhbmRib3guY29uZmlnYClcclxuICAvLyB0c2xpbnQ6ZGlzYWJsZTogbm8tc3RyaW5nLWxpdGVyYWxcclxuICBpZiAoc2JjICYmIHNiY1snaW5zdGFsbC1kaXJzJ10gJiYgc2JjWydpbnN0YWxsLWRpcnMnXVsnYmluZGlyJ10pIHtcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tdW5zYWZlLWFueVxyXG4gICAgY29uc3Qgc2FuZGJveDogc3RyaW5nID0gc2JjWydpbnN0YWxsLWRpcnMnXVsnYmluZGlyJ11cclxuICAgIGRlYnVnKCdGb3VuZCBjYWJhbCBzYW5kYm94OiAnLCBzYW5kYm94KVxyXG4gICAgaWYgKGlzRGlyZWN0b3J5KHNhbmRib3gpKSB7XHJcbiAgICAgIHJldHVybiBzYW5kYm94XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB3YXJuKCdDYWJhbCBzYW5kYm94ICcsIHNhbmRib3gsICcgaXMgbm90IGEgZGlyZWN0b3J5JylcclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICB3YXJuKCdObyBjYWJhbCBzYW5kYm94IGZvdW5kJylcclxuICAgIHJldHVybiB1bmRlZmluZWRcclxuICB9XHJcbiAgLy8gdHNsaW50OmVuYWJsZTogbm8tc3RyaW5nLWxpdGVyYWxcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFN0YWNrU2FuZGJveChyb290UGF0aDogc3RyaW5nLCBhcGQ6IHN0cmluZ1tdLCBlbnY6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgdW5kZWZpbmVkIH0pIHtcclxuICBkZWJ1ZygnTG9va2luZyBmb3Igc3RhY2sgc2FuZGJveC4uLicpXHJcbiAgZW52LlBBVEggPSBqb2luUGF0aChhcGQpXHJcbiAgZGVidWcoJ1J1bm5pbmcgc3RhY2sgd2l0aCBQQVRIICcsIGVudi5QQVRIKVxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBvdXQgPSBhd2FpdCBleGVjUHJvbWlzZSgnc3RhY2snLCBbJ3BhdGgnLCAnLS1zbmFwc2hvdC1pbnN0YWxsLXJvb3QnLCAnLS1sb2NhbC1pbnN0YWxsLXJvb3QnLCAnLS1iaW4tcGF0aCddLCB7XHJcbiAgICAgIGVuY29kaW5nOiAndXRmOCcsXHJcbiAgICAgIGN3ZDogcm9vdFBhdGgsXHJcbiAgICAgIGVudixcclxuICAgICAgdGltZW91dDogYXRvbS5jb25maWcuZ2V0KCdhdG9tLWhhc2tlbGwtaHNkZXYuaW5pdFRpbWVvdXQnKSAqIDEwMDAsXHJcbiAgICB9KVxyXG5cclxuICAgIGNvbnN0IGxpbmVzID0gb3V0LnN0ZG91dC5zcGxpdChFT0wpXHJcbiAgICBjb25zdCBzaXIgPSBsaW5lcy5maWx0ZXIoKGwpID0+IGwuc3RhcnRzV2l0aCgnc25hcHNob3QtaW5zdGFsbC1yb290OiAnKSlbMF0uc2xpY2UoMjMpICsgYCR7c2VwfWJpbmBcclxuICAgIGNvbnN0IGxpciA9IGxpbmVzLmZpbHRlcigobCkgPT4gbC5zdGFydHNXaXRoKCdsb2NhbC1pbnN0YWxsLXJvb3Q6ICcpKVswXS5zbGljZSgyMCkgKyBgJHtzZXB9YmluYFxyXG4gICAgY29uc3QgYnAgPVxyXG4gICAgICBsaW5lcy5maWx0ZXIoKGwpID0+XHJcbiAgICAgICAgbC5zdGFydHNXaXRoKCdiaW4tcGF0aDogJykpWzBdLnNsaWNlKDEwKS5zcGxpdChkZWxpbWl0ZXIpLmZpbHRlcigocCkgPT5cclxuICAgICAgICAgICEoKHAgPT09IHNpcikgfHwgKHAgPT09IGxpcikgfHwgKGFwZC5pbmNsdWRlcyhwKSkpKVxyXG4gICAgZGVidWcoJ0ZvdW5kIHN0YWNrIHNhbmRib3ggJywgbGlyLCBzaXIsIC4uLmJwKVxyXG4gICAgcmV0dXJuIFtsaXIsIHNpciwgLi4uYnBdXHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICB3YXJuKCdObyBzdGFjayBzYW5kYm94IGZvdW5kIGJlY2F1c2UgJywgZXJyKVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZFxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFByb2Nlc3NPcHRpb25zKHJvb3RQYXRoPzogc3RyaW5nKTogUHJvbWlzZTxSdW5PcHRpb25zPiB7XHJcbiAgaWYgKCFyb290UGF0aCkge1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1udWxsLWtleXdvcmQgbm8tdW5zYWZlLWFueVxyXG4gICAgcm9vdFBhdGggPSBnZXRSb290RGlyRmFsbGJhY2sobnVsbCkuZ2V0UGF0aCgpXHJcbiAgfVxyXG5cclxuICBjb25zdCByZXM6IFJ1bk9wdGlvbnMgPSB7XHJcbiAgfVxyXG4gIHJldHVybiByZXNcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFN5bWJvbEF0UG9pbnQoXHJcbiAgZWRpdG9yOiBUZXh0RWRpdG9yLCBwb2ludDogUG9pbnQsXHJcbikge1xyXG4gIGNvbnN0IFtzY29wZV0gPSBlZGl0b3Iuc2NvcGVEZXNjcmlwdG9yRm9yQnVmZmVyUG9zaXRpb24ocG9pbnQpLmdldFNjb3Blc0FycmF5KCkuc2xpY2UoLTEpXHJcbiAgaWYgKHNjb3BlKSB7XHJcbiAgICBjb25zdCByYW5nZSA9IGVkaXRvci5idWZmZXJSYW5nZUZvclNjb3BlQXRQb3NpdGlvbihzY29wZSwgcG9pbnQpXHJcbiAgICBpZiAocmFuZ2UgJiYgIXJhbmdlLmlzRW1wdHkoKSkge1xyXG4gICAgICBjb25zdCBzeW1ib2wgPSBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UocmFuZ2UpXHJcbiAgICAgIHJldHVybiB7IHNjb3BlLCByYW5nZSwgc3ltYm9sIH1cclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIHVuZGVmaW5lZFxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3ltYm9sSW5SYW5nZShlZGl0b3I6IFRleHRFZGl0b3IsIGNyYW5nZTogUmFuZ2UpIHtcclxuICBjb25zdCBidWZmZXIgPSBlZGl0b3IuZ2V0QnVmZmVyKClcclxuICBpZiAoY3JhbmdlLmlzRW1wdHkoKSkge1xyXG4gICAgcmV0dXJuIGdldFN5bWJvbEF0UG9pbnQoZWRpdG9yLCBjcmFuZ2Uuc3RhcnQpXHJcbiAgfSBlbHNlIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN5bWJvbDogYnVmZmVyLmdldFRleHRJblJhbmdlKGNyYW5nZSksXHJcbiAgICAgIHJhbmdlOiBjcmFuZ2UsXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2l0aFRlbXBGaWxlPFQ+KGNvbnRlbnRzOiBzdHJpbmcsIHVyaTogc3RyaW5nLCBnZW46IChwYXRoOiBzdHJpbmcpID0+IFByb21pc2U8VD4pOiBQcm9taXNlPFQ+IHtcclxuICBjb25zdCBpbmZvID0gYXdhaXQgbmV3IFByb21pc2U8VGVtcC5PcGVuRmlsZT4oXHJcbiAgICAocmVzb2x2ZSwgcmVqZWN0KSA9PlxyXG4gICAgICBUZW1wLm9wZW4oXHJcbiAgICAgICAgeyBwcmVmaXg6ICdhdG9tLWhhc2tlbGwtaHNkZXYnLCBzdWZmaXg6IGV4dG5hbWUodXJpIHx8ICcuaHMnKSB9LFxyXG4gICAgICAgIChlcnIsIGluZm8yKSA9PiB7XHJcbiAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIHJlamVjdChlcnIpXHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXNvbHZlKGluZm8yKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pKVxyXG4gIHJldHVybiBuZXcgUHJvbWlzZTxUPigocmVzb2x2ZSwgcmVqZWN0KSA9PlxyXG4gICAgRlMud3JpdGUoaW5mby5mZCwgY29udGVudHMsIGFzeW5jIChlcnIpID0+IHtcclxuICAgICAgaWYgKGVycikge1xyXG4gICAgICAgIHJlamVjdChlcnIpXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzb2x2ZShhd2FpdCBnZW4oaW5mby5wYXRoKSlcclxuICAgICAgICBGUy5jbG9zZShpbmZvLmZkLCAoKSA9PiBGUy51bmxpbmsoaW5mby5wYXRoLCAoKSA9PiB7IC8qbm9vcCovIH0pKVxyXG4gICAgICB9XHJcbiAgICB9KSlcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgS25vd25FcnJvck5hbWUgPVxyXG4gICdHSENNb2RTdGRvdXRFcnJvcidcclxuICB8ICdJbnRlcmFjdGl2ZUFjdGlvblRpbWVvdXQnXHJcbiAgfCAnR0hDTW9kSW50ZXJhY3RpdmVDcmFzaCdcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBta0Vycm9yKG5hbWU6IEtub3duRXJyb3JOYW1lLCBtZXNzYWdlOiBzdHJpbmcpIHtcclxuICBjb25zdCBlcnIgPSBuZXcgRXJyb3IobWVzc2FnZSlcclxuICBlcnIubmFtZSA9IG5hbWVcclxuICByZXR1cm4gZXJyXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2FuZGJveENvbmZpZ1RyZWUgeyBbazogc3RyaW5nXTogU2FuZGJveENvbmZpZ1RyZWUgfCBzdHJpbmcgfVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHBhcnNlU2FuZGJveENvbmZpZyhmaWxlOiBzdHJpbmcpIHtcclxuICB0cnkge1xyXG4gICAgY29uc3Qgc2JjID0gYXdhaXQgbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PlxyXG4gICAgICBGUy5yZWFkRmlsZShmaWxlLCB7IGVuY29kaW5nOiAndXRmLTgnIH0sIChlcnIsIHNiYzIpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICByZWplY3QoZXJyKVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXNvbHZlKHNiYzIpXHJcbiAgICAgICAgfVxyXG4gICAgICB9KSlcclxuICAgIGNvbnN0IHZhcnM6IFNhbmRib3hDb25maWdUcmVlID0ge31cclxuICAgIGxldCBzY29wZSA9IHZhcnNcclxuICAgIGNvbnN0IHJ2ID0gKHY6IHN0cmluZykgPT4ge1xyXG4gICAgICBmb3IgKGNvbnN0IGsxIG9mIE9iamVjdC5rZXlzKHNjb3BlKSkge1xyXG4gICAgICAgIGNvbnN0IHYxID0gc2NvcGVbazFdXHJcbiAgICAgICAgaWYgKHR5cGVvZiB2MSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgIHYgPSB2LnNwbGl0KGAkJHtrMX1gKS5qb2luKHYxKVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdlxyXG4gICAgfVxyXG4gICAgZm9yIChjb25zdCBsaW5lIG9mIHNiYy5zcGxpdCgvXFxyP1xcbnxcXHIvKSkge1xyXG4gICAgICBpZiAoIWxpbmUubWF0Y2goL15cXHMqLS0vKSAmJiAhbGluZS5tYXRjaCgvXlxccyokLykpIHtcclxuICAgICAgICBjb25zdCBbbF0gPSBsaW5lLnNwbGl0KC8tLS8pXHJcbiAgICAgICAgY29uc3QgbSA9IGwubWF0Y2goL15cXHMqKFtcXHctXSspOlxccyooLiopXFxzKiQvKVxyXG4gICAgICAgIGlmIChtKSB7XHJcbiAgICAgICAgICBjb25zdCBbLCBuYW1lLCB2YWxdID0gbVxyXG4gICAgICAgICAgc2NvcGVbbmFtZV0gPSBydih2YWwpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnN0IG5ld3Njb3BlID0ge31cclxuICAgICAgICAgIHNjb3BlW2xpbmVdID0gbmV3c2NvcGVcclxuICAgICAgICAgIHNjb3BlID0gbmV3c2NvcGVcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB2YXJzXHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICB3YXJuKCdSZWFkaW5nIGNhYmFsIHNhbmRib3ggY29uZmlnIGZhaWxlZCB3aXRoICcsIGVycilcclxuICAgIHJldHVybiB1bmRlZmluZWRcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1VwcGVyQ2FzZShjaDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgcmV0dXJuIGNoLnRvVXBwZXJDYXNlKCkgPT09IGNoXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRFcnJvckRldGFpbCh7IGVyciwgcnVuQXJncyB9OiBJRXJyb3JDYWxsYmFja0FyZ3MpIHtcclxuICByZXR1cm4gYEFyZ3M6XHJcbiR7SlNPTi5zdHJpbmdpZnkocnVuQXJncywgdW5kZWZpbmVkLCAyKX1cclxubWVzc2FnZTpcclxuJHtlcnIubWVzc2FnZX1cclxubG9nOlxyXG4ke2dldERlYnVnTG9nKCl9YFxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0RXJyb3IoeyBlcnIsIHJ1bkFyZ3MgfTogSUVycm9yQ2FsbGJhY2tBcmdzKSB7XHJcbiAgaWYgKGVyci5uYW1lID09PSAnSW50ZXJhY3RpdmVBY3Rpb25UaW1lb3V0JyAmJiBydW5BcmdzKSB7XHJcbiAgICByZXR1cm4gYFxcXHJcbkhhc2tlbGwtZ2hjLW1vZDogZ2hjLW1vZCBcXFxyXG4ke3J1bkFyZ3MuaW50ZXJhY3RpdmUgPyAnaW50ZXJhY3RpdmUgJyA6ICcnfWNvbW1hbmQgJHtydW5BcmdzLmNvbW1hbmR9IFxcXHJcbnRpbWVkIG91dC4gWW91IGNhbiB0cnkgdG8gZml4IGl0IGJ5IHJhaXNpbmcgJ0ludGVyYWN0aXZlIEFjdGlvbiBcXFxyXG5UaW1lb3V0JyBzZXR0aW5nIGluIGF0b20taGFza2VsbC1oc2RldiBzZXR0aW5ncy5gXHJcbiAgfSBlbHNlIGlmIChydW5BcmdzKSB7XHJcbiAgICByZXR1cm4gYFxcXHJcbkhhc2tlbGwtZ2hjLW1vZDogZ2hjLW1vZCBcXFxyXG4ke3J1bkFyZ3MuaW50ZXJhY3RpdmUgPyAnaW50ZXJhY3RpdmUgJyA6ICcnfWNvbW1hbmQgJHtydW5BcmdzLmNvbW1hbmR9IFxcXHJcbmZhaWxlZCB3aXRoIGVycm9yICR7ZXJyLm5hbWV9YFxyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gYFRoZXJlIHdhcyBhbiB1bmV4cGVjdGVkIGVycm9yICR7ZXJyLm5hbWV9YFxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGRlZmF1bHRFcnJvckhhbmRsZXIoYXJnczogSUVycm9yQ2FsbGJhY2tBcmdzKSB7XHJcbiAgY29uc3QgeyBlcnIsIHJ1bkFyZ3MgfSA9IGFyZ3NcclxuICBjb25zdCBzdXBwcmVzc0Vycm9ycyA9IHJ1bkFyZ3MgJiYgcnVuQXJncy5zdXBwcmVzc0Vycm9yc1xyXG5cclxuICBpZiAoIXN1cHByZXNzRXJyb3JzKSB7XHJcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXHJcbiAgICAgIGZvcm1hdEVycm9yKGFyZ3MpLFxyXG4gICAgICB7XHJcbiAgICAgICAgZGV0YWlsOiBnZXRFcnJvckRldGFpbChhcmdzKSxcclxuICAgICAgICBzdGFjazogZXJyLnN0YWNrLFxyXG4gICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxyXG4gICAgICB9LFxyXG4gICAgKVxyXG4gIH0gZWxzZSB7XHJcbiAgICBlcnJvcihydW5BcmdzLCBlcnIpXHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gd2FybkdIQ1BhY2thZ2VQYXRoKCkge1xyXG4gIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKFxyXG4gICAgJ2F0b20taGFza2VsbC1oc2RldjogWW91IGhhdmUgR0hDX1BBQ0tBR0VfUEFUSCBlbnZpcm9ubWVudCB2YXJpYWJsZSBzZXQhJyxcclxuICAgIHtcclxuICAgICAgZGlzbWlzc2FibGU6IHRydWUsXHJcbiAgICAgIGRldGFpbDogYFxcXHJcblRoaXMgY29uZmlndXJhdGlvbiBpcyBub3Qgc3VwcG9ydGVkLCBhbmQgY2FuIGJyZWFrIGFyYml0cmFyaWx5LiBZb3UgY2FuIHRyeSB0byBiYW5kLWFpZCBpdCBieSBhZGRpbmdcclxuXHJcbmRlbGV0ZSBwcm9jZXNzLmVudi5HSENfUEFDS0FHRV9QQVRIXHJcblxyXG50byB5b3VyIEF0b20gaW5pdCBzY3JpcHQgKEVkaXQg4oaSIEluaXQgU2NyaXB0Li4uKVxyXG5cclxuWW91IGNhbiBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gYXRvbS1oYXNrZWxsLWhzZGV2IHNldHRpbmdzLmAsXHJcbiAgICB9LFxyXG4gIClcclxufVxyXG5cclxuZnVuY3Rpb24gZmlsdGVyRW52KGVudjogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nIHwgdW5kZWZpbmVkIH0pIHtcclxuICBjb25zdCBmZW52ID0ge31cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGZvcmluXHJcbiAgZm9yIChjb25zdCBldmFyIGluIGVudikge1xyXG4gICAgY29uc3QgZXZhclUgPSBldmFyLnRvVXBwZXJDYXNlKClcclxuICAgIGlmIChcclxuICAgICAgZXZhclUgPT09ICdQQVRIJ1xyXG4gICAgICB8fCBldmFyVS5zdGFydHNXaXRoKCdHSENfJylcclxuICAgICAgfHwgZXZhclUuc3RhcnRzV2l0aCgnU1RBQ0tfJylcclxuICAgICAgfHwgZXZhclUuc3RhcnRzV2l0aCgnQ0FCQUxfJylcclxuICAgICkge1xyXG4gICAgICBmZW52W2V2YXJdID0gZW52W2V2YXJdXHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBmZW52XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU3Bhd25GYWlsQXJncyB7XHJcbiAgZXJyOiBFcnJvciAmIHtjb2RlPzogYW55fVxyXG4gIG9wdHM/OiBSdW5PcHRpb25zXHJcbiAgdmVycz86IEhzRGV2VmVyc2lvblxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbm90aWZ5U3Bhd25GYWlsKGFyZ3M6IFJlYWRvbmx5PFNwYXduRmFpbEFyZ3M+KSB7XHJcbiAgY29uc3QgZGVidWdJbmZvOiBTcGF3bkZhaWxBcmdzID0gT2JqZWN0LmFzc2lnbih7fSwgYXJncylcclxuICBpZiAoYXJncy5vcHRzKSB7XHJcbiAgICBjb25zdCBvcHRzY2xvbmU6IFJ1bk9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBhcmdzLm9wdHMpXHJcbiAgICBkZWJ1Z0luZm8ub3B0cyA9IG9wdHNjbG9uZVxyXG4gIH1cclxuICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRmF0YWxFcnJvcihcclxuICAgIGBIYXNrZWxsLWdoYy1tb2Q6IGdoYy1tb2QgZmFpbGVkIHRvIGxhdW5jaC5cclxuSXQgaXMgcHJvYmFibHkgbWlzc2luZyBvciBtaXNjb25maWd1cmVkLiAke2FyZ3MuZXJyLmNvZGV9YCxcclxuICAgIHtcclxuICAgICAgZGV0YWlsOiBgXFxcclxuRXJyb3Igd2FzOiAke2RlYnVnSW5mby5lcnIubmFtZX1cclxuJHtkZWJ1Z0luZm8uZXJyLm1lc3NhZ2V9XHJcbkRlYnVnIGluZm9ybWF0aW9uOlxyXG4ke0pTT04uc3RyaW5naWZ5KGRlYnVnSW5mbywgdW5kZWZpbmVkLCAyKX1cclxuQ29uZmlnOlxyXG4ke0pTT04uc3RyaW5naWZ5KGF0b20uY29uZmlnLmdldCgnYXRvbS1oYXNrZWxsLWhzZGV2JyksdW5kZWZpbmVkLDIpfVxyXG5gLFxyXG4gICAgICBzdGFjazogZGVidWdJbmZvLmVyci5zdGFjayxcclxuICAgICAgZGlzbWlzc2FibGU6IHRydWUsXHJcbiAgICB9LFxyXG4gIClcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZUV4Y2VwdGlvbjxUPihcclxuICBfdGFyZ2V0OiB7IHVwaTogVVBJLklVUElJbnN0YW5jZSB8IFByb21pc2U8VVBJLklVUElJbnN0YW5jZT4gfSwgX2tleTogc3RyaW5nLFxyXG4gIGRlc2M6IFR5cGVkUHJvcGVydHlEZXNjcmlwdG9yPCguLi5hcmdzOiBhbnlbXSkgPT4gUHJvbWlzZTxUPj4sXHJcbik6IFR5cGVkUHJvcGVydHlEZXNjcmlwdG9yPCguLi5hcmdzOiBhbnlbXSkgPT4gUHJvbWlzZTxUPj4ge1xyXG4gIHJldHVybiB7XHJcbiAgICAuLi5kZXNjLFxyXG4gICAgYXN5bmMgdmFsdWUoLi4uYXJnczogYW55W10pIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLW5vbi1udWxsLWFzc2VydGlvbiBuby11bnNhZmUtYW55XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IGRlc2MudmFsdWUhLmNhbGwodGhpcywgLi4uYXJncylcclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGRlYnVnKGUpXHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby11bnNhZmUtYW55XHJcbiAgICAgICAgY29uc3QgdXBpOiBVUEkuSVVQSUluc3RhbmNlID0gYXdhaXQgKHRoaXMgYXMgYW55KS51cGlcclxuICAgICAgICB1cGkuc2V0U3RhdHVzKHtcclxuICAgICAgICAgIHN0YXR1czogJ3dhcm5pbmcnLFxyXG4gICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby11bnNhZmUtYW55XHJcbiAgICAgICAgICBkZXRhaWw6IGUudG9TdHJpbmcoKSxcclxuICAgICAgICB9KVxyXG4gICAgICAgIC8vIFRPRE86IHJldHVybmluZyBhIHByb21pc2UgdGhhdCBuZXZlciByZXNvbHZlcy4uLiB1Z2x5LCBidXQgd29ya3M/XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCgpID0+IHsgLyogbm9vcCAqLyB9KVxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHZlcnNBdExlYXN0KHZlcnM6IHsgW2tleTogbnVtYmVyXTogbnVtYmVyIHwgdW5kZWZpbmVkIH0sIGI6IG51bWJlcltdKSB7XHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBiLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBjb25zdCB2ID0gYltpXVxyXG4gICAgY29uc3QgdCA9IHZlcnNbaV1cclxuICAgIGNvbnN0IHZ2ID0gdCAhPT0gdW5kZWZpbmVkID8gdCA6IDBcclxuICAgIGlmICh2diA+IHYpIHtcclxuICAgICAgcmV0dXJuIHRydWVcclxuICAgIH0gZWxzZSBpZiAodnYgPCB2KSB7XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gdHJ1ZVxyXG59XHJcbiJdfQ==